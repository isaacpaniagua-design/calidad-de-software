rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // =============================================
    // Función de Ayuda para verificar roles
    // =============================================
    function getUserRole() {
      // Obtiene el 'claim' personalizado 'role' del token de autenticación del usuario.
      return request.auth.token.role;
    }

    // =============================================
    // Colección de Estudiantes (Roster)
    // =============================================
    match /students/{studentId} {
      // LECTURA: Solo los docentes pueden leer la lista completa de estudiantes.
      allow read: if getUserRole() == 'docente';
      
      // ESCRITURA: Deshabilitada para los clientes. La lista se gestiona desde un panel de admin.
      allow write: if false; 
    }

    // =============================================
    // Colección de Calificaciones
    // =============================================
    match /courses/{courseId}/grades/{studentId} {
      // LECTURA: Docentes leen todo. Estudiantes solo lo suyo.
      allow read: if getUserRole() == 'docente' || request.auth.uid == studentId;

      // ESCRITURA: Solo los docentes pueden crear o modificar calificaciones.
      allow write: if getUserRole() == 'docente';
    }
    
    // =============================================
    // Colección de Evidencias (Entregas)
    // =============================================
    match /courses/{courseId}/submissions/{studentId}/activities/{activityId} {
      // LECTURA: Docentes leen todo. Estudiantes solo lo suyo.
      allow read: if getUserRole() == 'docente' || request.auth.uid == studentId;
      
      // ESCRITURA: Docentes y estudiantes (solo en su propia entrega).
      allow write: if getUserRole() == 'docente' || request.auth.uid == studentId;
    }
  }
}
