rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // --- Helper Functions ---
    // Checks if the requesting user's UID is listed in the 'teachers' collection.
    // This is the primary way we identify a teacher.
    function isTeacher() {
      return exists(/databases/$(database)/documents/teachers/$(request.auth.uid));
    }

    // --- Core Collections ---

    // Activities: The master list of all assignments.
    match /activities/{activityId} {
      // Allow any authenticated user (student or teacher) to read the activity list.
      allow read: if request.auth != null;
      // Only allow teachers to create, change, or delete activities.
      allow write: if isTeacher();
    }
    
    // Submissions: Contains each student's work and grades for each activity.
    match /submissions/{submissionId} {
      // A user can read a submission if:
      // 1. They are a teacher (can read all submissions).
      // OR
      // 2. The 'studentUid' field in the submission matches their own UID.
      allow read: if isTeacher() || request.auth.uid == resource.data.studentUid;

      // A user can write to a submission if:
      // 1. They are a teacher (for grading).
      // OR
      // 2. They are the student who owns the submission (for submitting files).
      allow write: if isTeacher() || request.auth.uid == resource.data.studentUid;
    }

    // --- Administrative & User Data Collections ---

    // Students: The list of all students in the course.
    match /students/{studentId} {
      // Allow teachers to read the full student list.
      // A student can read their own document.
      allow read: if isTeacher() || request.auth.uid == resource.data.authUid;
      // Writing is restricted to teachers.
      allow write: if isTeacher();
    }
    
    // Teachers: The authoritative list of users with teacher privileges.
    match /teachers/{teacherId} {
      // Only other teachers can see who is a teacher.
      allow read: if isTeacher();
      // Writing to this collection should be done manually in the Firebase Console
      // or by a super-admin role (not implemented here for security).
      allow write: if false;
    }
    
    // Grades: This appears to be part of a separate data model.
    // The rules below are preserved for that model's functionality.
    match /grades/{gradeId} {
      allow read: if isTeacher() || request.auth.uid == resource.data.authUid;
      allow write: if isTeacher();
      
      match /activities/{activityId} {
         allow read: if isTeacher() || request.auth.uid == resource.data.authUid;
         allow write: if isTeacher();
      }
    }
  }
}
