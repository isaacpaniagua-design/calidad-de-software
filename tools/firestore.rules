rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Función para verificar si un usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Función para obtener el rol del usuario desde los Custom Claims
    function getUserRole() {
      return request.auth.token.role;
    }

    // --- REGLAS PRINCIPALES ---

    // Colección de Estudiantes
    match /students/{studentId} {
      allow read: if getUserRole() == 'docente';
      allow write: if false; // Proteger la lista de estudiantes
    }

    // Calificaciones
    match /courses/{courseId}/grades/{studentId} {
      allow read: if getUserRole() == 'docente' || request.auth.uid == studentId;
      allow write: if getUserRole() == 'docente';
    }
    
    // Entregas de Evidencias (Submissions)
    match /courses/{courseId}/submissions/{studentId}/{document=**} {
       allow read, write: if getUserRole() == 'docente' || request.auth.uid == studentId;
    }

    // --- REGLAS ADICIONALES PARA EVITAR ERRORES EN OTRAS PÁGINAS ---
    
    // Temas del Foro
    match /forum_topics/{topicId}/{document=**} {
      // Permite a cualquier usuario autenticado leer y escribir en el foro
      allow read, write: if isAuthenticated();
    }
    
    // Lista de profesores (usada en el panel de docente)
    match /teacher_allowlist/{docId} {
       allow read: if isAuthenticated();
    }
  }
}
