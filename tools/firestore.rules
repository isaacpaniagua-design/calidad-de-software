rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funciones de Ayuda (sin cambios) ---
    function isAuthenticated() {
      return request.auth != null;
    }
    function isTeacher() {
      return isAuthenticated() && exists(/databases/$(database)/documents/teachers/$(request.auth.uid));
    }

    // --- Reglas por Colección ---

    // =================================================================
    // Asistencia
    // =================================================================
    match /asistencia/{asistenciaId} {
      // Cualquier usuario autenticado puede leer la lista de asistencia.
      allow read: if isAuthenticated();
      // Cualquier usuario autenticado puede crear un registro de asistencia.
      allow create: if isAuthenticated();
      // Solo los docentes pueden modificar o borrar registros.
      allow update, delete: if isTeacher();
    }

    // Colección de Estudiantes
    match /students/{studentId} {
      // CORRECCIÓN: Se cambia 'read' por 'get' para ser más específico. Un estudiante solo puede
      // obtener su propio documento si conoce el ID.
      allow get: if isTeacher() || (isAuthenticated() && resource.data.authUid == request.auth.uid);

      // CORRECCIÓN: Se añade la regla 'list'. Esto es CRUCIAL para que la consulta
      // findStudentByUid() funcione. Permite a cualquier usuario autenticado realizar una consulta
      // en la colección 'students'. Tu frontend DEBE asegurar que la consulta solo pida
      // los datos del propio usuario (ej. ...where('authUid', '==', currentUser.uid)).
      allow list: if isTeacher() || isAuthenticated();

      allow write: if isTeacher(); // Permitir a los docentes editar/crear estudiantes
    }

    // Calificaciones (Colección a nivel raíz)
    match /grades/{studentId} {
      // Un estudiante puede leer su propio documento de calificaciones si su UID o email coinciden.
      // Esta regla permite las consultas 'where("authUid", "==", ...)' y 'where("email", "==", ...)'
      // que se usan en `subscribeMyGrades` y `subscribeMyActivities`.
      allow read: if isTeacher() || (isAuthenticated() && (resource.data.authUid == request.auth.uid || resource.data.email == request.auth.token.email));

      // Permite a los docentes listar todos los documentos.
      // Esta regla es necesaria para que los docentes vean la lista completa de calificaciones.
      allow list: if isTeacher();
      
      // Un estudiante puede obtener su documento de calificaciones si su UID coincide.
      allow get: if isTeacher() || (isAuthenticated() && resource.data.authUid == request.auth.uid);

      // Solo los docentes pueden crear o eliminar. Un estudiante puede actualizar su propio
      // documento de calificaciones, pero solo para añadir su `authUid` si no existe.
      // Esto es clave para el mecanismo de auto-reparación al iniciar sesión.
      allow create, delete: if isTeacher();
      allow update: if isTeacher() || 
                       (isAuthenticated() && 
                         resource.data.email == request.auth.token.email &&
                         request.resource.data.authUid == request.auth.uid &&
                         !('authUid' in resource.data));

      // Subcolección: activities
      // Contiene las actividades individuales de cada estudiante.
      match /activities/{activityId} {
        // Un estudiante puede leer sus propias actividades.
        // La condición verifica que el 'authUid' del documento de calificaciones padre coincida con el del solicitante.
        allow read: if isTeacher() || (isAuthenticated() && get(/databases/$(database)/documents/grades/$(studentId)).data.authUid == request.auth.uid);
        
        // Solo los docentes pueden escribir en las actividades.
        allow write: if isTeacher();
      }
    }

    // Regla para la consulta de grupo de colección 'activities'
    match /{path=**}/activities/{activityId} {
      // Permite a un docente autenticado ejecutar una consulta de grupo de colección
      // en todas las subcolecciones de 'activities'.
      allow read: if isTeacher();
    }

    // Entregas de los estudiantes
    match /studentUploads/{uploadId} {
      // CORRECCIÓN: Se combinan 'get' y 'create'/'update' en reglas de 'read' y 'write'
      // para mayor claridad y para permitir consultas (onSnapshot) en las entregas.
      // Esto soluciona el error 'observeStudentUploads:permission-denied'.

      // El docente puede leer todo. El estudiante puede leer solo sus propias entregas.
      allow read: if isTeacher() || (isAuthenticated() && request.auth.uid == resource.data.student.uid);

      // El docente puede escribir en cualquier documento.
      // El estudiante solo puede crear, actualizar o borrar sus propias entregas.
      allow write: if isTeacher() || (isAuthenticated() && request.auth.uid == request.resource.data.student.uid);
    }

    // --- OTRAS COLECCIONES (revisadas para consistencia) ---

    // Colección de Profesores
    match /teachers/{teacherId} {
      allow read: if isTeacher();
      allow write: if false; // Correcto: Proteger escritura.
    }

    // Materiales de clase
    match /materials/{materialId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher();
    }

    // Foro: Temas y Respuestas
    match /forum_topics/{topicId} {
      allow read, write: if isAuthenticated();
      match /replies/{replyId} {
        allow read, write: if isAuthenticated();
      }
    }

    // Asistencias
    match /attendances/{attendanceId} {
      allow read: if isAuthenticated();
      allow create: if (isAuthenticated() && request.auth.uid == request.resource.data.createdByUid) || isTeacher();
    }

    // Planes de Prueba
    match /planesDePrueba/{planId} {
      allow read, write: if isTeacher();
    }

    // Cursos y Grupos
    match /courses/{courseId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher();
    }
    match /grupos/{grupoId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher();
      // Permitir a los docentes leer y escribir en la lista de miembros de un grupo.
      match /members/{memberId} {
        allow list, read: if isTeacher();
        allow write: if isTeacher();
      }
    }
  }
}
