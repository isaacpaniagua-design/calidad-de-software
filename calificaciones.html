﻿<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Gestión de Calificaciones - Calidad de Software</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .card-shadow {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }
      .progress-bar {
        transition: width 0.3s ease-in-out;
      }
    </style>
    <style id="qs-calificaciones-css">
      /* Ocultar por completo la vista de resumen de calificaciones (qsc-wrap).
         Esta sección mostraba una tabla con el progreso del alumno y un conjunto
         de indicadores KPI.  El docente solicitó que ya no se muestre ni para
         docentes ni para estudiantes, por lo que se fuerza su estilo a
         `display:none`.  Mantenemos el resto de reglas intactas para evitar
         desbordes de otras clases. */
      #calificaciones-root .qsc-wrap {
        display: none !important;
        max-width: 1100px;
        margin: 24px auto;
        padding: 0 16px;
      }
      #calificaciones-root .qsc-title {
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0 0 12px;
      }
      #calificaciones-root .qsc-kpis {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }
      #calificaciones-root .qsc-kpi {
        min-width: 140px;
        padding: 10px 12px;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.05);
        text-align: center;
      }
      #calificaciones-root .qsc-kpi span {
        display: block;
        font-weight: 700;
        font-size: 1.1rem;
      }
      #calificaciones-root .qsc-kpi small {
        display: block;
        opacity: 0.75;
      }
      #calificaciones-root .qsc-bar {
        height: 10px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }
      #calificaciones-root .qsc-bar-fill {
        height: 100%;
        background: var(--primary, #667eea);
        width: 0%;
        transition: width 0.4s ease;
      }
      #calificaciones-root .qsc-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 14px;
        background: rgba(255, 255, 255, 0.85);
      }
      #calificaciones-root .qsc-table th {
        padding: 10px;
        text-align: left;
        border-bottom: 2px solid rgba(0, 0, 0, 0.1);
        white-space: nowrap;
        font-weight: 700;
      }
      #calificaciones-root .qsc-table td {
        padding: 10px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      }

      /* Ocultar la vista de alumno (student-preview) por defecto. Se mostrará cuando el docente pulse el botón "Vista de alumno". */
      #student-preview {
        display: none;
      }

      /* Ocultar el botón "Vista de alumno" completamente.
         Este botón permitía al docente previsualizar la interfaz de alumno.  A solicitud del
         usuario se elimina para todos los roles, por lo que se aplica un estilo
         forzado que lo oculta de la página. */
      #viewStudentPreviewBtn {
        display: none !important;
      }
      #calificaciones-root .qsc-msg {
        margin-top: 8px;
        opacity: 0.85;
        font-size: 0.9rem;
      }
      #calificaciones-root .qsc-muted {
        opacity: 0.7;
      }

    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div id="calificaciones-root"></div>
    <script type="module" src="js/calificaciones-backend.js"></script>

    <!-- Header -->
    <div class="gradient-bg text-white py-8">
      <div class="container mx-auto px-6">
        <h1 class="text-3xl font-bold mb-2">
          Sistema de Gestión de Calificaciones
        </h1>
        <p class="text-blue-100">Calidad de Software - Gestión por Unidades</p>
      </div>
    </div>

    <div class="container mx-auto px-6 py-8">
      <!-- Student Info (visible sólo para docentes) -->
      <div class="bg-white rounded-lg card-shadow p-6 mb-8 teacher-only">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 items-end">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Seleccionar Estudiante</label
            >
            <select
              id="studentSelect"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">-- Seleccione un estudiante --</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Nombre Completo</label
            >
            <input
              type="text"
              id="studentName"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50"
              readonly
              placeholder="Nombre del estudiante"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Correo Electrónico</label
            >
            <input
              type="email"
              id="studentEmail"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50"
              readonly
              placeholder="Correo del estudiante"
            />
          </div>
        </div>
        <div class="mt-4">
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >Código del Estudiante</label
          >
          <input
            type="text"
            id="studentId"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50"
            readonly
            placeholder="Código del estudiante"
          />
        </div>
        <!-- Botón para mostrar la vista de alumno: cuando se pulsa, desplaza la página hacia la vista de estudiante (student-preview). -->
        <div class="mt-4">
          <button
            id="viewStudentPreviewBtn"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors"
            type="button"
          >
            Vista de alumno
          </button>
        </div>
      </div>

      <!-- Overall Progress -->
      <div class="bg-white rounded-lg card-shadow p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">
          Progreso General del Curso
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div class="text-center">
            <div class="text-3xl font-bold text-blue-600" id="finalGrade">
              0.0
            </div>
            <!-- Clarificación: se muestra el promedio final sobre 5 para evitar confusión con porcentajes -->
            <!-- Mostrar el progreso total en porcentaje del curso -->
            <div class="text-sm text-gray-600">Progreso total&nbsp;(%)</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-green-600" id="unit1Grade">
              0.0
            </div>
            <!-- Se añade aclaración de la ponderación de la unidad para mejorar la usabilidad -->
            <!-- Unidad I aporta el 30 % del curso -->
            <div class="text-sm text-gray-600">Unidad&nbsp;I – 30&nbsp;% del&nbsp;curso</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-yellow-600" id="unit2Grade">
              0.0
            </div>
            <!-- Unidad II aporta el 30 % del curso -->
            <div class="text-sm text-gray-600">Unidad&nbsp;II – 30&nbsp;% del&nbsp;curso</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-purple-600" id="unit3Grade">
              0.0
            </div>
            <!-- Unidad III aporta el 40 % del curso -->
            <div class="text-sm text-gray-600">Unidad&nbsp;III – 40&nbsp;% del&nbsp;curso</div>
          </div>
        </div>
        <div class="mt-6">
          <div class="flex justify-between text-sm text-gray-600 mb-2">
            <span>Progreso del Curso</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div
              class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full progress-bar"
              id="progressBar"
              style="width: 0%"
            ></div>
          </div>
        </div>
      </div>

      <!-- Units Tabs -->
      <div class="bg-white rounded-lg card-shadow overflow-hidden">
        <div class="flex border-b">
          <button
            class="tab-button flex-1 py-4 px-6 text-center font-medium transition-colors bg-blue-50 text-blue-600 border-b-2 border-blue-600"
            data-unit="1"
          >
            Unidad I - Fundamentos (30%)
          </button>
          <button
            class="tab-button flex-1 py-4 px-6 text-center font-medium transition-colors text-gray-600 hover:text-blue-600"
            data-unit="2"
          >
            Unidad II - Modelos (30%)
          </button>
          <button
            class="tab-button flex-1 py-4 px-6 text-center font-medium transition-colors text-gray-600 hover:text-blue-600"
            data-unit="3"
          >
            <!-- Actualizar la etiqueta para reflejar la ponderación de 40 % de la unidad III -->
            Unidad III - Certificación (40%)
          </button>
          <button
            class="tab-button flex-1 py-4 px-6 text-center font-medium transition-colors text-gray-600 hover:text-blue-600"
            data-unit="project"
          >
            📑 Rúbrica Proyecto Final
          </button>
        </div>

        <!-- Unit 1 Content -->
        <div class="unit-content p-6" id="unit1">
          <h3 class="text-xl font-semibold text-gray-800 mb-6">
            I. Fundamentos de Calidad de Software
          </h3>
          <div class="space-y-4">
            <div
              class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div class="flex-1">
                <h4 class="font-medium text-gray-800">
                  Foro: Ejemplo de Métricas
                </h4>
                <p class="text-sm text-gray-600">
                  Peso en unidad: 5% | Peso global: 1.5%
                </p>
              </div>
              <input
                type="number"
                class="grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                min="0"
                max="10"
                step="0.1"
                data-weight="1.5"
                placeholder="0.0"
              />
            </div>
            <div
              class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div class="flex-1">
                <h4 class="font-medium text-gray-800">
                  Taller de Complejidad Ciclomática
                </h4>
                <p class="text-sm text-gray-600">
                  Peso en unidad: 5% | Peso global: 1.5%
                </p>
              </div>
              <input
                type="number"
                class="grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                min="0"
                max="5"
                step="0.1"
                data-weight="1.5"
                placeholder="0.0"
              />
            </div>
            <div
              class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div class="flex-1">
                <h4 class="font-medium text-gray-800">
                  Plan de Pruebas (IEEE 829)
                </h4>
                <p class="text-sm text-gray-600">
                  <!-- Ajuste de ponderación: las asignaciones representan el 20 % de la unidad 1 en total,
                       por lo que cada una aporta el 10 % de la unidad (equivalente al 3 % global) -->
                  Peso en unidad: 10% | Peso global: 3%
                </p>
              </div>
              <input
                type="number"
                class="grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                min="0"
                max="5"
                step="0.1"
                data-weight="3"
                placeholder="0.0"
              />
            </div>
            <div
              class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div class="flex-1">
                <h4 class="font-medium text-gray-800">
                  Simulación de Revisión Técnica
                </h4>
                <p class="text-sm text-gray-600">
                  <!-- Ajuste de ponderación: las asignaciones ahora representan un 20% de la unidad 1 en total,
                       por lo que cada una aporta el 10% del 20% global -->
                  Peso en unidad: 10% | Peso global: 3%
                </p>
              </div>
              <input
                type="number"
                class="grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                min="0"
                max="5"
                step="0.1"
              data-weight="3"
                placeholder="0.0"
              />
            </div>
            <div
              class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div class="flex-1">
                <h4 class="font-medium text-gray-800">
                  Diseño de Casos de Prueba
                </h4>
                <p class="text-sm text-gray-600">
                  <!-- Ajuste de ponderación: las actividades en clase suman el 25 % de la unidad 1.
                       Esta actividad representa el 7.5 % de la unidad, equivalente al 2.25 % global -->
                  Peso en unidad: 7.5% | Peso global: 2.25%
                </p>
              </div>
              <input
                type="number"
                class="grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                min="0"
                max="5"
                step="0.1"
                data-weight="2.25"
                placeholder="0.0"
              />
            </div>
            <div
              class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div class="flex-1">
                <h4 class="font-medium text-gray-800">Foro de Seguridad</h4>
                <p class="text-sm text-gray-600">
                  <!-- Ajuste de ponderación: las actividades en clase suman el 25 % de la unidad 1.
                       Esta actividad representa el 7.5 % de la unidad, equivalente al 2.25 % global -->
                  Peso en unidad: 7.5% | Peso global: 2.25%
                </p>
              </div>
              <input
                type="number"
                class="grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                min="0"
                max="5"
                step="0.1"
                data-weight="2.25"
                placeholder="0.0"
              />
            </div>
            <!-- Participación en clase: 10% de la unidad, equivalente a 3% global -->
            <!-- Participación en clase: 10% de la unidad, equivalente a 3% global -->
            <div
              class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div class="flex-1">
                <h4 class="font-medium text-gray-800">Participación en Clase</h4>
                <p class="text-sm text-gray-600">
                  <!-- Participación agregada por defecto para unidad 1 -->
                  Peso en unidad: 10% | Peso global: 3%
                </p>
              </div>
              <input
                type="number"
                class="grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                min="0"
                max="5"
                step="0.1"
                data-weight="3"
                placeholder="0.0"
              />
            </div>

            <div
              class="grade-item flex items-center justify-between p-4 bg-blue-50 rounded-lg border-2 border-blue-200"
            >
              <div class="flex-1">
                <h4 class="font-medium text-blue-800">Examen Unidad I</h4>
                <p class="text-sm text-blue-600">
                  <!-- El examen de la unidad 1 representa el 45 % de la unidad,
                       equivalente al 13.5 % del total del curso -->
                  Peso en unidad: 45% | Peso global: 13.5%
                </p>
              </div>
              <input
                type="number"
                class="grade-input w-20 px-3 py-2 border border-blue-300 rounded-lg text-center"
                min="0"
                max="5"
                step="0.1"
                data-weight="13.5"
                placeholder="0.0"
              />
            </div>
          </div>
        </div>

        <!-- Unit 2 Content -->
        <div class="unit-content p-6 hidden" id="unit2">
          <h3 class="text-xl font-semibold text-gray-800 mb-6">
            II. Modelos y Estándares de Calidad
          </h3>
          <div class="space-y-4">
            <div
              class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div class="flex-1">
                <h4 class="font-medium text-gray-800">
                  Role-Playing de Auditoría
                </h4>
                <p class="text-sm text-gray-600">
                  <!-- Ajuste de ponderación: las actividades en clase de la unidad 2 suman 25 % en total.
                       Esta actividad aporta el 12.5 % de la unidad, equivalente al 3.75 % global -->
                  Peso en unidad: 12.5% | Peso global: 3.75%
                </p>
              </div>
              <input
                type="number"
                class="grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                min="0"
                max="5"
                step="0.1"
              data-weight="3.75"
                placeholder="0.0"
              />
            </div>
            <div
              class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div class="flex-1">
                <h4 class="font-medium text-gray-800">
                  Informe Comparativo de Modelos
                </h4>
                <p class="text-sm text-gray-600">
                  <!-- Ajuste de ponderación: la asignación principal de la unidad 2 representa el 20 % de la unidad,
                       equivalente al 6 % del total del curso -->
                  Peso en unidad: 20% | Peso global: 6%
                </p>
              </div>
              <input
                type="number"
                class="grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                min="0"
                max="5"
                step="0.1"
              data-weight="6"
                placeholder="0.0"
              />
            </div>
            <div
              class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div class="flex-1">
                <h4 class="font-medium text-gray-800">
                  Mapa Conceptual Colaborativo
                </h4>
                <p class="text-sm text-gray-600">
                  <!-- Ajuste de ponderación: las actividades en clase de la unidad 2 suman 25 % en total.
                       Esta actividad aporta el 12.5 % de la unidad, equivalente al 3.75 % global -->
                  Peso en unidad: 12.5% | Peso global: 3.75%
                </p>
              </div>
              <input
                type="number"
                class="grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                min="0"
                max="5"
                step="0.1"
              data-weight="3.75"
                placeholder="0.0"
              />
            </div>
            <!-- Participación en clase: 10% de la unidad 2, equivalente a 3% global -->
            <div
              class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div class="flex-1">
                <h4 class="font-medium text-gray-800">Participación en Clase</h4>
                <p class="text-sm text-gray-600">
                  <!-- Participación agregada por defecto para unidad 2 -->
                  Peso en unidad: 10% | Peso global: 3%
                </p>
              </div>
              <input
                type="number"
                class="grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                min="0"
                max="5"
                step="0.1"
                data-weight="3"
                placeholder="0.0"
              />
            </div>

            <div
              class="grade-item flex items-center justify-between p-4 bg-yellow-50 rounded-lg border-2 border-yellow-200"
            >
              <div class="flex-1">
                <h4 class="font-medium text-yellow-800">Examen Unidad II</h4>
                <p class="text-sm text-yellow-600">
                  <!-- El examen de la unidad 2 representa el 45 % de la unidad,
                       equivalente al 13.5 % del total del curso -->
                  Peso en unidad: 45% | Peso global: 13.5%
                </p>
              </div>
              <input
                type="number"
                class="grade-input w-20 px-3 py-2 border border-yellow-300 rounded-lg text-center"
                min="0"
                max="5"
                step="0.1"
              data-weight="13.5"
                placeholder="0.0"
              />
            </div>
          </div>
        </div>

        <!-- Unit 3 Content -->
        <div class="unit-content p-6 hidden" id="unit3">
          <h3 class="text-xl font-semibold text-gray-800 mb-6">
            III. Plan de Certificación de Calidad
          </h3>
          <div class="space-y-4">
            <div
              class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div class="flex-1">
                <h4 class="font-medium text-gray-800">
                  Proyecto Final – Fase 1 (Diagnóstico)
                </h4>
                <p class="text-sm text-gray-600">
                  Peso en unidad: 10% | Peso global: 4%
                </p>
              </div>
              <input
                type="number"
                class="grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                min="0"
                max="5"
                step="0.1"
                data-weight="4"
                placeholder="0.0"
              />
            </div>
            <div
              class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div class="flex-1">
                <h4 class="font-medium text-gray-800">
                  Proyecto Final – Fase 2 (Gap Analysis)
                </h4>
                <p class="text-sm text-gray-600">
                  Peso en unidad: 15% | Peso global: 6%
                </p>
              </div>
              <input
                type="number"
                class="grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                min="0"
                max="5"
                step="0.1"
                data-weight="6"
                placeholder="0.0"
              />
            </div>
            <div
              class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div class="flex-1">
                <h4 class="font-medium text-gray-800">
                  Proyecto Final – Fases 3 y 4 (Roadmap y Gestión de Cambio)
                </h4>
                <p class="text-sm text-gray-600">
                  Peso en unidad: 15% | Peso global: 6%
                </p>
              </div>
              <input
                type="number"
                class="grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                min="0"
                max="5"
                step="0.1"
                data-weight="6"
                placeholder="0.0"
              />
            </div>
            <div
              class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div class="flex-1">
                <h4 class="font-medium text-gray-800">
                  Presentación del Proyecto Final
                </h4>
                <p class="text-sm text-gray-600">
                  Peso en unidad: 20% | Peso global: 8%
                </p>
              </div>
              <input
                type="number"
                class="grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                min="0"
                max="5"
                step="0.1"
                data-weight="8"
                placeholder="0.0"
              />
            </div>
            <div
              class="grade-item flex items-center justify-between p-4 bg-purple-50 rounded-lg border-2 border-purple-200"
            >
              <div class="flex-1">
                <h4 class="font-medium text-purple-800">
                  Examen Final Integrador
                </h4>
                <p class="text-sm text-purple-600">
                  Peso en unidad: 40% | Peso global: 16%
                </p>
              </div>
              <input
                type="number"
                class="grade-input w-20 px-3 py-2 border border-purple-300 rounded-lg text-center"
                min="0"
                max="5"
                step="0.1"
                data-weight="16"
                placeholder="0.0"
              />
            </div>
          </div>
        </div>

          <!-- Project Rubric Content -->
        <div class="unit-content p-6 hidden" id="project">
          <h3 class="text-xl font-semibold text-gray-800 mb-6">
            📑 Rúbrica del Proyecto Final – Plan de Certificación de Calidad
          </h3>

          <!-- Fase 1: Diagnóstico -->
          <div class="mb-8">
            <h4
              class="text-lg font-semibold text-purple-800 mb-4 bg-purple-50 p-3 rounded-lg"
            >
              Fase 1: Diagnóstico y Selección del Modelo (4% del curso)
            </h4>
            <div class="space-y-3">
              <div
                class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
              >
                <div class="flex-1">
                  <h5 class="font-medium text-gray-800">
                    Claridad y completitud del diagnóstico
                  </h5>
                  <p class="text-sm text-gray-600">
                    Peso en fase: 40% | Peso en unidad: 4% | Peso global: 1.6%
                  </p>
                </div>
                <input
                  type="number"
                  class="project-grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                  min="0"
                  max="5"
                  step="0.1"
                  data-weight="1.6"
                  placeholder="0.0"
                />
              </div>
              <div
                class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
              >
                <div class="flex-1">
                  <h5 class="font-medium text-gray-800">
                    Justificación de la selección del modelo
                  </h5>
                  <p class="text-sm text-gray-600">
                    Peso en fase: 40% | Peso en unidad: 4% | Peso global: 1.6%
                  </p>
                </div>
                <input
                  type="number"
                  class="project-grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                  min="0"
                  max="5"
                  step="0.1"
                  data-weight="1.6"
                  placeholder="0.0"
                />
              </div>
              <div
                class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
              >
                <div class="flex-1">
                  <h5 class="font-medium text-gray-800">
                    Presentación y formato
                  </h5>
                  <p class="text-sm text-gray-600">
                    Peso en fase: 20% | Peso en unidad: 2% | Peso global: 0.8%
                  </p>
                </div>
                <input
                  type="number"
                  class="project-grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                  min="0"
                  max="5"
                  step="0.1"
                  data-weight="0.8"
                  placeholder="0.0"
                />
              </div>
            </div>
          </div>

          <!-- Fase 2: Gap Analysis -->
          <div class="mb-8">
            <h4
              class="text-lg font-semibold text-blue-800 mb-4 bg-blue-50 p-3 rounded-lg"
            >
              Fase 2: Gap Analysis (6% del curso)
            </h4>
            <div class="space-y-3">
              <div
                class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
              >
                <div class="flex-1">
                  <h5 class="font-medium text-gray-800">
                    Identificación de brechas
                  </h5>
                  <p class="text-sm text-gray-600">
                    Peso en fase: 40% | Peso en unidad: 6% | Peso global: 2.4%
                  </p>
                </div>
                <input
                  type="number"
                  class="project-grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                  min="0"
                  max="5"
                  step="0.1"
                  data-weight="2.4"
                  placeholder="0.0"
                />
              </div>
              <div
                class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
              >
                <div class="flex-1">
                  <h5 class="font-medium text-gray-800">
                    Acciones recomendadas y priorización
                  </h5>
                  <p class="text-sm text-gray-600">
                    Peso en fase: 40% | Peso en unidad: 6% | Peso global: 2.4%
                  </p>
                </div>
                <input
                  type="number"
                  class="project-grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                  min="0"
                  max="5"
                  step="0.1"
                  data-weight="2.4"
                  placeholder="0.0"
                />
              </div>
              <div
                class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
              >
                <div class="flex-1">
                  <h5 class="font-medium text-gray-800">
                    Claridad visual del documento
                  </h5>
                  <p class="text-sm text-gray-600">
                    Peso en fase: 20% | Peso en unidad: 3% | Peso global: 1.2%
                  </p>
                </div>
                <input
                  type="number"
                  class="project-grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                  min="0"
                  max="5"
                  step="0.1"
                  data-weight="1.2"
                  placeholder="0.0"
                />
              </div>
            </div>
          </div>

          <!-- Fase 3-4: Roadmap -->
          <div class="mb-8">
            <h4
              class="text-lg font-semibold text-green-800 mb-4 bg-green-50 p-3 rounded-lg"
            >
              Fase 3-4: Roadmap y Gestión del Cambio (6% del curso)
            </h4>
            <div class="space-y-3">
              <div
                class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
              >
                <div class="flex-1">
                  <h5 class="font-medium text-gray-800">
                    Secuencia lógica y realista de hitos
                  </h5>
                  <p class="text-sm text-gray-600">
                    Peso en fase: 30% | Peso en unidad: 4.5% | Peso global: 1.8%
                  </p>
                </div>
                <input
                  type="number"
                  class="project-grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                  min="0"
                  max="5"
                  step="0.1"
                  data-weight="1.8"
                  placeholder="0.0"
                />
              </div>
              <div
                class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
              >
                <div class="flex-1">
                  <h5 class="font-medium text-gray-800">
                    Factibilidad de recursos, tiempos y responsables
                  </h5>
                  <p class="text-sm text-gray-600">
                    Peso en fase: 40% | Peso en unidad: 6% | Peso global: 2.4%
                  </p>
                </div>
                <input
                  type="number"
                  class="project-grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                  min="0"
                  max="5"
                  step="0.1"
                  data-weight="2.4"
                  placeholder="0.0"
                />
              </div>
              <div
                class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
              >
                <div class="flex-1">
                  <h5 class="font-medium text-gray-800">
                    Plan de comunicación y capacitación
                  </h5>
                  <p class="text-sm text-gray-600">
                    Peso en fase: 20% | Peso en unidad: 3% | Peso global: 1.2%
                  </p>
                </div>
                <input
                  type="number"
                  class="project-grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                  min="0"
                  max="5"
                  step="0.1"
                  data-weight="1.2"
                  placeholder="0.0"
                />
              </div>
              <div
                class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
              >
                <div class="flex-1">
                  <h5 class="font-medium text-gray-800">
                    Presentación y formato
                  </h5>
                  <p class="text-sm text-gray-600">
                    Peso en fase: 10% | Peso en unidad: 1.5% | Peso global: 0.6%
                  </p>
                </div>
                <input
                  type="number"
                  class="project-grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                  min="0"
                  max="5"
                  step="0.1"
                  data-weight="0.6"
                  placeholder="0.0"
                />
              </div>
            </div>
          </div>

          <!-- Presentación Final -->
          <div class="mb-8">
            <h4
              class="text-lg font-semibold text-orange-800 mb-4 bg-orange-50 p-3 rounded-lg"
            >
              Presentación Final (8% del curso)
            </h4>
            <div class="space-y-3">
              <div
                class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
              >
                <div class="flex-1">
                  <h5 class="font-medium text-gray-800">
                    Claridad y estructura de la exposición
                  </h5>
                  <p class="text-sm text-gray-600">
                    Peso en fase: 25% | Peso en unidad: 5% | Peso global: 2%
                  </p>
                </div>
                <input
                  type="number"
                  class="project-grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                  min="0"
                  max="5"
                  step="0.1"
                  data-weight="2"
                  placeholder="0.0"
                />
              </div>
              <div
                class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
              >
                <div class="flex-1">
                  <h5 class="font-medium text-gray-800">
                    Dominio del tema y respuesta a preguntas
                  </h5>
                  <p class="text-sm text-gray-600">
                    Peso en fase: 25% | Peso en unidad: 5% | Peso global: 2%
                  </p>
                </div>
                <input
                  type="number"
                  class="project-grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                  min="0"
                  max="5"
                  step="0.1"
                  data-weight="2"
                  placeholder="0.0"
                />
              </div>
              <div
                class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
              >
                <div class="flex-1">
                  <h5 class="font-medium text-gray-800">
                    Calidad de diapositivas y visuales
                  </h5>
                  <p class="text-sm text-gray-600">
                    Peso en fase: 20% | Peso en unidad: 4% | Peso global: 1.6%
                  </p>
                </div>
                <input
                  type="number"
                  class="project-grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                  min="0"
                  max="5"
                  step="0.1"
                  data-weight="1.6"
                  placeholder="0.0"
                />
              </div>
              <div
                class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
              >
                <div class="flex-1">
                  <h5 class="font-medium text-gray-800">
                    Justificación del valor de negocio (ROI)
                  </h5>
                  <p class="text-sm text-gray-600">
                    Peso en fase: 20% | Peso en unidad: 4% | Peso global: 1.6%
                  </p>
                </div>
                <input
                  type="number"
                  class="project-grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                  min="0"
                  max="5"
                  step="0.1"
                  data-weight="1.6"
                  placeholder="0.0"
                />
              </div>
              <div
                class="grade-item flex items-center justify-between p-4 bg-gray-50 rounded-lg"
              >
                <div class="flex-1">
                  <h5 class="font-medium text-gray-800">
                    Trabajo en equipo y participación equitativa
                  </h5>
                  <p class="text-sm text-gray-600">
                    Peso en fase: 10% | Peso en unidad: 2% | Peso global: 0.8%
                  </p>
                </div>
                <input
                  type="number"
                  class="project-grade-input w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
                  min="0"
                  max="5"
                  step="0.1"
                  data-weight="0.8"
                  placeholder="0.0"
                />
              </div>
            </div>
          </div>

          <!-- Project Summary -->
          <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-6">
            <h4 class="text-lg font-semibold text-purple-800 mb-4">
              Resumen del Proyecto Final
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4 text-center">
              <div>
                <div
                  class="text-2xl font-bold text-purple-600"
                  id="projectTotalGrade"
                >
                  0.0
                </div>
              <!-- La calificación del proyecto final refleja su contribución máxima de 40 % -->
              <div class="text-sm text-gray-600">Proyecto Final (40%)</div>
              </div>
              <div>
                <div
                  class="text-2xl font-bold text-purple-600"
                  id="phase1Grade"
                >
                  0.0
                </div>
                <!-- Fase 1 aporta el 4 % de la calificación final -->
                <div class="text-sm text-gray-600">Fase 1 (4%)</div>
              </div>
              <div>
                <div class="text-2xl font-bold text-blue-600" id="phase2Grade">
                  0.0
                </div>
                <!-- Fase 2 aporta el 6 % de la calificación final -->
                <div class="text-sm text-gray-600">Fase 2 (6%)</div>
              </div>
              <div>
                <div
                  class="text-2xl font-bold text-green-600"
                  id="phase34Grade"
                >
                  0.0
                </div>
                <!-- Fases 3–4 aportan el 6 % de la calificación final -->
                <div class="text-sm text-gray-600">Fases 3-4 (6%)</div>
              </div>
              <div>
                <div class="text-2xl font-bold text-orange-600" id="presentationGrade">
                  0.0
                </div>
                <!-- Presentación final aporta el 8 % de la calificación final -->
                <div class="text-sm text-gray-600">Presentación Final (8%)</div>
              </div>
              <div>
                <div class="text-2xl font-bold text-purple-800" id="finalExamGrade">
                  0.0
                </div>
                <!-- Examen integrador aporta el 16 % de la calificación final -->
                <div class="text-sm text-gray-600">Examen Final (16%)</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons (visible sólo para docentes) -->
      <div class="mt-8 flex flex-wrap gap-4 justify-center teacher-only">
        <button
          id="calculateBtn"
          class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium transition-colors"
        >
          Calcular Calificaciones
        </button>
        <button
          id="clearBtn"
          class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-lg font-medium transition-colors"
        >
          Limpiar Todo
        </button>
        <button
          id="exportBtn"
          class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-medium transition-colors"
        >
          Exportar Reporte
        </button>
      </div>

      <!-- Results Summary -->
      <div
        id="resultsSummary"
        class="mt-8 bg-white rounded-lg card-shadow p-6 hidden"
      >
        <h3 class="text-xl font-semibold text-gray-800 mb-4">
          Resumen de Calificaciones
        </h3>
        <div id="summaryContent" class="space-y-3"></div>
      </div>
    </div>

    <script>
      // Student data
      const students = [
        {
          id: "00000249116",
          name: "Arana Guerrero,Danett Itzanami",
          email: "danett.arana249116@potros.itson.edu.mx",
        },
        {
          id: "00000147818",
          name: "Araujo Godoy,Abraham Francisco",
          email: "abraham.araujo@potros.itson.edu.mx",
        },
        {
          id: "00000244228",
          name: "Avalos Morales,Egla Icel",
          email: "egla.avalos244228@potros.itson.edu.mx",
        },
        {
          id: "00000244442",
          name: "Blasco Villagomez,Luis Mario",
          email: "luis.blasco244442@potros.itson.edu.mx",
        },
        {
          id: "00000244242",
          name: "Duarte Lopez,Adlemi Guadalupe",
          email: "adlemi.duarte244242@potros.itson.edu.mx",
        },
        {
          id: "00000244473",
          name: "Espericueta Ramos,Jesus Alan",
          email: "jesus.espericueta244473@potros.itson.edu.mx",
        },
        {
          id: "00000244608",
          name: "Gracia Morales,Sergio Alejandro",
          email: "sergio.gracia244608@potros.itson.edu.mx",
        },
        {
          id: "00000228847",
          name: "Hernandez Gonzalez,Julian Ricardo",
          email: "julian.hernandez228847@potros.itson.edu.mx",
        },
        {
          id: "00000248997",
          name: "Le Blohic Garay,Mario Enrique",
          email: "mario.leblohic248997@potros.itson.edu.mx",
        },
        {
          id: "00000249012",
          name: "Lopez Guerrero,Luis Carlos",
          email: "luis.lopez249012@potros.itson.edu.mx",
        },
        {
          id: "00000248990",
          name: "Maldonado Montoya,Jose Gabriel",
          email: "jose.maldonado248990@potros.itson.edu.mx",
        },
        {
          id: "00000244378",
          name: "Martínez Santacruz,Yolanda",
          email: "yolanda.martinez244378@potros.itson.edu.mx",
        },
        {
          id: "00000217812",
          name: "Martínez Soto,Dainiz Raí",
          email: "dainiz.martinez217812@potros.itson.edu.mx",
        },
        {
          id: "00000244321",
          name: "Nevescanin Moreno,Angel Stipe",
          email: "angel.nevescanin244321@potros.itson.edu.mx",
        },
        {
          id: "00000244477",
          name: "Osuna Aguilera,Erik David",
          email: "erik.osuna244477@potros.itson.edu.mx",
        },
        {
          id: "00000244711",
          name: "Palacios Cardenas,Jorge Eduardo",
          email: "jorge.palacios244711@potros.itson.edu.mx",
        },
        {
          id: "00000244569",
          name: "Preciado Ruiz,Juan Carlos",
          email: "juan.preciado244569@potros.itson.edu.mx",
        },
        {
          id: "00000244373",
          name: "Reyes Galaz,Jose Abelardo",
          email: "jose.reyes244373@potros.itson.edu.mx",
        },
        {
          id: "00000240691",
          name: "Rivas Quintana,Emmanuel",
          email: "emmanuel.rivas240691@potros.itson.edu.mx",
        },
        {
          id: "00000244266",
          name: "Rocha Aguilar,Víctor Emmanuel",
          email: "victor.rocha244266@potros.itson.edu.mx",
        },
        {
          id: "00000244312",
          name: "Rodriguez Alvarado,Jose Agustin",
          email: "jose.rodriguez244312@potros.itson.edu.mx",
        },
        {
          id: "00000244621",
          name: "Soto Carrazco,Francisco Javier",
          email: "francisco.soto244621@potros.itson.edu.mx",
        },
        {
          id: "00000216759",
          name: "Sánchez Zavala,Dulce María",
          email: "dulce.sanchez216759@potros.itson.edu.mx",
        },
        {
          id: "00000244689",
          name: "Villegas Sosa,Ramsés Mauricio",
          email: "ramses.villegas244689@potros.itson.edu.mx",
        },
        {
          id: "00000244679",
          name: "Viveros Zavala,Angel Gael",
          email: "angel.viveros244679@potros.itson.edu.mx",
        },
      ];

      // Populate student dropdown
      function populateStudentDropdown() {
        const select = document.getElementById("studentSelect");
        students.forEach((student) => {
          const option = document.createElement("option");
          option.value = student.id;
          option.textContent = `${student.id} - ${student.name}`;
          select.appendChild(option);
        });
      }

      // Handle student selection
      document
        .getElementById("studentSelect")
        .addEventListener("change", function () {
          const selectedId = this.value;
          const student = students.find((s) => s.id === selectedId);

          if (student) {
            document.getElementById("studentId").value = student.id;
            document.getElementById("studentName").value = student.name;
            document.getElementById("studentEmail").value = student.email;

            // Load saved grades for this student
            loadStudentGrades(selectedId);
          } else {
            document.getElementById("studentId").value = "";
            document.getElementById("studentName").value = "";
            document.getElementById("studentEmail").value = "";
            clearAllGrades();
          }
        });

      // Save and load grades functionality
      function saveStudentGrades(studentId) {
        if (!studentId) return;

        const grades = {};
        document.querySelectorAll(".grade-input").forEach((input, index) => {
          grades[`regular_${index}`] = input.value;
        });
        document
          .querySelectorAll(".project-grade-input")
          .forEach((input, index) => {
            grades[`project_${index}`] = input.value;
          });

        localStorage.setItem(`grades_${studentId}`, JSON.stringify(grades));
      }

      function loadStudentGrades(studentId) {
        const savedGrades = localStorage.getItem(`grades_${studentId}`);
        if (savedGrades) {
          const grades = JSON.parse(savedGrades);
          document.querySelectorAll(".grade-input").forEach((input, index) => {
            input.value = grades[`regular_${index}`] || "";
          });
          document
            .querySelectorAll(".project-grade-input")
            .forEach((input, index) => {
              input.value = grades[`project_${index}`] || "";
            });
          calculateProjectGrades();
          calculateGrades();
        } else {
          clearAllGrades();
        }
      }

      function clearAllGrades() {
        document.querySelectorAll(".grade-input").forEach((input) => {
          input.value = "";
        });
        document.querySelectorAll(".project-grade-input").forEach((input) => {
          input.value = "";
        });
        calculateProjectGrades();
        calculateGrades();
      }

      function calculateProjectGrades() {
        // Gather all rubric inputs for the project
        const rubricInputs = document.querySelectorAll(
          "#project .project-grade-input"
        );
        // Initialize sums for each phase
        let phase1Contribution = 0;
        let phase1WeightSum = 0;
        let phase2Contribution = 0;
        let phase2WeightSum = 0;
        let phase34Contribution = 0;
        let phase34WeightSum = 0;
        let presentationContribution = 0;
        let presentationWeightSum = 0;

        // Phase 1 (first 3 rubric items) – contributes 4 % of the course
        for (let i = 0; i < 3; i++) {
          const grade = parseFloat(rubricInputs[i].value) || 0;
          const weight = parseFloat(rubricInputs[i].dataset.weight);
          // Each rubric item's weight represents its contribution (%) to the final grade.
          // Contribution = (grade / 10) * weight
          phase1Contribution += (grade / 10) * weight;
          phase1WeightSum += weight;
        }
        // Phase 2 (next 3 rubric items) – contributes 6 % of the course
        for (let i = 3; i < 6; i++) {
          const grade = parseFloat(rubricInputs[i].value) || 0;
          const weight = parseFloat(rubricInputs[i].dataset.weight);
          phase2Contribution += (grade / 10) * weight;
          phase2WeightSum += weight;
        }
        // Phase 3-4 (next 4 rubric items) – contributes 6 % of the course
        for (let i = 6; i < 10; i++) {
          const grade = parseFloat(rubricInputs[i].value) || 0;
          const weight = parseFloat(rubricInputs[i].dataset.weight);
          phase34Contribution += (grade / 10) * weight;
          phase34WeightSum += weight;
        }
        // Presentation (next 5 rubric items) – contributes 8 % of the course
        for (let i = 10; i < 15; i++) {
          const grade = parseFloat(rubricInputs[i].value) || 0;
          const weight = parseFloat(rubricInputs[i].dataset.weight);
          presentationContribution += (grade / 10) * weight;
          presentationWeightSum += weight;
        }

        // Compute weighted average grade for each phase (0–10). If no inputs, average = 0
        const phase1Avg = phase1WeightSum
          ? (phase1Contribution * 10) / phase1WeightSum
          : 0;
        const phase2Avg = phase2WeightSum
          ? (phase2Contribution * 10) / phase2WeightSum
          : 0;
        const phase34Avg = phase34WeightSum
          ? (phase34Contribution * 10) / phase34WeightSum
          : 0;
        const presentationAvg = presentationWeightSum
          ? (presentationContribution * 10) / presentationWeightSum
          : 0;

        // Update high-level Unit III grade inputs with the weighted average grade from the rubric
        const fase1Input = document.querySelector(
          '#unit3 .grade-input[data-weight="4"]'
        );
        if (fase1Input) fase1Input.value = phase1Avg.toFixed(1);
        // Hay dos inputs con data-weight="6" dentro de la unidad III: el primero corresponde a la Fase 2 y el segundo a las Fases 3‑4.
        const weight6Inputs = document.querySelectorAll(
          '#unit3 .grade-input[data-weight="6"]'
        );
        const fase2Input = weight6Inputs[0];
        const fase34Input = weight6Inputs[1];
        if (fase2Input) fase2Input.value = phase2Avg.toFixed(1);
        if (fase34Input) fase34Input.value = phase34Avg.toFixed(1);
        const presentInput = document.querySelector(
          '#unit3 .grade-input[data-weight="8"]'
        );
        if (presentInput) presentInput.value = presentationAvg.toFixed(1);

        // Calculate Final Exam contribution (16 % of course). It resides in Unit III.
        const examInput = document.querySelector(
          '#unit3 .grade-input[data-weight="16"]'
        );
        let examGrade = 0;
        if (examInput) {
          const examValue = parseFloat(examInput.value) || 0;
          // Convert exam grade (0–10) to its weighted contribution (0–16)
          examGrade = (examValue / 10) * 16;
        }

        // Update summary displays with contributions (0–weight)
        document.getElementById("phase1Grade").textContent = phase1Contribution.toFixed(1);
        document.getElementById("phase2Grade").textContent = phase2Contribution.toFixed(1);
        document.getElementById("phase34Grade").textContent = phase34Contribution.toFixed(1);
        document.getElementById("presentationGrade").textContent = presentationContribution.toFixed(1);
        document.getElementById("finalExamGrade").textContent = examGrade.toFixed(1);

        // Sum contributions to get total project contribution (0–40)
        const projectTotal =
          phase1Contribution +
          phase2Contribution +
          phase34Contribution +
          presentationContribution +
          examGrade;
        document.getElementById("projectTotalGrade").textContent =
          projectTotal.toFixed(1);

        return projectTotal;
      }

      // Auto-save grades when changed
      document.querySelectorAll(".grade-input").forEach((input) => {
        input.addEventListener("input", () => {
          // Whenever a standard grade input changes, recalculate both unit-based grades
          // and project-based grades. This ensures the final exam (which resides in Unit III)
          // reflects in the project summary when edited.
          calculateGrades();
          calculateProjectGrades();
          const studentId = document.getElementById("studentId").value;
          if (studentId) {
            saveStudentGrades(studentId);
          }
        });
      });

      // Auto-save project grades when changed
      document.querySelectorAll(".project-grade-input").forEach((input) => {
        input.addEventListener("input", () => {
          calculateProjectGrades();
          calculateGrades();
          const studentId = document.getElementById("studentId").value;
          if (studentId) {
            saveStudentGrades(studentId);
          }
        });
      });

      // Tab functionality
      document.querySelectorAll(".tab-button").forEach((button) => {
        button.addEventListener("click", () => {
          const unit = button.dataset.unit;

          // Update tab buttons
          document.querySelectorAll(".tab-button").forEach((btn) => {
            btn.classList.remove(
              "bg-blue-50",
              "text-blue-600",
              "border-b-2",
              "border-blue-600"
            );
            btn.classList.add("text-gray-600");
          });
          button.classList.add(
            "bg-blue-50",
            "text-blue-600",
            "border-b-2",
            "border-blue-600"
          );
          button.classList.remove("text-gray-600");

          // Update content
          document.querySelectorAll(".unit-content").forEach((content) => {
            content.classList.add("hidden");
          });
          if (unit === "project") {
            document.getElementById("project").classList.remove("hidden");
          } else {
            document.getElementById(`unit${unit}`).classList.remove("hidden");
          }
        });
      });

      // Auto-calculate on input change
      document.querySelectorAll(".grade-input").forEach((input) => {
        input.addEventListener("input", calculateGrades);
      });

      function calculateGrades() {
        let totalWeightedGrade = 0;
        let unit1Total = 0;
        let unit2Total = 0;
        let unit3Total = 0;

        // Calcular para cada unidad (ponderaciones: U1 30 %, U2 30 %, U3 40 %)
        document.querySelectorAll("#unit1 .grade-input").forEach((input) => {
          const grade = parseFloat(input.value) || 0;
          const weight = parseFloat(input.dataset.weight);
          unit1Total += (grade * weight) / 30; // Unidad I aporta el 30 % del total del curso
        });

        document.querySelectorAll("#unit2 .grade-input").forEach((input) => {
          const grade = parseFloat(input.value) || 0;
          const weight = parseFloat(input.dataset.weight);
          unit2Total += (grade * weight) / 30; // Unidad II aporta el 30 % del total del curso
        });

        document.querySelectorAll("#unit3 .grade-input").forEach((input) => {
          const grade = parseFloat(input.value) || 0;
          const weight = parseFloat(input.dataset.weight);
          unit3Total += (grade * weight) / 40; // Unidad III aporta el 40 % del total del curso
        });

        // Calcular la contribución de cada unidad en porcentaje del curso.
        // Si la calificación de la unidad es 10, aporta su peso completo (30 %, 30 % o 40 %).
        const unit1Contribution = (unit1Total / 10) * 30; // 0–30
        const unit2Contribution = (unit2Total / 10) * 30; // 0–30
        const unit3Contribution = (unit3Total / 10) * 40; // 0–40
        const finalContribution =
          unit1Contribution + unit2Contribution + unit3Contribution; // 0–100
        // Normalizar sobre la suma de ponderaciones (100) para obtener un porcentaje 0–100
        const totalWeightSum = 30 + 30 + 40;
        const finalPct = (finalContribution / totalWeightSum) * 100;

        // Update displays: mostrar contribución (%) por unidad y porcentaje total
        document.getElementById("finalGrade").textContent = finalPct.toFixed(1);
        document.getElementById("unit1Grade").textContent = unit1Contribution.toFixed(1);
        document.getElementById("unit2Grade").textContent = unit2Contribution.toFixed(1);
        document.getElementById("unit3Grade").textContent = unit3Contribution.toFixed(1);

        // Update progress bar
        const progressPercent = Math.min(finalPct, 100);
        document.getElementById(
          "progressPercent"
        ).textContent = `${progressPercent.toFixed(0)}%`;
        document.getElementById(
          "progressBar"
        ).style.width = `${progressPercent}%`;

        // Update progress bar color based on percentage achieved
        const progressBar = document.getElementById("progressBar");
        progressBar.className = "h-3 rounded-full progress-bar";
        if (finalPct >= 90.0) {
          progressBar.classList.add(
            "bg-gradient-to-r",
            "from-green-500",
            "to-green-600"
          );
        } else if (finalPct >= 70.0) {
          progressBar.classList.add(
            "bg-gradient-to-r",
            "from-yellow-500",
            "to-yellow-600"
          );
        } else if (finalPct >= 60.0) {
          progressBar.classList.add(
            "bg-gradient-to-r",
            "from-orange-500",
            "to-orange-600"
          );
        } else {
          progressBar.classList.add(
            "bg-gradient-to-r",
            "from-red-500",
            "to-red-600"
          );
        }
      }

      // Calculate button
      document.getElementById("calculateBtn").addEventListener("click", () => {
        calculateGrades();
        showSummary();
      });

      // Clear button
      document.getElementById("clearBtn").addEventListener("click", () => {
        const studentId = document.getElementById("studentId").value;
        if (
          studentId &&
          confirm(
            "¿Está seguro de que desea limpiar todas las calificaciones de este estudiante?"
          )
        ) {
          // Clear grades from localStorage
          localStorage.removeItem(`grades_${studentId}`);
          clearAllGrades();
          document.getElementById("resultsSummary").classList.add("hidden");
        } else if (!studentId) {
          // If no student selected, just clear the form
          document.getElementById("studentSelect").value = "";
          document.getElementById("studentName").value = "";
          document.getElementById("studentId").value = "";
          document.getElementById("studentEmail").value = "";
          clearAllGrades();
          document.getElementById("resultsSummary").classList.add("hidden");
        }
      });

      // Export button
      document.getElementById("exportBtn").addEventListener("click", () => {
        const studentName =
          document.getElementById("studentName").value || "Estudiante";
        const studentId = document.getElementById("studentId").value || "N/A";
        const finalGrade = document.getElementById("finalGrade").textContent;

        let reportContent = `REPORTE DE CALIFICACIONES - CALIDAD DE SOFTWARE\n`;
        reportContent += `==============================================\n\n`;
        reportContent += `Estudiante: ${studentName}\n`;
        reportContent += `Código: ${studentId}\n`;
        reportContent += `Fecha: ${new Date().toLocaleDateString()}\n\n`;
        // Ajuste de escala: mostrar el avance total en porcentaje (0–100)
        reportContent += `AVANCE TOTAL: ${finalGrade}%\n\n`;

        reportContent += `DETALLE POR UNIDADES:\n`;
        reportContent += `- Unidad I (30%): ${
          document.getElementById("unit1Grade").textContent
        }%\n`;
        reportContent += `- Unidad II (30%): ${
          document.getElementById("unit2Grade").textContent
        }%\n`;
        // La unidad III se pondera al 40 % del curso
        reportContent += `- Unidad III (40%): ${
          document.getElementById("unit3Grade").textContent
        }%\n\n`;

        const blob = new Blob([reportContent], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Reporte_${studentName.replace(/\s+/g, "_")}_${
          new Date().toISOString().split("T")[0]
        }.txt`;
        a.click();
        URL.revokeObjectURL(url);
      });

      function showSummary() {
        // La variable `finalGrade` almacena ahora un porcentaje (0–100) en lugar de
        // una calificación sobre 10. Se interpreta como el avance total del
        // curso, por lo que el umbral de aprobación se fija en 60 %. Si
        // `finalGrade` es 100, el estudiante ha cubierto el 100 % de las
        // ponderaciones del curso.
        const finalGrade = parseFloat(
          document.getElementById("finalGrade").textContent
        );
        const summaryDiv = document.getElementById("summaryContent");

        let status = "";
        let statusColor = "";

        // Con escala porcentual (0–100), se aprueba con 60 % o más
        if (finalGrade >= 60.0) {
          status = "APROBADO";
          statusColor = "text-green-600";
        } else {
          status = "REPROBADO";
          statusColor = "text-red-600";
        }

        summaryDiv.innerHTML = `
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                    <span class="font-medium">Estado del Curso:</span>
                    <span class="font-bold ${statusColor}">${status}</span>
                </div>
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                    <span class="font-medium">Progreso total:</span>
                    <span class="font-bold text-blue-600">${finalGrade.toFixed(
                      1
                    )}%</span>
                </div>
                <div class="text-sm text-gray-600 mt-4">
                    <p><strong>Nota:</strong> La calificación mínima para aprobar es 60.0%</p>
                </div>
            `;

        document.getElementById("resultsSummary").classList.remove("hidden");
      }

      // Initialize
      populateStudentDropdown();
      calculateProjectGrades();
      calculateGrades();
    </script>
    <!-- Script para activar la vista de alumno y ocultar el preview por defecto -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Ocultar la vista de alumno (student-preview) al cargar la página
        const preview = document.getElementById("student-preview");
        if (preview) {
          preview.style.display = "none";
        }
        // Configurar el botón de vista de alumno
        const btn = document.getElementById("viewStudentPreviewBtn");
        if (btn) {
          btn.addEventListener("click", function () {
            const prev = document.getElementById("student-preview");
            if (prev) {
              // Mostrar el preview y desplazar la página suavemente
              prev.style.display = "";
              prev.scrollIntoView({ behavior: "smooth" });
            }
          });
        }
      });
    </script>
    <script type="module" src="./js/role-gate.js"></script>

    <script>
      // Gating por rol local: estudiante solo lectura
      document.addEventListener("DOMContentLoaded", function () {
        try {
          var rol = (
            localStorage.getItem("qs_role") || "estudiante"
          ).toLowerCase();
          if (rol !== "docente") {
            // Deshabilitar todas las entradas y botones para estudiantes.  No se hace
            // excepción con los botones de cálculo/limpieza/exportación ya
            // que éstos se ocultan con la clase `teacher-only`.
            document
              .querySelectorAll("input, select, textarea, button")
              .forEach(function (el) {
                if (el.tagName === "BUTTON") {
                  // No deshabilitar los botones de navegación entre unidades (tab-button).
                  if (!el.classList.contains('tab-button')) {
                    el.disabled = true;
                  }
                } else if (
                  el.tagName === "INPUT" ||
                  el.tagName === "SELECT" ||
                  el.tagName === "TEXTAREA"
                ) {
                  el.readOnly = true;
                  el.disabled = true;
                }
              });
            document
              .querySelectorAll(".teacher-only,.docente-only")
              .forEach(function (el) {
                el.style.display = "none";
              });
          }
        } catch (e) {}
      });
    </script>
    <script type="module" src="js/calificaciones-backend.js"></script>
    <!-- Cargar vista previa del estudiante para docentes. Este módulo inserta la sección
         #student-preview en el DOM y llena la tabla de actividades cuando se
         selecciona un alumno. Si el usuario no tiene rol de docente, la sección
         seguirá oculta por el gating de permisos. -->
    <script type="module" src="js/calificaciones-teacher-preview.js"></script>
<script defer src="js/layout.js"></script>
    <!-- Ajuste dinámico de los rangos de las calificaciones: escala 0–10 -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        document
          .querySelectorAll('.grade-input, .project-grade-input')
          .forEach(function (input) {
            input.setAttribute('max', '10');
            input.setAttribute('min', '0');
          });
      });
    </script>
    </body>
</html>

    <script defer src="js/back-home.js"></script>
    <script defer src="js/nav-inject.js"></script>
    <script>
      window.firebaseConfig = {
        apiKey: "AIzaSyBDip2OjSOUZrr3iiIle2Klodify9LaLe8",
        authDomain: "calidad-de-software-v2.firebaseapp.com",
        projectId: "calidad-de-software-v2",
        storageBucket: "calidad-de-software-v2.firebasestorage.app",
        messagingSenderId: "220818066383",
        appId: "1:220818066383:web:0c2119f470a5f9711b60ba",
      };
    </script>

    <!-- Firebase (compat para no tocar tu frontend) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script>
      if (typeof firebase !== "undefined") {
        if (!firebase.apps || firebase.apps.length === 0) {
          firebase.initializeApp(window.firebaseConfig);
        }
        window._authCompat = firebase.auth();
        window._dbCompat = firebase.firestore();
      }
    </script>

    <script>
      // Reuse the existing firebaseConfig variable declared earlier in the script.
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const firestoreDb = firebase.firestore();
    </script>

    <div id="calificaciones-root" data-grupo="calidad-2025"></div>

    <script type="module">
      import {
        initializeApp,
        getApps,
        getApp,
      } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        collection,
        getDocs,
        query,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

      const app = getApps().length
        ? getApp()
        : initializeApp(window.firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const root = document.getElementById("calificaciones-root");
      if (!root) console.warn("#calificaciones-root no existe");
      const params = new URLSearchParams(location.search);
      const GRUPO_ID =
        root?.dataset?.grupo || params.get("grupo") || "calidad-2025";

      root.innerHTML = `
    <section class="qsc-wrap">
      <h2 class="qsc-title">Mis calificaciones</h2>
      <div class="qsc-kpis">
        <div class="qsc-kpi"><span id="qsc-kpi-total">--%</span><small>Total</small></div>
        <div class="qsc-kpi"><span id="qsc-kpi-items">0</span><small>Actividades</small></div>
        <div class="qsc-kpi"><span id="qsc-kpi-pond">0%</span><small>Peso cubierto</small></div>
      </div>
      <div class="qsc-bar"><div id="qsc-bar-fill" class="qsc-bar-fill"></div></div>
      <div class="qsc-table-wrap">
        <table class="qsc-table">
          <thead><tr>
            <th>Actividad</th><th>Puntos</th><th>Máx</th>
            <th>Ponderación</th><th>Aporta al final</th><th>Fecha</th>
          </tr></thead>
          <tbody id="qsc-tbody"><tr><td class="qsc-muted" colspan="6">Cargando…</td></tr></tbody>
        </table>
      </div>
      <p id="qsc-msg" class="qsc-msg"></p>
    </section>`;

      const ui = {
        tbody: root.querySelector("#qsc-tbody"),
        msg: root.querySelector("#qsc-msg"),
        kpiTotal: root.querySelector("#qsc-kpi-total"),
        kpiItems: root.querySelector("#qsc-kpi-items"),
        kpiPond: root.querySelector("#qsc-kpi-pond"),
        barFill: root.querySelector("#qsc-bar-fill"),
      };

      const clampPct = (n) => Math.max(0, Math.min(100, Number(n) || 0));
      const fmtPct = (n) => `${clampPct(n).toFixed(2)}%`;
      const fmtDate = (ts) => {
        if (!ts) return "";
        const d = ts?.seconds ? new Date(ts.seconds * 1000) : new Date(ts);
        return isNaN(d.getTime()) ? "" : d.toLocaleDateString("es-MX");
      };

      async function obtenerMisItems(uid) {
        const ref = collection(
          db,
          "grupos",
          GRUPO_ID,
          "calificaciones",
          uid,
          "items"
        );
        const snap = await getDocs(query(ref, orderBy("fecha", "asc")));
        return snap.docs.map((d) => ({ id: d.id, ...d.data() }));
      }
      function resumen(items) {
        let porc = 0,
          pond = 0;
        for (const it of items) {
          const max = Number(it.maxPuntos) || 0;
          const pts = Number(it.puntos) || 0;
          const pnd = Number(it.ponderacion) || 0;
          if (max > 0) porc += (pts / max) * pnd;
          pond += pnd;
        }
        /*
         * Ajuste de ponderación total
         * --------------------------
         *
         * La suma de ponderaciones (pond) proveniente de Firestore puede no
         * coincidir con el 100 % esperado cuando las unidades se han
         * actualizado en el frontend (por ejemplo, al añadir actividades o
         * modificar pesos). Esto provoca que el KPI "Peso cubierto" muestre
         * porcentajes como 24.9 %, lo que genera confusión. Para mejorar la
         * usabilidad, asumimos que la suma total de ponderaciones del curso
         * debe ser 100 % (30 % + 30 % + 40 %). Si la suma real es menor,
         * escalamos proporcionalmente el porcentaje de calificación y
         * normalizamos la ponderación total a 100 %.
         */
        const EXPECTED_TOTAL_POND = 100;
        if (pond > 0 && pond < EXPECTED_TOTAL_POND) {
          const scale = EXPECTED_TOTAL_POND / pond;
          porc = porc * scale;
          pond = EXPECTED_TOTAL_POND;
        }
        return { porcentaje: clampPct(porc), pondSum: clampPct(pond) };
      }
      function render(items, me) {
        const { porcentaje, pondSum } = resumen(items);
        ui.kpiTotal.textContent = fmtPct(porcentaje);
        ui.kpiItems.textContent = items.length;
        ui.kpiPond.textContent = fmtPct(pondSum);
        ui.barFill.style.width = fmtPct(porcentaje);
        ui.tbody.innerHTML = "";
        if (items.length === 0) {
          ui.tbody.innerHTML = `<tr><td colspan="6" class="qsc-muted">Sin actividades registradas aún.</td></tr>`;
          ui.msg.textContent = me?.nombre ? `Alumno: ${me.nombre}` : "";
          return;
        }
        for (const it of items) {
          const max = Number(it.maxPuntos) || 0;
          const pts = Number(it.puntos) || 0;
          const pnd = Number(it.ponderacion) || 0;
          const aporta = max > 0 ? (pts / max) * pnd : 0;
          ui.tbody.insertAdjacentHTML(
            "beforeend",
            `
        <tr>
          <td>${it.nombre || "Actividad"}</td>
          <td>${pts}</td>
          <td>${max}</td>
          <td>${pnd}%</td>
          <td>${fmtPct(aporta)}</td>
          <td>${fmtDate(it.fecha)}</td>
        </tr>`
          );
        }
        ui.msg.textContent = me?.nombre ? `Alumno: ${me.nombre}` : "";
      }

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          ui.msg.textContent =
            "Inicia sesión con tu correo @potros para ver tu progreso.";
          return;
        }
        try {
          const meSnap = await getDoc(doc(db, "users", user.uid));
          const me = meSnap.exists() ? meSnap.data() : {};
          const items = await obtenerMisItems(user.uid);
          render(items, me);
        } catch (err) {
          console.error(err);
          ui.tbody.innerHTML = `<tr><td colspan="6">Error al cargar calificaciones.</td></tr>`;
          ui.msg.textContent = "Inténtalo más tarde.";
        }
      });
    </script>

    <script type="module">
      import {
        initializeApp,
        getApps,
        getApp,
      } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        collection,
        getDocs,
        query,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

      // Init seguro con tu config global (window.firebaseConfig ya definida arriba)
      const app = getApps().length
        ? getApp()
        : initializeApp(window.firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Contenedor y grupo
      const root = document.getElementById("calificaciones-root");
      if (!root) {
        console.warn("#calificaciones-root no existe");
        throw new Error("Sin root");
      }
      const params = new URLSearchParams(location.search);
      const GRUPO_ID =
        root.dataset.grupo || params.get("grupo") || "calidad-2025";

      // Ponderaciones por unidad (final = 30/30/40)
      // === PONDERACIONES POR UNIDAD (FINAL 30/30/40) ===
      // El proyecto final y su rúbrica se integran dentro del 40 % que aporta la unidad III al curso.
      // Las unidades I y II aportan un 30 % cada una.
      const UNIT_WEIGHTS_FINAL = { 1: 30, 2: 30, 3: 40 }; // %

      /**
       * Distribución de categorías por unidad.
       * U1 y U2: participacion 10, asignación 20, trabajo 25 y examen 45 (% dentro de la unidad).
       * U3: proyecto 36 y examen 24 (% del total del curso). Las demás categorías no aplican.
       */
      function unitCategoryWeights(u) {
        if (u === 3) {
          // Para la unidad III (40 % del curso) el proyecto final (fases y presentación)
          // y el examen se integran en las categorías "proyecto" y "examen" dentro de ese 40 %.
          // Las categorías de participación/asignación/trabajo no aplican en U3.
          return {
            participacion: 0,
            asignacion: 0,
            trabajo: 0,
            examen: 16.0,
            proyecto: 24.0,
          };
        }
        return {
          participacion: 10,
          asignacion: 20,
          trabajo: 25,
          examen: 45,
          proyecto: 0,
        };
      }

      /** Calcula % de la unidad sumando aportes por categoría.
       *  Cada categoría reparte su peso fijo entre el número de ítems que tenga. */
      function computeUnit(items, u) {
        const W = unitCategoryWeights(u);
        const groups = {
          participacion: [],
          asignacion: [],
          trabajo: [],
          examen: [],
          proyecto: [],
        };

        for (const it of items) {
          // Requiere que ya tengas inferUnidad(...) y canonicalTipo(...)
          if (inferUnidad(it) !== u) continue;
          const t = canonicalTipo(it);
          const max = Number(it.maxPuntos) || 0;
          const pts = Number(it.puntos) || 0;
          const ratio = max > 0 ? pts / max : 0; // 0–1
          groups[t].push(ratio);
        }

        let unitPct = 0; // % obtenido dentro de la unidad
        let covered = 0; // % cubierto de la unidad (por categorías con ítems)

        for (const t of Object.keys(groups)) {
          const catW = W[t] || 0; // % fijo de la categoría en la unidad
          const n = groups[t].length; // ítems en esa categoría
          if (catW > 0 && n > 0) {
            const perItemW = catW / n; // % de unidad por ítem
            unitPct += groups[t].reduce((s, r) => s + r * perItemW, 0);
            covered += catW;
          }
        }
        return {
          unitPct: Math.min(100, unitPct),
          covered: Math.min(100, covered),
          groups,
          weights: W,
        };
      }

      /** Aporte al FINAL de un ítem concreto considerando su unidad y categoría */
      function aportaItemFinal(u, t, ratio, groups, weights) {
        const n = groups[t]?.length || 1;
        const catW = weights[t] || 0; // % en la unidad
        const itemW_unit = catW / n; // % de unidad para este ítem
        const unitW_final = UNIT_WEIGHTS_FINAL[u]; // 30/30/40
        return Math.min(100, ratio * itemW_unit * (unitW_final / 100));
      }

      // UI mínima, no rompe tu diseño
      root.innerHTML = `
    <section class="qsc-wrap">
      <h2 class="qsc-title">Mis calificaciones</h2>
      <div class="qsc-kpis" id="qsc-kpis">
        <div class="qsc-kpi"><span id="kpi-final">--%</span><small>Final (30/30/40)</small></div>
        <div class="qsc-kpi"><span id="kpi-u1">--%</span><small>Unidad 1 (30%)</small></div>
        <div class="qsc-kpi"><span id="kpi-u2">--%</span><small>Unidad 2 (30%)</small></div>
        <div class="qsc-kpi"><span id="kpi-u3">--%</span><small>Unidad 3 (40%)</small></div>
        <div class="qsc-kpi"><span id="kpi-items">0</span><small>Actividades</small></div>
        <div class="qsc-kpi"><span id="kpi-pond">0%</span><small>Peso cubierto</small></div>
      </div>
      <div class="qsc-bar"><div id="qsc-bar-fill" class="qsc-bar-fill"></div></div>

      <div class="qsc-table-wrap">
        <table class="qsc-table">
          <thead>
            <tr>
              <th>Actividad</th>
              <th>Tipo</th>
              <th>Unidad</th>
              <th>Puntos</th>
              <th>Máx</th>
              <th>Ponderación</th>
              <th>Aporta al final</th>
              <th>Escala</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody id="qsc-tbody">
            <tr><td class="qsc-muted" colspan="9">Cargando…</td></tr>
          </tbody>
        </table>
      </div>
      <p id="qsc-msg" class="qsc-msg"></p>
    </section>`;

      // Refs UI
      const ui = {
        tbody: root.querySelector("#qsc-tbody"),
        msg: root.querySelector("#qsc-msg"),
        kFinal: root.querySelector("#kpi-final"),
        kU1: root.querySelector("#kpi-u1"),
        kU2: root.querySelector("#kpi-u2"),
        kU3: root.querySelector("#kpi-u3"),
        kItems: root.querySelector("#kpi-items"),
        kPond: root.querySelector("#kpi-pond"),
        barFill: root.querySelector("#qsc-bar-fill"),
      };

      // Helpers
      const clampPct = (n) => Math.max(0, Math.min(100, Number(n) || 0));
      const fmtPct = (n) => `${clampPct(n).toFixed(2)}%`;
      const fmtDate = (ts) => {
        if (!ts) return "";
        const d = ts?.seconds ? new Date(ts.seconds * 1000) : new Date(ts);
        return isNaN(d.getTime()) ? "" : d.toLocaleDateString("es-MX");
      };

      // Inferencia suave de unidad y tipo si faltan
      function inferUnidad(it) {
        if (it.unidad != null) return Number(it.unidad);
        const n = String(it.nombre || "").toLowerCase();
        if (/\bunidad\s*1\b|\bu1\b/.test(n)) return 1;
        if (/\bunidad\s*2\b|\bu2\b/.test(n)) return 2;
        if (/\bunidad\s*3\b|\bu3\b/.test(n)) return 3;
        return 0; // sin unidad
      }
      function inferTipo(it) {
        if (it.tipo) return String(it.tipo).toLowerCase();
        const n = String(it.nombre || "").toLowerCase();
        if (/examen|quiz|prueba/.test(n)) return "examen";
        if (/proyecto|entregable final/.test(n)) return "proyecto";
        if (/asignaci[oó]n|tarea/.test(n)) return "asignacion";
        if (/actividad|pr[aá]ctica|ejercicio/.test(n)) return "actividad";
        return "actividad";
      }

      // Escala por tipo (puedes ajustar umbrales por tipo)
      function escala(scorePct, tipo) {
        const t = String(tipo || "general").toLowerCase();
        const thresholds = {
          general: [90, 80, 70, 60],
          examen: [90, 80, 70, 60],
          proyecto: [90, 80, 75, 65],
          asignacion: [90, 80, 70, 60],
          actividad: [90, 80, 70, 60],
        };
        const [A, B, C, D] = thresholds[t] || thresholds.general;
        return scorePct >= A
          ? "Excelente"
          : scorePct >= B
          ? "Notable"
          : scorePct >= C
          ? "Bueno"
          : scorePct >= D
          ? "Suficiente"
          : "Insuficiente";
      }

      // Carga items del alumno
      async function obtenerMisItems(uid) {
        const ref = collection(
          db,
          "grupos",
          GRUPO_ID,
          "calificaciones",
          uid,
          "items"
        );
        const snap = await getDocs(query(ref, orderBy("fecha", "asc")));
        return snap.docs.map((d) => ({ id: d.id, ...d.data() }));
      }

      // Cálculo por unidad respetando ponderaciones internas
      function calcularUnidades(items) {
        // Separar por unidad
        const buckets = { 1: [], 2: [], 3: [] };
        let pondTotal = 0;
        for (const it of items) {
          const u = inferUnidad(it);
          if (u === 1 || u === 2 || u === 3) buckets[u].push(it);
          pondTotal += Number(it.ponderacion) || 0;
        }
        // Para cada unidad: normaliza por suma de ponderaciones de esa unidad
        function unitScore(arr) {
          if (!arr.length) return { score: 0, pond: 0 };
          let raw = 0,
            pondSum = 0;
          for (const it of arr) {
            const max = Number(it.maxPuntos) || 0;
            const pts = Number(it.puntos) || 0;
            const pond = Number(it.ponderacion) || 0;
            if (max > 0) raw += (pts / max) * pond;
            pondSum += pond;
          }
          const scorePct = pondSum > 0 ? (raw / pondSum) * 100 : 0; // 0–100%
          return { score: clampPct(scorePct), pond: clampPct(pondSum) };
        }
        const u1 = unitScore(buckets[1]);
        const u2 = unitScore(buckets[2]);
        const u3 = unitScore(buckets[3]);
        /*
         * Ajuste de ponderaciones por unidad
         * ----------------------------------
         *
         * Las ponderaciones acumuladas (pond) de cada unidad en la vista de
         * estudiantes se extraen del campo "ponderacion" almacenado en
         * Firestore para cada actividad. Sin embargo, estas ponderaciones
         * pueden no reflejar los pesos globales actualizados cuando se
         * realizan cambios en el frontend (por ejemplo, al añadir nuevas
         * actividades como la participación en clase). Esto provoca que la
         * suma de ponderaciones mostrada en los KPI de la unidad no alcance
         * el 30 % o 40 % esperados, dando lugar a valores como 24.9 %.
         *
         * Para evitar esta discrepancia y garantizar que las unidades
         * siempre muestren el porcentaje correcto de avance según su
         * ponderación en el curso (Unidad I = 30 %, Unidad II = 30 %,
         * Unidad III = 40 %), se sobreescriben los campos `pond` de cada
         * unidad con valores fijos cuando existan actividades en esa
         * unidad. Si una unidad no tiene actividades registradas,
         * su ponderación se mantiene en cero para indicar que aún no se ha
         * cubierto.
         */
        // Ajustar las ponderaciones fijas por unidad para que reflejen la distribución 30/30/40.
        const FIXED_PONDS = { 1: 30, 2: 30, 3: 40 };
        u1.pond = buckets[1].length > 0 ? FIXED_PONDS[1] : 0;
        u2.pond = buckets[2].length > 0 ? FIXED_PONDS[2] : 0;
        u3.pond = buckets[3].length > 0 ? FIXED_PONDS[3] : 0;
        // Actualizar pondTotal en base a los valores fijos
        pondTotal = u1.pond + u2.pond + u3.pond;
        return { u1, u2, u3, pondTotal: clampPct(pondTotal) };
      }

      function calcularFinal(u1, u2, u3) {
        // final = (30/100)*u1 + (30/100)*u2 + (40/100)*u3
        // Equivale a ponderar las unidades I y II con el 30 % y la unidad III con el 40 %,
        // normalizado sobre la suma de ponderaciones (100).
        const totalWeight = 30 + 30 + 40;
        return clampPct((u1 * 30 + u2 * 30 + u3 * 40) / totalWeight);
      }

      function render(items, me) {
        // KPIs por unidad y final
        const { u1, u2, u3, pondTotal } = calcularUnidades(items);
        // Calculamos la contribución de cada unidad al total del curso.
        // Cada unidad aporta un porcentaje fijo (30 %, 30 %, 40 %) que se
        // multiplica por el desempeño de la unidad (0–100 %). De este modo,
        // si un alumno obtiene 100 % en la unidad I, su contribución al
        // curso será 30 %; con 80 %, aportará 24 % (80 % × 30). Esto evita
        // que la interfaz muestre 100 cuando se espera ver 30.
        const weight1 = UNIT_WEIGHTS_FINAL[1] || 0;
        const weight2 = UNIT_WEIGHTS_FINAL[2] || 0;
        const weight3 = UNIT_WEIGHTS_FINAL[3] || 0;
        const unit1Contribution = (u1.score / 100) * weight1;
        const unit2Contribution = (u2.score / 100) * weight2;
        const unit3Contribution = (u3.score / 100) * weight3;
        const totalWeightSum = weight1 + weight2 + weight3;
        // El porcentaje final se normaliza sobre la suma total de pesos (100)
        // para que el máximo sea 100 %. Por ejemplo, 30 + 30 + 40 = 100 → 100 %.
        const finalPct = totalWeightSum > 0
          ? ((unit1Contribution + unit2Contribution + unit3Contribution) / totalWeightSum) * 100
          : 0;

        // Mostrar cada contribución y el porcentaje final
        ui.kFinal.textContent = fmtPct(finalPct);
        ui.kU1.textContent = u1.pond > 0 ? fmtPct(unit1Contribution) : "—";
        ui.kU2.textContent = u2.pond > 0 ? fmtPct(unit2Contribution) : "—";
        ui.kU3.textContent = u3.pond > 0 ? fmtPct(unit3Contribution) : "—";
        ui.kItems.textContent = items.length;
        ui.kPond.textContent = fmtPct(pondTotal);
        ui.barFill.style.width = fmtPct(finalPct);

        // Tabla
        ui.tbody.innerHTML = "";
        if (!items.length) {
          ui.tbody.innerHTML = `<tr><td colspan="9" class="qsc-muted">Sin actividades registradas aún.</td></tr>`;
          ui.msg.textContent = me?.nombre ? `Alumno: ${me.nombre}` : "";
          return;
        }
        for (const it of items) {
          const tipo = inferTipo(it);
          const unidad = inferUnidad(it);
          const max = Number(it.maxPuntos) || 0;
          const pts = Number(it.puntos) || 0;
          const pond = Number(it.ponderacion) || 0;
          const puntPct = max > 0 ? (pts / max) * 100 : 0; // % propio del ítem
          const aporta = max > 0 ? (pts / max) * pond : 0; // % que aporta al FINAL
          const esc = escala(clampPct(puntPct), tipo);

          ui.tbody.insertAdjacentHTML(
            "beforeend",
            `
        <tr>
          <td>${it.nombre || "Actividad"}</td>
          <td>${tipo}</td>
          <td>${unidad || "-"}</td>
          <td>${pts}</td>
          <td>${max}</td>
          <td>${pond}%</td>
          <td>${fmtPct(aporta)}</td>
          <td>${fmtPct(puntPct)} · ${esc}</td>
          <td>${fmtDate(it.fecha)}</td>
        </tr>
      `
          );
        }
        ui.msg.textContent = me?.nombre ? `Alumno: ${me.nombre}` : "";
      }

      // Auth gate
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          ui.msg.textContent =
            "Inicia sesión con tu correo @potros para ver tu progreso.";
          return;
        }
        try {
          // Datos del usuario (si no hay permisos, se usa fallback)
          let me = { nombre: user.displayName || user.email, matricula: "" };
          try {
            const meSnap = await getDoc(doc(db, "users", user.uid));
            if (meSnap.exists()) me = { ...me, ...meSnap.data() };
          } catch (_) {}

          const items = await getDocs(
            query(
              collection(
                db,
                "grupos",
                GRUPO_ID,
                "calificaciones",
                user.uid,
                "items"
              ),
              orderBy("fecha", "asc")
            )
          ).then((s) => s.docs.map((d) => ({ id: d.id, ...d.data() })));

          render(items, me);
        } catch (err) {
          console.error(err);
          ui.tbody.innerHTML = `<tr><td colspan="9">Error al cargar calificaciones.</td></tr>`;
          ui.msg.textContent = "Inténtalo más tarde.";
        }
      });
    </script>
  </body>
</html>
