<!DOCTYPE html>
<html lang="es" data-layout="global">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calificaciones · Plataforma QS</title>
  <link rel="stylesheet" href="css/layout.css"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .qsc-card { background: #fff; border:1px solid #e5e7eb; border-radius: 14px; padding: 16px; }
    .qsc-pill { border:1px solid #d1d5db; border-radius: 999px; padding: 2px 10px; font-weight:600; }
    .qsc-muted { color:#6b7280; font-size: .9rem; }
    .qsc-grid { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 10px; }
    .qsc-table { width: 100%; border-collapse: collapse; }
    .qsc-table th, .qsc-table td { border-bottom: 1px solid #e5e7eb; padding: 8px; text-align:left; }
  </style>
</head>
<body>
  <!-- Nav y footer se inyectan con layout.js -->
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <header class="rounded-2xl p-8 mb-6" style="background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff;">
      <h1 class="text-3xl font-bold">Sistema de Calificaciones</h1>
      <p class="opacity-90">Calidad de Software · Gestión por unidades</p>
    </header>

    <section id="calificaciones-root" data-grupo="calidad-2025"></section>
  </div>

  <!-- Config Firebase: usa la que ya tienes declarada globalmente -->
  <script>
    if (!window.firebaseConfig) {
      console.warn('No hay window.firebaseConfig. Define tu config antes de usar la página.');
    }
  </script>

  <!-- Adaptación basada en calificaciones-backend.js -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const root = document.getElementById('calificaciones-root');
    const courseId = (root?.dataset?.grupo || 'calidad-2025').trim();

    // UI plantilla minimal respetando diseño general
    root.innerHTML = `
      <div class="qsc-card mb-6">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <div class="flex items-center gap-3">
            <h2 class="text-xl font-semibold">Panel</h2>
            <span id="roleTag" class="qsc-pill">No autenticado</span>
            <span id="userInfo" class="qsc-muted"></span>
          </div>
          <div class="flex items-center gap-2">
            <label for="courseId" class="qsc-muted">courseId</label>
            <input id="courseId" class="px-3 py-2 border rounded-lg w-44" value="${courseId}"/>
            <button id="btnInit" class="px-3 py-2 border rounded-lg">Inicializar</button>
            <button id="btnLogin" class="px-3 py-2 border rounded-lg">Entrar</button>
            <button id="btnLogout" class="px-3 py-2 border rounded-lg">Salir</button>
          </div>
        </div>
        <div class="qsc-muted mt-2">La Config Firebase se toma de <code>window.firebaseConfig</code>.</div>
      </div>

      <div id="panelStudent" class="qsc-card mb-6" style="display:none">
        <h3 class="text-lg font-semibold mb-1">Mi vista de alumno</h3>
        <div class="qsc-muted mb-3">Promedios por unidad y promedio final.</div>
        <div id="studSummary" class="qsc-grid mb-4"></div>
        <div id="studTables"></div>
      </div>

      <div id="panelTeacher" class="qsc-card" style="display:none">
        <h3 class="text-lg font-semibold mb-1">Panel docente</h3>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
          <div>
            <label class="qsc-muted">Alumno</label>
            <select id="studentSelect" class="px-3 py-2 border rounded-lg w-full"></select>
          </div>
          <div>
            <label class="qsc-muted">Participación U1/U2/U3 (%)</label>
            <div class="flex gap-2">
              <input id="pU1" class="px-3 py-2 border rounded-lg w-20" placeholder="0-100"/>
              <input id="pU2" class="px-3 py-2 border rounded-lg w-20" placeholder="0-100"/>
              <input id="pU3" class="px-3 py-2 border rounded-lg w-20" placeholder="0-100"/>
            </div>
          </div>
          <div class="flex items-end gap-2">
            <button id="btnLoadStudent" class="px-3 py-2 border rounded-lg">Cargar alumno</button>
            <button id="btnSaveAll" class="px-3 py-2 border rounded-lg">Guardar todo</button>
          </div>
        </div>
        <div id="teachSummary" class="flex gap-3 mb-3"></div>
        <div id="teachTables"></div>
      </div>

      <div id="statusWrap" class="fixed bottom-4 right-4 bg-white border rounded-xl shadow px-4 py-2">
        <div class="qsc-muted" id="status">Listo.</div>
        <div class="w-64 h-2 bg-gray-200 rounded-full overflow-hidden mt-1">
          <div id="bar" class="h-2" style="background: linear-gradient(90deg,#5fb0ff,#9f78ff); width:0%"></div>
        </div>
      </div>
    `;

    const $ = (id) => root.querySelector('#' + id);
    const qs = (sel) => root.querySelector(sel);
    const show = (sel, flag) => { qs(sel).style.display = flag ? 'block' : 'none'; };
    function setStatus(msg, pct) {
      $('status').textContent = msg;
      if (typeof pct === 'number') $('bar').style.width = Math.max(0, Math.min(100, pct)) + '%';
    }
    function coursePath() { return `courses/${$('courseId').value.trim()}`; }

    // Firebase init + auth
    let app, auth, db, me = null, myRole = 'student';
    $('btnInit').onclick = async () => {
      const cfg = window.firebaseConfig || null;
      if (!cfg?.apiKey) { setStatus('Falta window.firebaseConfig.', 0); return; }
      app = getApps().length ? getApp() : initializeApp(cfg);
      auth = getAuth(app);
      db = getFirestore(app);
      setStatus('SDK listo.', 5);
      onAuthStateChanged(auth, async (u) => {
        me = u || null;
        $('userInfo').textContent = me ? (me.email || me.uid) : '';
        $('roleTag').textContent = me ? 'AUTENTICADO' : 'NO AUTENTICADO';
        await routeByRole();
      });
    };
    $('btnLogin').onclick = async () => { const provider = new GoogleAuthProvider(); await signInWithPopup(auth, provider); };
    $('btnLogout').onclick = async () => { await signOut(auth); };

    async function routeByRole() {
      if (!me) { show('#panelTeacher', false); show('#panelStudent', false); return; }
      const msnap = await getDoc(doc(db, `${coursePath()}/members/${me.uid}`));
      myRole = msnap.exists() ? (msnap.data().role || 'student') : 'student';
      $('roleTag').textContent = myRole.toUpperCase();
      if (myRole === 'teacher') {
        show('#panelTeacher', true); show('#panelStudent', false);
        await populateStudentList();
      } else {
        show('#panelTeacher', false); show('#panelStudent', true);
        await loadStudentView(me.uid);
      }
    }

    // Datos
    async function loadItems() {
      setStatus('Cargando ítems...', 20);
      const snap = await getDocs(collection(db, `${coursePath()}/gradeItems`));
      const items = [];
      snap.forEach(d => items.push({ id: d.id, ...d.data() }));
      items.sort((a,b)=> a.unit - b.unit || (a.order||0)-(b.order||0) || a.id.localeCompare(b.id));
      return items;
    }
    async function loadStudentData(studentId) {
      setStatus('Cargando calificaciones...', 40);
      const gradesSnap = await getDocs(query(collection(db, `${coursePath()}/grades`), where('studentId','==',studentId)));
      const gradesMap = {};
      gradesSnap.forEach(d => { const g = d.data(); gradesMap[g.itemId] = g; });
      const participation = {};
      for (const u of [1,2,3]) {
        const psnap = await getDoc(doc(db, `${coursePath()}/unitParticipation/${studentId}_U${u}`));
        participation[String(u)] = psnap.exists() ? (psnap.data().score ?? null) : null;
      }
      return { gradesMap, participation };
    }
    function avgList(list){ if(!list.length) return null; const s=list.reduce((a,b)=>a+b.s,0), m=list.reduce((a,b)=>a+b.m,0); if(m<=0) return null; return Math.max(0, Math.min(100, (s/m)*100)); }
    function compute(items, gradesMap, participation){
      const B={1:{asg:[],act:[],ex:[],pro:[],part:participation['1']??null},2:{asg:[],act:[],ex:[],pro:[],part:participation['2']??null},3:{asg:[],act:[],ex:[],pro:[],part:participation['3']??null}};
      for(const it of items){
        const g = gradesMap[it.id];
        if (g && g.score != null) {
          const e = { s:g.score, m:g.maxPoints ?? it.maxPoints };
          if(it.category==='actividad') B[it.unit].act.push(e);
          else if(it.category==='asignacion') B[it.unit].asg.push(e);
          else if(it.category==='examen') B[it.unit].ex.push(e);
          else if(it.category==='proyecto') B[it.unit].pro.push(e);
        }
      }
      const W={P:.1, Agn:.2, Act:.25, ExPro:.45}, U={};
      for(const u of [1,2,3]){
        const P=B[u].part, Agn=avgList(B[u].asg), Act=avgList(B[u].act), Ex=avgList(B[u].ex), Pro=avgList(B[u].pro);
        const EP = u===3 ? Pro : Ex;
        const parts = [P==null?null:W.P*P, Agn==null?null:W.Agn*Agn, Act==null?null:W.Act*Act, EP==null?null:W.ExPro*EP];
        U[u] = parts.some(x=>x===null) ? null : parts.reduce((a,b)=>a+b,0);
      }
      const final = (U[1]==null||U[2]==null||U[3]==null) ? null : (U[1]*.3 + U[2]*.3 + U[3]*.4);
      return { U, final };
    }
    function fmtPct(n){ return n==null?'—':n.toFixed(2)+'%'; }
    function esc(n){ if(n==null) return '—'; if(n>=90) return 'A'; if(n>=80) return 'B'; if(n>=70) return 'C'; if(n>=60) return 'D'; return 'F'; }
    function fmtDate(ts){ try{ const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : null); return d? d.toLocaleDateString() : '—'; } catch(e){ return '—'; } }

    function renderUnitTables(items, gradesMap, editable){
      const byU = {1:[],2:[],3:[]};
      for(const it of items) byU[it.unit]?.push(it);
      const block = (title, rows)=>`
        <div class="overflow-x-auto">
          <table class="qsc-table w-full">
            <thead><tr>
              <th>Ítem</th><th>Categoría</th><th>Unidad</th><th>Puntos</th><th>Máx</th><th>Peso global</th><th>Aporta</th><th>Logro</th><th>Fecha</th>
            </tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
      const renderRows = (u) => {
        const list = byU[u] || [];
        if(!list.length) return '<tr><td colspan="9" class="qsc-muted">Sin ítems</td></tr>';
        return list.map(it=>{
          const g = gradesMap[it.id];
          const pts = g?.score ?? '';
          const max = it.maxPoints ?? g?.maxPoints ?? '';
          const pond = it.weightGlobal ?? (it.weight || 0);
          const aporta = (pts!=='' && max) ? (pond * (pts/max)) : null;
          const puntPct = (pts!=='' && max) ? (100*(pts/max)) : null;
          const tipo = it.category || '—';
          const unidad = it.unit || u;
          const input = editable ? `<input data-grade-input="1" data-item="${it.id}" type="number" class="px-2 py-1 border rounded w-24 text-center" min="0" step="0.1" value="${pts}"/>` : (pts===''?'—':pts);
          return `<tr>
            <td>${it.nombre || it.title || 'Actividad'}</td>
            <td>${tipo}</td>
            <td>${unidad}</td>
            <td>${input}</td>
            <td>${max}</td>
            <td>${pond}%</td>
            <td>${fmtPct(aporta)}</td>
            <td>${fmtPct(puntPct)} · ${esc(puntPct)}</td>
            <td>${fmtDate(it.fecha)}</td>
          </tr>`;
        }).join('');
      };
      return block('Unidad '+1, renderRows(1)) + block('Unidad '+2, renderRows(2)) + block('Unidad '+3, renderRows(3));
    }

    async function populateStudentList(){
      const sel = $('studentSelect'); sel.innerHTML='';
      const snap = await getDocs(query(collection(db, `${coursePath()}/members`), where('role','==','student')));
      snap.forEach(d=>{
        const m = d.data(); const o = document.createElement('option');
        o.value = d.id; o.textContent = m.displayName ? `${m.displayName} · ${m.email || d.id}` : m.email || d.id;
        sel.appendChild(o);
      });
    }
    async function loadStudentView(studentId){
      const items = await loadItems();
      const { gradesMap, participation } = await loadStudentData(studentId);
      const { U, final } = compute(items, gradesMap, participation);
      qs('#studSummary').innerHTML = `
        <div><div class="qsc-muted">Unidad 1</div><div class="qsc-pill">${fmtPct(U[1])}</div></div>
        <div><div class="qsc-muted">Unidad 2</div><div class="qsc-pill">${fmtPct(U[2])}</div></div>
        <div><div class="qsc-muted">Unidad 3</div><div class="qsc-pill">${fmtPct(U[3])}</div></div>
        <div><div class="qsc-muted">Promedio final</div><div class="qsc-pill" style="border-color:#34d399;color:#065f46">${fmtPct(final)}</div></div>`;
      qs('#studTables').innerHTML = renderUnitTables(items, gradesMap, false);
      setStatus('Alumno cargado.', 100);
    }

    async function saveParticipation(studentId, unit, score){
      const s = score==='' ? null : Math.max(0, Math.min(100, Number(score)));
      await setDoc(doc(db, `${coursePath()}/unitParticipation/${studentId}_U${unit}`), { studentId, unit, score: s, updatedAt: new Date() }, { merge: true });
      setStatus(`Participación U${unit} guardada.`, 85);
    }
    async function saveGrade(studentId, itemId, score){
      const itSnap = await getDoc(doc(db, `${coursePath()}/gradeItems/${itemId}`));
      if(!itSnap.exists()){ setStatus(`Item ${itemId} no existe`, 10); return; }
      const it = itSnap.data();
      await setDoc(doc(db, `${coursePath()}/grades/${studentId}_${itemId}`), {
        courseId: $('courseId').value.trim(), studentId, itemId,
        unit: it.unit, category: it.category, score: score===null?null:Number(score),
        maxPoints: it.maxPoints, gradedAt: new Date()
      }, { merge: true });
      setStatus(`Guardado ${itemId}.`, 75);
    }

    // Docente: carga y edición
    $('btnLoadStudent').onclick = async () => {
      const studentId = $('studentSelect').value;
      if(!studentId){ setStatus('Selecciona un alumno.', 0); return; }
      await loadTeacherFor(studentId);
    };
    async function loadTeacherFor(studentId){
      const items = await loadItems();
      const { gradesMap, participation } = await loadStudentData(studentId);
      $('pU1').value = participation['1'] ?? '';
      $('pU2').value = participation['2'] ?? '';
      $('pU3').value = participation['3'] ?? '';
      $('pU1').onblur = () => saveParticipation(studentId,1,$('pU1').value);
      $('pU2').onblur = () => saveParticipation(studentId,2,$('pU2').value);
      $('pU3').onblur = () => saveParticipation(studentId,3,$('pU3').value);
      qs('#teachTables').innerHTML = renderUnitTables(items, gradesMap, true);
      root.querySelectorAll("[data-grade-input='1']").forEach(inp=>{
        inp.addEventListener('blur', async (e)=>{
          const val = e.target.value === '' ? null : Number(e.target.value);
          const itemId = e.target.getAttribute('data-item');
          await saveGrade(studentId, itemId, val);
        });
      });
      const { U, final } = compute(items, gradesMap, participation);
      qs('#teachSummary').innerHTML = `
        <div><div class="qsc-muted">U1</div><div class="qsc-pill">${fmtPct(U[1])}</div></div>
        <div><div class="qsc-muted">U2</div><div class="qsc-pill">${fmtPct(U[2])}</div></div>
        <div><div class="qsc-muted">U3</div><div class="qsc-pill">${fmtPct(U[3])}</div></div>
        <div><div class="qsc-muted">Final</div><div class="qsc-pill">${fmtPct(final)}</div></div>`;
      setStatus('Alumno cargado (docente).', 100);
    }
    $('btnSaveAll').onclick = () => setStatus('Cambios guardados si editaste campos. Guardado por campo es inmediato.', 100);

    // Auto init
    $('btnInit').click();
  </script>

  <script defer src="js/layout.js"></script>
</body>
</html>
