<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calificaciones · Plataforma QS</title>

    <!-- Estilos acotados a esta vista. No toca tu layout global. -->
    <style>
      :root {
        --qs-primary: #667eea;
      }
      #mi-progreso {
        max-width: 1100px;
        margin: 80px auto 40px;
        padding: 0 16px;
      }
      #mi-progreso .titulo-seccion {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0 0 12px;
      }
      #mi-progreso .mi-resumen {
        padding: 12px;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.03);
      }
      #mi-progreso .mi-kpis {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }
      #mi-progreso .mi-kpi {
        min-width: 140px;
        padding: 10px 12px;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.05);
        text-align: center;
      }
      #mi-progreso .mi-kpi span {
        display: block;
        font-weight: 700;
        font-size: 1.25rem;
      }
      #mi-progreso .mi-kpi small {
        display: block;
        opacity: 0.75;
      }
      #mi-progreso .mi-bar {
        height: 10px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }
      #mi-progreso .mi-bar-fill {
        height: 100%;
        background: var(--qs-primary);
        width: 0%;
        transition: width 0.4s ease;
      }
      #mi-progreso .tabla-wrapper {
        margin-top: 14px;
        overflow-x: auto;
      }
      #mi-progreso table {
        width: 100%;
        border-collapse: collapse;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(4px);
      }
      #mi-progreso thead th {
        text-align: left;
        font-weight: 700;
        font-size: 0.95rem;
        padding: 10px;
        border-bottom: 2px solid rgba(0, 0, 0, 0.1);
        white-space: nowrap;
      }
      #mi-progreso tbody td {
        padding: 10px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        font-size: 0.95rem;
        vertical-align: top;
      }
      #mi-progreso .mi-msg {
        margin-top: 8px;
        opacity: 0.85;
        font-size: 0.9rem;
      }
      #mi-progreso .muted {
        opacity: 0.7;
      }
    </style>
  </head>
  <body>
    <!-- Contenedor. Si ya tienes header/nav/footer fijos, esto se integra al centro. -->
    <main id="mi-progreso">
      <h2 class="titulo-seccion">Mis calificaciones</h2>

      <div id="mi-resumen" class="mi-resumen">
        <div class="mi-kpis">
          <div class="mi-kpi">
            <span id="kpi-total">--%</span><small>Total</small>
          </div>
          <div class="mi-kpi">
            <span id="kpi-items">0</span><small>Actividades</small>
          </div>
          <div class="mi-kpi">
            <span id="kpi-pond">0%</span><small>Peso cubierto</small>
          </div>
        </div>
        <div class="mi-bar">
          <div id="mi-bar-fill" class="mi-bar-fill"></div>
        </div>
      </div>

      <div class="tabla-wrapper">
        <table id="mi-tabla" class="tabla">
          <thead>
            <tr>
              <th>Actividad</th>
              <th>Puntos</th>
              <th>Máx</th>
              <th>Ponderación</th>
              <th>Aporta al final</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody id="mi-tbody">
            <tr>
              <td class="muted" colspan="6">Cargando…</td>
            </tr>
          </tbody>
        </table>
      </div>

      <p id="mi-msg" class="mi-msg"></p>
    </main>

    <!-- Config Firebase en global para evitar “firebaseConfig is not defined” -->
    <script>
      window.firebaseConfig = {
        apiKey: "AIzaSyBDip2OjSOUZrr3iiIle2Klodify9LaLe8",
        authDomain: "calidad-de-software-v2.firebaseapp.com",
        projectId: "calidad-de-software-v2",
        storageBucket: "calidad-de-software-v2.firebasestorage.app",
        messagingSenderId: "220818066383",
        appId: "1:220818066383:web:0c2119f470a5f9711b60ba",
      };
    </script>

    <!-- SDK Firebase (módulos). Sin archivos locales, sin Cloudflare. -->
    <script type="module">
      import {
        initializeApp,
        getApps,
        getApp,
      } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        collection,
        getDocs,
        query,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

      // Init seguro (evita doble init si tu layout ya inicializó Firebase)
      const app = getApps().length
        ? getApp()
        : initializeApp(window.firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Grupo vía URL ?grupo=calidad-2025
      const params = new URLSearchParams(location.search);
      const GRUPO_ID = params.get("grupo") || "calidad-2025";

      // Selectores
      const el = {
        tbody: document.getElementById("mi-tbody"),
        msg: document.getElementById("mi-msg"),
        kpiTotal: document.getElementById("kpi-total"),
        kpiItems: document.getElementById("kpi-items"),
        kpiPond: document.getElementById("kpi-pond"),
        barFill: document.getElementById("mi-bar-fill"),
      };

      // Color de barra toma tu --primary si existe
      const primaryFromTheme = getComputedStyle(document.body)
        .getPropertyValue("--primary")
        ?.trim();
      el.barFill.style.background =
        primaryFromTheme ||
        getComputedStyle(document.documentElement).getPropertyValue(
          "--qs-primary"
        ) ||
        "#667eea";

      // Utils
      const clampPct = (n) => Math.max(0, Math.min(100, Number(n) || 0));
      const fmtPct = (n) => `${clampPct(n).toFixed(2)}%`;
      const fmtDate = (ts) => {
        if (!ts) return "";
        const d = ts?.seconds ? new Date(ts.seconds * 1000) : new Date(ts);
        return isNaN(d.getTime()) ? "" : d.toLocaleDateString("es-MX");
      };

      // Cálculo de resumen
      function resumenDeItems(items) {
        let porcentaje = 0;
        let pondSum = 0;
        for (const it of items) {
          const max = Number(it.maxPuntos) || 0;
          const pts = Number(it.puntos) || 0;
          const pond = Number(it.ponderacion) || 0; // % de la calificación final
          if (max > 0) porcentaje += (pts / max) * pond;
          pondSum += pond;
        }
        return { porcentaje: clampPct(porcentaje), pondSum: clampPct(pondSum) };
      }

      async function obtenerMisItems(uid) {
        const ref = collection(
          db,
          "grupos",
          GRUPO_ID,
          "calificaciones",
          uid,
          "items"
        );
        const snap = await getDocs(query(ref, orderBy("fecha", "asc")));
        return snap.docs.map((d) => ({ id: d.id, ...d.data() }));
      }

      async function pintarAlumno(uid) {
        // Datos base
        const userDoc = await getDoc(doc(db, "users", uid));
        const me = userDoc.exists() ? userDoc.data() : {};

        // Items
        const items = await obtenerMisItems(uid);
        const { porcentaje, pondSum } = resumenDeItems(items);

        // KPIs
        el.kpiTotal.textContent = fmtPct(porcentaje);
        el.kpiItems.textContent = items.length;
        el.kpiPond.textContent = fmtPct(pondSum);
        el.barFill.style.width = fmtPct(porcentaje);

        // Tabla
        el.tbody.innerHTML = "";
        if (items.length === 0) {
          el.tbody.innerHTML = `<tr><td colspan="6" class="muted">Sin actividades registradas aún.</td></tr>`;
        } else {
          for (const it of items) {
            const max = Number(it.maxPuntos) || 0;
            const pts = Number(it.puntos) || 0;
            const pond = Number(it.ponderacion) || 0;
            const aporta = max > 0 ? (pts / max) * pond : 0;
            el.tbody.insertAdjacentHTML(
              "beforeend",
              `
            <tr>
              <td>${it.nombre || "Actividad"}</td>
              <td>${pts}</td>
              <td>${max}</td>
              <td>${pond}%</td>
              <td>${fmtPct(aporta)}</td>
              <td>${fmtDate(it.fecha)}</td>
            </tr>
          `
            );
          }
        }

        // Pie de estado
        el.msg.textContent = me?.nombre ? `Alumno: ${me.nombre}` : "";
      }

      // Auth gate
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          el.msg.textContent =
            "Inicia sesión con tu correo @potros para ver tu progreso.";
          return;
        }
        try {
          await pintarAlumno(user.uid);
        } catch (err) {
          console.error(err);
          el.tbody.innerHTML = `<tr><td colspan="6">Error al cargar calificaciones.</td></tr>`;
          el.msg.textContent = "Inténtalo más tarde.";
        }
      });
    </script>
  </body>
</html>
