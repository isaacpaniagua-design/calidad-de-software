﻿<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Gestión de Calificaciones - Calidad de Software</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .card-shadow {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }
      .progress-bar {
        transition: width 0.3s ease-in-out;
      }
    </style>

    <!-- Estilos QS (mejor contraste tablas) -->
    <style id="qs-calificaciones-css">
      #calificaciones-root .qsc-wrap {
        max-width: 1100px;
        margin: 24px auto;
        padding: 0 16px;
      }
      #calificaciones-root .qsc-title {
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0 0 12px;
      }
      #calificaciones-root .qsc-kpis {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }
      #calificaciones-root .qsc-kpi {
        min-width: 140px;
        padding: 10px 12px;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.05);
        text-align: center;
      }
      #calificaciones-root .qsc-kpi span {
        display: block;
        font-weight: 700;
        font-size: 1.1rem;
      }
      #calificaciones-root .qsc-kpi small {
        display: block;
        opacity: 0.75;
      }
      #calificaciones-root .qsc-bar {
        height: 10px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }
      #calificaciones-root .qsc-bar-fill {
        height: 100%;
        background: var(--primary, #667eea);
        width: 0%;
        transition: width 0.4s ease;
      }
      #calificaciones-root .qsc-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 14px;
        background: rgba(255, 255, 255, 0.85);
      }
      #calificaciones-root .qsc-table th {
        padding: 10px;
        text-align: left;
        border-bottom: 2px solid rgba(0, 0, 0, 0.1);
        white-space: nowrap;
        font-weight: 700;
      }
      #calificaciones-root .qsc-table td {
        padding: 10px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      }
      #calificaciones-root .qsc-msg {
        margin-top: 8px;
        opacity: 0.85;
        font-size: 0.9rem;
      }
      #calificaciones-root .qsc-muted {
        opacity: 0.7;
      }

      .qsc-table-wrap {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        overflow: auto;
      }
      .qsc-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.95rem;
      }
      .qsc-table thead th {
        position: sticky;
        top: 0;
        z-index: 1;
        background: rgba(255, 255, 255, 0.96);
        backdrop-filter: saturate(120%) blur(6px);
        color: #111827;
        font-weight: 700;
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
      }
      .qsc-table tbody td {
        color: #374151;
        padding: 10px 12px;
        border-bottom: 1px solid #f3f4f6;
      }
      .qsc-table tbody tr:nth-child(odd) {
        background: #fafafa;
      }
      .qsc-table tbody tr:nth-child(even) {
        background: #ffffff;
      }
      .qsc-table tbody tr:hover {
        background: #eef2ff;
      }
      .qsc-table th:nth-child(4),
      .qsc-table td:nth-child(4),
      .qsc-table th:nth-child(5),
      .qsc-table td:nth-child(5),
      .qsc-table th:nth-child(7),
      .qsc-table td:nth-child(7),
      .qsc-table th:nth-child(8),
      .qsc-table td:nth-child(8) {
        text-align: right;
        font-variant-numeric: tabular-nums;
      }
      .qsc-table th:nth-child(9),
      .qsc-table td:nth-child(9),
      .qsc-table th:nth-child(8),
      .qsc-table td:nth-child(8) {
        text-align: center;
      }
      .qsc-compact .qsc-table {
        font-size: 0.9rem;
      }
      .qsc-compact .qsc-table thead th {
        padding: 10px;
      }
      .qsc-compact .qsc-table tbody td {
        padding: 8px 10px;
      }
      @media (prefers-color-scheme: dark) {
        .qsc-table-wrap {
          background: #0b1220;
          border: 1px solid #1f2937;
          box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
        }
        .qsc-table thead th {
          background: rgba(17, 24, 39, 0.9);
          color: #e5e7eb;
          border-bottom: 1px solid #1f2937;
        }
        .qsc-table tbody td {
          color: #cbd5e1;
          border-bottom: 1px solid #111827;
        }
        .qsc-table tbody tr:nth-child(odd) {
          background: #0f172a;
        }
        .qsc-table tbody tr:nth-child(even) {
          background: #0b1220;
        }
        .qsc-table tbody tr:hover {
          background: #172554;
        }
      }
    </style>

    <!-- Firebase config (global) -->
    <script>
      window.firebaseConfig = {
        apiKey: "AIzaSyBDip2OjSOUZrr3iiIle2Klodify9LaLe8",
        authDomain: "calidad-de-software-v2.firebaseapp.com",
        projectId: "calidad-de-software-v2",
        storageBucket: "calidad-de-software-v2.firebasestorage.app",
        messagingSenderId: "220818066383",
        appId: "1:220818066383:web:0c2119f470a5f9711b60ba",
      };
    </script>
  </head>

  <body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="gradient-bg text-white py-8">
      <div class="container mx-auto px-6">
        <h1 class="text-3xl font-bold mb-2">
          Sistema de Gestión de Calificaciones
        </h1>
        <p class="text-blue-100">Calidad de Software - Gestión por Unidades</p>
      </div>
    </div>

    <!-- Contenedor renderizado por el backend (vista alumno “Mis calificaciones”) -->
    <div id="calificaciones-root" data-grupo="calidad-2025"></div>

    <div class="container mx-auto px-6 py-8">
      <!-- Student Info -->
      <div class="bg-white rounded-lg card-shadow p-6 mb-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 items-end">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Seleccionar Estudiante</label
            >
            <select
              id="studentSelect"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">-- Seleccione un estudiante --</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Nombre Completo</label
            >
            <input
              type="text"
              id="studentName"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50"
              readonly
              placeholder="Nombre del estudiante"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Correo Electrónico</label
            >
            <input
              type="email"
              id="studentEmail"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50"
              readonly
              placeholder="Correo del estudiante"
            />
          </div>
        </div>
        <div class="mt-4">
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >Código del Estudiante</label
          >
          <input
            type="text"
            id="studentId"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50"
            readonly
            placeholder="Código del estudiante"
          />
        </div>
      </div>

      <!-- Overall Progress -->
      <div class="bg-white rounded-lg card-shadow p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">
          Progreso General del Curso
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div class="text-center">
            <div class="text-3xl font-bold text-blue-600" id="finalGrade">
              0.0
            </div>
            <div class="text-sm text-gray-600">Calificación Final</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-green-600" id="unit1Grade">
              0.0
            </div>
            <div class="text-sm text-gray-600">Unidad I (30%)</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-yellow-600" id="unit2Grade">
              0.0
            </div>
            <div class="text-sm text-gray-600">Unidad II (30%)</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-purple-600" id="unit3Grade">
              0.0
            </div>
            <div class="text-sm text-gray-600">Unidad III (40%)</div>
          </div>
        </div>
        <div class="mt-6">
          <div class="flex justify-between text-sm text-gray-600 mb-2">
            <span>Progreso del Curso</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div
              class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full progress-bar"
              id="progressBar"
              style="width: 0%"
            ></div>
          </div>
        </div>
      </div>

      <!-- Units Tabs -->
      <!-- (Se conserva todo tu contenido de unidades y rúbrica tal como lo tenías) -->
      <!-- ... contenido de unidades (unit1, unit2, unit3, project) sin cambios ... -->

      <!-- Action Buttons -->
      <div class="mt-8 flex flex-wrap gap-4 justify-center">
        <button
          id="calculateBtn"
          class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium transition-colors"
        >
          Calcular Calificaciones
        </button>
        <button
          id="clearBtn"
          class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-lg font-medium transition-colors"
        >
          Limpiar Todo
        </button>
        <button
          id="exportBtn"
          class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-medium transition-colors"
        >
          Exportar Reporte
        </button>
      </div>

      <!-- Results Summary -->
      <div
        id="resultsSummary"
        class="mt-8 bg-white rounded-lg card-shadow p-6 hidden"
      >
        <h3 class="text-xl font-semibold text-gray-800 mb-4">
          Resumen de Calificaciones
        </h3>
        <div id="summaryContent" class="space-y-3"></div>
      </div>
    </div>

    <!-- Lógica local de tu página (dropdown, cálculo local, export, etc.) -->
    <script>
      const students = [
        /* … tus alumnos exactamente como en la versión actual … */
      ];

      function populateStudentDropdown() {
        const select = document.getElementById("studentSelect");
        students.forEach((student) => {
          const option = document.createElement("option");
          option.value = student.id;
          option.textContent = `${student.id} - ${student.name}`;
          select.appendChild(option);
        });
      }

      document
        .getElementById("studentSelect")
        .addEventListener("change", function () {
          const selectedId = this.value;
          const student = students.find((s) => s.id === selectedId);

          if (student) {
            document.getElementById("studentId").value = student.id;
            document.getElementById("studentName").value = student.name;
            document.getElementById("studentEmail").value = student.email;
            loadStudentGrades(selectedId);
          } else {
            document.getElementById("studentId").value = "";
            document.getElementById("studentName").value = "";
            document.getElementById("studentEmail").value = "";
            clearAllGrades();
          }
        });

      function saveStudentGrades(studentId) {
        if (!studentId) return;
        const grades = {};
        document.querySelectorAll(".grade-input").forEach((input, index) => {
          grades[`regular_${index}`] = input.value;
        });
        document
          .querySelectorAll(".project-grade-input")
          .forEach((input, index) => {
            grades[`project_${index}`] = input.value;
          });
        localStorage.setItem(`grades_${studentId}`, JSON.stringify(grades));
      }

      function loadStudentGrades(studentId) {
        const saved = localStorage.getItem(`grades_${studentId}`);
        if (saved) {
          const grades = JSON.parse(saved);
          document.querySelectorAll(".grade-input").forEach((input, i) => {
            input.value = grades[`regular_${i}`] || "";
          });
          document
            .querySelectorAll(".project-grade-input")
            .forEach((input, i) => {
              input.value = grades[`project_${i}`] || "";
            });
          calculateProjectGrades();
          calculateGrades();
        } else {
          clearAllGrades();
        }
      }

      function clearAllGrades() {
        document
          .querySelectorAll(".grade-input")
          .forEach((i) => (i.value = ""));
        document
          .querySelectorAll(".project-grade-input")
          .forEach((i) => (i.value = ""));
        calculateProjectGrades();
        calculateGrades();
      }

      function calculateProjectGrades() {
        const inputs = document.querySelectorAll(
          "#project .project-grade-input"
        );
        let p1 = 0,
          p2 = 0,
          p34 = 0,
          pres = 0;
        for (let i = 0; i < 3; i++) {
          const g = +inputs[i].value || 0,
            w = +inputs[i].dataset.weight;
          p1 += (g * w) / 4;
        }
        for (let i = 3; i < 6; i++) {
          const g = +inputs[i].value || 0,
            w = +inputs[i].dataset.weight;
          p2 += (g * w) / 6;
        }
        for (let i = 6; i < 10; i++) {
          const g = +inputs[i].value || 0,
            w = +inputs[i].dataset.weight;
          p34 += (g * w) / 6;
        }
        for (let i = 10; i < 15; i++) {
          const g = +inputs[i].value || 0,
            w = +inputs[i].dataset.weight;
          pres += (g * w) / 8;
        }
        document.getElementById("phase1Grade").textContent = p1.toFixed(1);
        document.getElementById("phase2Grade").textContent = p2.toFixed(1);
        document.getElementById("phase34Grade").textContent = p34.toFixed(1);
        document.getElementById("presentationGrade").textContent =
          pres.toFixed(1);
        document.getElementById("projectTotalGrade").textContent = (
          p1 +
          p2 +
          p34 +
          pres
        ).toFixed(1);
      }

      document.querySelectorAll(".grade-input").forEach((input) => {
        input.addEventListener("input", () => {
          calculateGrades();
          const id = document.getElementById("studentId").value;
          if (id) saveStudentGrades(id);
        });
      });
      document.querySelectorAll(".project-grade-input").forEach((input) => {
        input.addEventListener("input", () => {
          calculateProjectGrades();
          calculateGrades();
          const id = document.getElementById("studentId").value;
          if (id) saveStudentGrades(id);
        });
      });

      document.querySelectorAll(".tab-button").forEach((button) => {
        button.addEventListener("click", () => {
          const unit = button.dataset.unit;
          document.querySelectorAll(".tab-button").forEach((btn) => {
            btn.classList.remove(
              "bg-blue-50",
              "text-blue-600",
              "border-b-2",
              "border-blue-600"
            );
            btn.classList.add("text-gray-600");
          });
          button.classList.add(
            "bg-blue-50",
            "text-blue-600",
            "border-b-2",
            "border-blue-600"
          );
          button.classList.remove("text-gray-600");
          document
            .querySelectorAll(".unit-content")
            .forEach((c) => c.classList.add("hidden"));
          if (unit === "project")
            document.getElementById("project").classList.remove("hidden");
          else
            document.getElementById(`unit${unit}`).classList.remove("hidden");
        });
      });

      function calculateGrades() {
        let u1 = 0,
          u2 = 0,
          u3 = 0;
        document.querySelectorAll("#unit1 .grade-input").forEach((i) => {
          const g = +i.value || 0,
            w = +i.dataset.weight;
          u1 += (g * w) / 30;
        });
        document.querySelectorAll("#unit2 .grade-input").forEach((i) => {
          const g = +i.value || 0,
            w = +i.dataset.weight;
          u2 += (g * w) / 30;
        });
        document.querySelectorAll("#unit3 .grade-input").forEach((i) => {
          const g = +i.value || 0,
            w = +i.dataset.weight;
          u3 += (g * w) / 40;
        });
        const total = u1 + u2 + u3;
        document.getElementById("finalGrade").textContent = total.toFixed(1);
        document.getElementById("unit1Grade").textContent = (
          (u1 * 30) /
          30
        ).toFixed(1);
        document.getElementById("unit2Grade").textContent = (
          (u2 * 30) /
          30
        ).toFixed(1);
        document.getElementById("unit3Grade").textContent = (
          (u3 * 40) /
          40
        ).toFixed(1);
        const pct = Math.min((total / 5) * 100, 100);
        document.getElementById("progressPercent").textContent = `${pct.toFixed(
          0
        )}%`;
        const bar = document.getElementById("progressBar");
        bar.style.width = `${pct}%`;
        bar.className = "h-3 rounded-full progress-bar";
        if (total >= 4.5)
          bar.classList.add(
            "bg-gradient-to-r",
            "from-green-500",
            "to-green-600"
          );
        else if (total >= 3.5)
          bar.classList.add(
            "bg-gradient-to-r",
            "from-yellow-500",
            "to-yellow-600"
          );
        else if (total >= 3.0)
          bar.classList.add(
            "bg-gradient-to-r",
            "from-orange-500",
            "to-orange-600"
          );
        else
          bar.classList.add("bg-gradient-to-r", "from-red-500", "to-red-600");
      }

      document.getElementById("calculateBtn").addEventListener("click", () => {
        calculateGrades();
        showSummary();
      });
      document.getElementById("clearBtn").addEventListener("click", () => {
        const id = document.getElementById("studentId").value;
        if (
          id &&
          confirm(
            "¿Está seguro de limpiar todas las calificaciones de este estudiante?"
          )
        ) {
          localStorage.removeItem(`grades_${id}`);
          clearAllGrades();
          document.getElementById("resultsSummary").classList.add("hidden");
        } else if (!id) {
          document.getElementById("studentSelect").value = "";
          document.getElementById("studentName").value = "";
          document.getElementById("studentId").value = "";
          document.getElementById("studentEmail").value = "";
          clearAllGrades();
          document.getElementById("resultsSummary").classList.add("hidden");
        }
      });
      document.getElementById("exportBtn").addEventListener("click", () => {
        const name =
          document.getElementById("studentName").value || "Estudiante";
        const id = document.getElementById("studentId").value || "N/A";
        const final = document.getElementById("finalGrade").textContent;
        let report = `REPORTE DE CALIFICACIONES - CALIDAD DE SOFTWARE\n==============================================\n\n`;
        report += `Estudiante: ${name}\nCódigo: ${id}\nFecha: ${new Date().toLocaleDateString()}\n\n`;
        report += `CALIFICACIÓN FINAL: ${final}/5.0\n\n`;
        report += `DETALLE POR UNIDADES:\n`;
        report += `- Unidad I (30%): ${
          document.getElementById("unit1Grade").textContent
        }/5.0\n`;
        report += `- Unidad II (30%): ${
          document.getElementById("unit2Grade").textContent
        }/5.0\n`;
        report += `- Unidad III (40%): ${
          document.getElementById("unit3Grade").textContent
        }/5.0\n\n`;
        const blob = new Blob([report], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Reporte_${name.replace(/\s+/g, "_")}_${
          new Date().toISOString().split("T")[0]
        }.txt`;
        a.click();
        URL.revokeObjectURL(url);
      });
      function showSummary() {
        const final = +document.getElementById("finalGrade").textContent;
        const summary = document.getElementById("summaryContent");
        const ok = final >= 3.0;
        summary.innerHTML = `
          <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
            <span class="font-medium">Estado del Curso:</span>
            <span class="font-bold ${ok ? "text-green-600" : "text-red-600"}">${
          ok ? "APROBADO" : "REPROBADO"
        }</span>
          </div>
          <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
            <span class="font-medium">Calificación Final:</span>
            <span class="font-bold text-blue-600">${final.toFixed(1)}/5.0</span>
          </div>
          <div class="text-sm text-gray-600 mt-4">
            <p><strong>Nota:</strong> La calificación mínima para aprobar es 3.0/5.0</p>
          </div>`;
        document.getElementById("resultsSummary").classList.remove("hidden");
      }

      // Init
      populateStudentDropdown();
      calculateProjectGrades();
      calculateGrades();
    </script>

    <!-- Backend (Firestore) y preview docente -->
    <script type="module" src="./js/calificaciones-backend.js"></script>
    <script type="module" src="./js/calificaciones-teacher-preview.js"></script>

    <!-- Layout y utilidades -->
    <script type="module" src="./js/role-gate.js"></script>
    <script defer src="./js/layout.js"></script>
    <script defer src="./js/nav-inject.js"></script>
    <script defer src="./js/back-home.js"></script>
  </body>
</html>
