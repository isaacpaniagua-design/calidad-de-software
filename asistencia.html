<!DOCTYPE html>

<html lang="es" data-layout="global">
  <head>
    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Registro de Asistencia - ITSON</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

      body {
        font-family: "Inter", sans-serif;
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .success-pulse {
        animation: successPulse 0.8s ease-out;
      }

      @keyframes successPulse {
        0% {
          transform: scale(1);
        }

        50% {
          transform: scale(1.1);
        }

        100% {
          transform: scale(1);
        }
      }

      .slide-in {
        animation: slideIn 0.4s ease-out;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }

        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .attendance-hero {
        position: relative;
        overflow: hidden;
        border-radius: clamp(28px, 5vw, 40px);
        padding: clamp(40px, 7vw, 72px);
        background: linear-gradient(
          135deg,
          #4f46e5 0%,
          #7c3aed 45%,
          #0ea5e9 100%
        );
        color: #f8fafc;
        box-shadow: 0 32px 84px rgba(79, 70, 229, 0.35);
      }

      .attendance-hero::before,
      .attendance-hero::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
      }

      .attendance-hero::before {
        background: radial-gradient(
            circle at 18% 22%,
            rgba(255, 255, 255, 0.22),
            transparent 60%
          ),
          radial-gradient(
            circle at 82% 18%,
            rgba(14, 165, 233, 0.25),
            transparent 62%
          );
        opacity: 0.95;
      }

      .attendance-hero::after {
        background: linear-gradient(
          140deg,
          rgba(59, 130, 246, 0.12) 0%,
          rgba(129, 140, 248, 0.28) 45%,
          transparent 80%
        );
        mix-blend-mode: screen;
      }

      .attendance-hero > * {
        position: relative;
        z-index: 1;
      }

      .attendance-hero .hero-badge {
        width: clamp(60px, 10vw, 96px);
        height: clamp(60px, 10vw, 96px);
        border-radius: 9999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(
          135deg,
          rgba(248, 250, 252, 0.2),
          rgba(255, 255, 255, 0.05)
        );
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.25),
          0 18px 38px rgba(15, 23, 42, 0.25);
        backdrop-filter: blur(8px);
      }

      .attendance-hero .hero-badge svg {
        width: clamp(32px, 6vw, 44px);
        height: clamp(32px, 6vw, 44px);
      }

      .attendance-hero__meta {
        display: flex;
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
      }

      @media (min-width: 768px) {
        .attendance-hero__meta {
          align-items: flex-end;
        }
      }

      .attendance-hero__datetime {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px;
        border-radius: 9999px;
        background: rgba(15, 23, 42, 0.18);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08);
        font-size: 0.95rem;
        font-weight: 500;
        letter-spacing: 0.01em;
      }

      .attendance-hero__datetime span {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .attendance-hero__auth {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 12px;
        padding: 12px 18px;
        border-radius: 18px;
        background: rgba(15, 23, 42, 0.14);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.12);
      }

      .attendance-hero__auth button {
        box-shadow: 0 10px 20px rgba(16, 185, 129, 0.35);
      }

      .attendance-hero__banner {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        border-radius: 9999px;
        background: rgba(16, 185, 129, 0.14);
        color: #ecfdf5;
        box-shadow: inset 0 1px 0 rgba(16, 185, 129, 0.35);
      }

      .attendance-hero__banner .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 9999px;
        background-color: #22c55e;
      }
    </style>

    <link rel="stylesheet" href="css/layout.css" />
  </head>

  <body
    class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen"
  >
    <!-- NAV Plataforma QS (será inyectado por js/layout.js) -->

    <div class="container mx-auto px-4 py-8 max-w-6xl">
      <!-- Header -->

      <header class="attendance-hero mb-12">
        <div class="flex flex-col gap-8">
          <div
            class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-8"
          >
            <div class="flex items-start gap-5 text-indigo-50">
              <div class="hero-badge">
                <svg
                  class="text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
              </div>
              <div class="max-w-3xl space-y-3">
                <h1
                  class="text-4xl md:text-5xl font-extrabold tracking-tight text-white"
                >
                  Registro de Asistencia
                </h1>
                <p
                  class="text-base md:text-lg text-indigo-100/90 leading-relaxed"
                >
                  Lleva el control de asistencia de tu grupo en tiempo real con
                  confirmación automática mediante cuentas @potros. Administra
                  el acceso de estudiantes y docentes desde una interfaz moderna
                  y accesible.
                </p>
              </div>
            </div>
            <div class="attendance-hero__meta">
              <div class="attendance-hero__datetime text-indigo-50/90">
                <svg
                  class="w-5 h-5 text-sky-100"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
                <span
                  class="flex flex-col sm:flex-row sm:items-center sm:gap-3"
                >
                  <span
                    id="currentDate"
                    class="font-semibold uppercase tracking-wide"
                  ></span>
                  <span class="hidden sm:inline opacity-60" aria-hidden="true"
                    >•</span
                  >
                  <span id="currentTime" class="font-semibold"></span>
                </span>
              </div>
              <div id="authArea" class="attendance-hero__auth student-only">
                <button
                  id="signInBtn"
                  class="bg-gradient-to-r from-emerald-600 to-green-600 text-white px-5 py-2 rounded-full hover:from-emerald-700 hover:to-green-700 transition-all duration-200 font-semibold"
                >
                  Acceder con cuenta @potros
                </button>
                <div id="userInfo" class="hidden items-center gap-3">
                  <img
                    id="userPhoto"
                    class="w-8 h-8 rounded-full border border-white/40"
                    alt="Foto"
                  />
                  <span id="userName" class="text-white font-medium"></span>
                </div>
              </div>
            </div>
          </div>
          <div id="classBanner" class="attendance-hero__banner hidden">
            <span class="status-dot animate-pulse"></span>
            <span class="text-sm font-semibold tracking-wide"
              >Clase activa ahora: 18:00 - 19:00 (Lun/Mié/Vie)</span
            >
          </div>
        </div>
      </header>

      <!-- Herramientas Docente -->

      <div
        class="teacher-only bg-white rounded-2xl shadow-xl p-8 border border-gray-100 mb-10"
        id="manualAttendanceCard"
      >
        <h3 class="text-2xl font-bold text-gray-800 mb-1">
          Registro manual para pruebas
        </h3>

        <p class="text-gray-600 text-sm mb-6">
          Disponible solo para docentes. Permite simular asistencias o realizar
          correcciones sin validacion por Google.
        </p>

        <div class="grid gap-4">
          <div>
            <label class="form-label" for="manualAttendanceSelect"
              >Seleccionar participante</label
            >

            <select id="manualAttendanceSelect" class="form-select">
              <option value="">-- Selecciona desde la lista --</option>
            </select>
          </div>

          <div class="text-sm text-gray-500">
            o captura un correo manual para pruebas:
          </div>

          <div class="grid gap-3">
            <input
              type="text"
              id="manualAttendanceName"
              class="form-input"
              placeholder="Nombre (opcional si está en la lista)"
            />

            <input
              type="email"
              id="manualAttendanceEmail"
              class="form-input"
              placeholder="correo@potros.itson.edu.mx"
            />
          </div>
        </div>

        <p
          id="manualAttendanceWarning"
          class="hidden mt-4 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-lg px-4 py-3"
        ></p>

        <button type="button" id="manualAttendanceBtn" class="submit-btn mt-6">
          Registrar asistencia manual
        </button>
      </div>

      <div
        class="teacher-only bg-white rounded-2xl shadow border border-amber-200 text-amber-700 px-6 py-5 mb-10 hidden"
        id="manualAttendanceNotice"
      >
        <h3 class="text-xl font-semibold mb-2">
          Permisos de registro manual pendientes
        </h3>

        <p class="text-sm leading-relaxed">
          Iniciaste sesión con un perfil marcado como docente en la lista del
          curso, pero tu cuenta aún no tiene privilegios de docente en Firebase.
          Ponte en contacto con el administrador para habilitar tu acceso o
          utiliza el registro automático mientras tanto.
        </p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Attendance Button Section -->

        <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
          <div class="text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
              Registrar Mi Asistencia
            </h2>

            <div class="mb-8">
              <div
                class="w-24 h-24 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg"
              >
                <svg
                  class="w-12 h-12 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"
                  ></path>
                </svg>
              </div>

              <p class="text-gray-600 mb-8">
                Haz clic en el botón para registrar tu asistencia del día de hoy
              </p>
            </div>

            <button
              id="attendanceBtn"
              class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-4 px-8 rounded-xl text-xl transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl"
            >
              <span class="flex items-center justify-center">
                <svg
                  class="w-6 h-6 mr-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                  ></path>
                </svg>

                Registrar Asistencia
              </span>
            </button>

            <button
              id="myHistoryBtn"
              type="button"
              class="student-only hidden mt-4 w-full border-2 border-indigo-100 text-indigo-600 font-semibold py-3 px-6 rounded-xl transition-all duration-300 hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:ring-offset-2"
            >
              Ver mi historial de asistencia
            </button>

            <p
              class="student-only text-xs text-gray-500 mt-2 hidden"
              id="myHistoryHint"
            >
              Consulta tus asistencias registradas desde este botón en cualquier
              momento.
            </p>

            <p class="text-sm text-gray-500 mt-4">
              * Se validará automáticamente con tu cuenta @potros.itson.edu.mx
            </p>
          </div>
        </div>

        <!-- Registered Attendance List -->

        <div
          class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden"
        >
          <div
            class="bg-gradient-to-r from-gray-50 to-gray-100 px-8 py-6 border-b"
          >
            <div class="flex items-center justify-between gap-4 flex-wrap">
              <h2 class="text-2xl font-bold text-gray-800">
                Asistencias Registradas
              </h2>

              <div
                class="flex items-center gap-3 flex-wrap justify-start xl:justify-end teacher-only"
              >
                <div class="flex items-center space-x-2">
                  <div
                    class="w-3 h-3 bg-green-500 rounded-full animate-pulse"
                  ></div>

                  <span
                    id="attendanceCount"
                    class="text-lg font-semibold text-gray-700"
                    >0 registrados</span
                  >
                </div>

                <div class="flex items-center gap-2 teacher-only">
                  <button
                    id="exportAttendanceCsvBtn"
                    class="px-3 py-1 rounded-md bg-white border text-gray-700 hover:bg-gray-50 text-sm"
                  >
                    Exportar CSV
                  </button>

                  <button
                    id="exportAttendancePdfBtn"
                    class="px-3 py-1 rounded-md bg-white border text-gray-700 hover:bg-gray-50 text-sm"
                  >
                    Reporte PDF
                  </button>
                </div>

                <div
                  class="flex items-center gap-2 text-sm teacher-only flex-wrap gap-y-2"
                >
                  <label>Desde</label>

                  <input
                    type="date"
                    id="attStartDate"
                    class="border rounded-md px-2 py-1"
                  />

                  <label>Hasta</label>

                  <input
                    type="date"
                    id="attEndDate"
                    class="border rounded-md px-2 py-1"
                  />

                  <button
                    id="exportAttendanceRangeCsvBtn"
                    class="px-3 py-1 rounded-md bg-white border text-gray-700 hover:bg-gray-50"
                  >
                    CSV Rango
                  </button>

                  <button
                    id="exportAttendanceRangePdfBtn"
                    class="px-3 py-1 rounded-md bg-white border text-gray-700 hover:bg-gray-50"
                  >
                    PDF Rango
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="p-6">
            <div class="mb-4 flex gap-2 items-center text-sm">
              <input
                id="attFilterText"
                class="border rounded-md px-2 py-1 flex-1"
                placeholder="Filtrar por nombre o email..."
              />

              <select id="attFilterType" class="border rounded-md px-2 py-1">
                <option value="all">Todos</option>

                <option value="student">Estudiantes</option>

                <option value="teacher">Docentes</option>
              </select>
            </div>

            <div id="noAttendance" class="text-center py-12">
              <div
                class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4"
              >
                <svg
                  class="w-8 h-8 text-gray-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 20h5v-2a3 3 0 00-5.196-2.196M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.196-2.196M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                  ></path>
                </svg>
              </div>

              <p class="text-gray-500">Aún no hay asistencias registradas</p>

              <p class="text-sm text-gray-400 mt-2">
                Las asistencias aparecerán aquí en tiempo real
              </p>
            </div>

            <div id="attendanceList" class="space-y-3 max-h-96 overflow-y-auto">
              <!-- Registered attendances will appear here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Success Modal -->
      <div
        id="successModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
      >
        <div
          class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center shadow-2xl"
        >
          <div
            class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6"
          >
            <svg
              class="w-10 h-10 text-green-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"
              ></path>
            </svg>
          </div>
          <h3 class="text-2xl font-bold text-gray-900 mb-3">
            ¡Asistencia Registrada!
          </h3>
          <p id="successMessage" class="text-gray-600 mb-2 text-lg"></p>
          <p id="successTimestamp" class="text-sm text-gray-500 mb-8"></p>
          <button
            onclick="closeSuccessModal()"
            class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-8 py-3 rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all duration-300 font-semibold"
          >
            Continuar
          </button>
        </div>
      </div>

      <!-- Attendance History Modal -->
      <div
        id="historyModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 px-4"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full p-6 md:p-8 relative"
        >
          <button
            id="historyModalClose"
            type="button"
            class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition"
            aria-label="Cerrar historial"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
          <div class="space-y-5">
            <div>
              <h3 id="historyTitle" class="text-2xl font-bold text-gray-900">
                Historial de asistencia
              </h3>
              <p id="historyEmail" class="text-sm text-gray-500"></p>
            </div>
            <div class="grid gap-3 md:grid-cols-6 items-end">
              <div class="md:col-span-2">
                <label
                  for="historyStartDate"
                  class="text-xs font-semibold text-gray-500 uppercase tracking-wide"
                  >Desde</label
                >
                <input
                  type="date"
                  id="historyStartDate"
                  class="mt-1 w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
                />
              </div>
              <div class="md:col-span-2">
                <label
                  for="historyEndDate"
                  class="text-xs font-semibold text-gray-500 uppercase tracking-wide"
                  >Hasta</label
                >
                <input
                  type="date"
                  id="historyEndDate"
                  class="mt-1 w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
                />
              </div>
              <div class="md:col-span-2 flex justify-end">
                <button
                  id="historyFetchBtn"
                  type="button"
                  class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-indigo-700 transition"
                >
                  Actualizar historial
                </button>
              </div>
            </div>
            <div id="historySummary" class="text-sm text-gray-500">
              Selecciona un estudiante o consulta tu historial personal.
            </div>
            <div
              id="historyContent"
              class="bg-gray-50 border border-gray-100 rounded-xl p-4 max-h-80 overflow-y-auto text-sm text-gray-700"
            >
              <div class="text-center text-gray-400">
                No hay datos para mostrar.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script
      type="module"
      src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js"
    ></script>
    <script
      type="module"
      src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js"
    ></script>
    <script
      type="module"
      src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js"
    ></script>
   <script type="module">
  // Importaciones de Firebase
  import {
    initFirebase,
    getDb,
    getAuthInstance,
    onAuth,
    signInWithGooglePotros,
    signOutCurrent,
    isTeacherEmail,
    ensureTeacherAllowlistLoaded,
  } from "./js/firebase.js";
  import { allowedEmailDomain } from "./js/firebase-config.js";
  import {
    collection,
    doc,
    onSnapshot,
    query,
    where,
    addDoc,
    serverTimestamp,
    Timestamp,
    getDocs,
    limit,
    orderBy,
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  // --- CONFIGURACIÓN Y ESTADO GLOBAL ---
  const ROSTER_STORAGE_KEY = "qs_roster_cache";
  let students = [];
  let registeredAttendances = new Map();
  let currentUserProfile = null;
  let unsubscribeAttendance = () => {};

  // --- REFERENCIAS AL DOM ---
  const dom = {
    signInBtn: document.getElementById("signInBtn"),
    userInfo: document.getElementById("userInfo"),
    userName: document.getElementById("userName"),
    userPhoto: document.getElementById("userPhoto"),
    attendanceBtn: document.getElementById("attendanceBtn"),
    attendanceListContainer: document.getElementById("attendanceList"),
    noAttendanceEl: document.getElementById("noAttendance"),
    attendanceCountEl: document.getElementById("attendanceCount"),
    successModal: document.getElementById("successModal"),
    successMessage: document.getElementById("successMessage"),
    successTimestamp: document.getElementById("successTimestamp"),
    currentDate: document.getElementById("currentDate"),
    currentTime: document.getElementById("currentTime"),
  };

  // --- LÓGICA DE NEGOCIO ---
  async function loadRoster() {
    try {
      const response = await fetch("./data/students.json");
      if (!response.ok) throw new Error("Could not fetch student list");
      const baseRosterData = await response.json();
      const baseRoster = parseRosterPayload(baseRosterData);
      const cachedRoster = parseRosterPayload(localStorage.getItem(ROSTER_STORAGE_KEY));
      students = mergeRosterLists(baseRoster, cachedRoster);
      window.students = students;
    } catch (error) {
      console.error("Failed to load student roster:", error);
      students = parseRosterPayload(localStorage.getItem(ROSTER_STORAGE_KEY));
      showNotification("No se pudo cargar la lista de alumnos, se usará la versión en caché.", "warning");
    }
  }

  async function registerAttendance() {
    if (!currentUserProfile) {
      return showNotification("Primero inicia sesión con tu cuenta @" + allowedEmailDomain, "error");
    }
    if (dom.attendanceBtn.disabled) return;

    const { email, uid, name } = currentUserProfile;
    const rosterEntry = students.find(s => (s.email || "").toLowerCase() === email.toLowerCase());

    if (!rosterEntry) {
      return showNotification("Tu correo no está en la lista del curso. Contacta al docente.", "error");
    }

    try {
      setAttendanceEnabled(false, "Registrando...");
      const payload = {
        uid,
        name: rosterEntry.name || name,
        email,
        type: rosterEntry.type || "student",
        createdByUid: uid,
        timestamp: serverTimestamp(),
      };
      await addDoc(collection(getDb(), "attendances"), payload);
      showSuccessModal(rosterEntry, new Date());
    } catch (e) {
      console.error("Error saving attendance:", e);
      showNotification(e?.message || "No se pudo registrar la asistencia.", "error");
    } finally {
      setAttendanceEnabled(true);
    }
  }

  // --- FUNCIONES HELPERS ---
  const parseRosterPayload = (data) => {
    try {
      const parsed = typeof data === "string" ? JSON.parse(data) : data;
      return (Array.isArray(parsed) ? parsed : parsed.students || []).map(e => ({
        ...e,
        email: (e.email || "").toLowerCase()
      })).filter(Boolean);
    } catch {
      return [];
    }
  };

  // 🔽 *** AQUÍ ESTÁ LA CORRECCIÓN *** 🔽
  const mergeRosterLists = (primary, secondary) => {
    const map = new Map(primary.map(item => [item.email, item]));
    secondary.forEach(item => {
      if (item && item.email && !map.has(item.email)) {
        map.set(item.email, item);
      }
    });
    return Array.from(map.values()).sort((a, b) => {
      // Si 'a' o 'b' no tienen nombre, usa una cadena vacía para evitar el error.
      const nameA = a.name || '';
      const nameB = b.name || '';
      return nameA.localeCompare(nameB, "es");
    });
  };

  // --- FUNCIONES DE UI ---
  const updateDateTime = () => {
    const now = new Date();
    dom.currentDate.textContent = now.toLocaleDateString("es-ES", { weekday: "long", year: "numeric", month: "long", day: "numeric" });
    dom.currentTime.textContent = now.toLocaleTimeString("es-ES");
  };

  const setAttendanceEnabled = (enabled, text = "Registrar Asistencia") => {
    if (!dom.attendanceBtn) return;
    dom.attendanceBtn.disabled = !enabled;
    dom.attendanceBtn.classList.toggle("opacity-60", !enabled);
    dom.attendanceBtn.classList.toggle("cursor-not-allowed", !enabled);
    dom.attendanceBtn.querySelector("span").textContent = text;
  };

  const applyRoleVisibility = (isTeacher) => {
    document.querySelectorAll(".teacher-only").forEach(el => el.style.display = isTeacher ? "" : "none");
    document.querySelectorAll(".student-only").forEach(el => el.style.display = isTeacher ? "none" : "");
  };
  
  const showSuccessModal = (student, timestamp) => {
    const typeText = student.type === "teacher" ? "Docente" : "Estudiante";
    dom.successMessage.textContent = `${typeText}: ${student.name}`;
    dom.successTimestamp.textContent = `Registrado a las ${timestamp.toLocaleTimeString("es-ES")}`;
    dom.successModal.classList.remove("hidden");
    dom.successModal.classList.add("flex");
  };
  
  window.closeSuccessModal = () => {
    dom.successModal.classList.add("hidden");
    dom.successModal.classList.remove("flex");
  };

  const showNotification = (message, type = 'info') => {
    const colors = {
      info: 'bg-blue-500',
      success: 'bg-green-600',
      error: 'bg-red-600',
      warning: 'bg-yellow-500',
    };
    const notification = document.createElement('div');
    notification.className = `fixed bottom-5 right-5 text-white p-4 rounded-lg shadow-lg transform transition-all duration-300 ease-out slide-in ${colors[type]}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => {
      notification.style.transform = 'translateX(120%)';
      setTimeout(() => notification.remove(), 300);
    }, 4000);
  };

  // --- RENDERIZADO DE LA LISTA ---
  const renderAttendanceList = () => {
    dom.noAttendanceEl.style.display = registeredAttendances.size === 0 ? "block" : "none";
    dom.attendanceCountEl.textContent = `${registeredAttendances.size} ${registeredAttendances.size === 1 ? "registrado" : "registrados"}`;
    const sortedRecords = Array.from(registeredAttendances.values()).sort((a, b) => b.timestamp - a.timestamp);
    dom.attendanceListContainer.innerHTML = sortedRecords.map(createAttendanceRecordHTML).join('');
  };

  const createAttendanceRecordHTML = (record) => {
    const isTeacher = record.type === "teacher";
    const icon = isTeacher
      ? `<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253z"></path></svg>`
      : `<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>`;

    return `
      <div id="att-${record.id}" class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-4 fade-in">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="w-12 h-12 rounded-full ${isTeacher ? 'bg-purple-500' : 'bg-blue-500'} flex items-center justify-center shadow-lg">${icon}</div>
            <div>
              <h3 class="font-semibold text-gray-900">${record.name}</h3>
              <p class="text-sm text-gray-600">${record.email}</p>
            </div>
          </div>
          <div class="text-right">
            <p class="text-sm font-medium text-green-700">Registrado</p>
            <p class="text-xs text-gray-500">${record.timestamp.toLocaleTimeString("es-ES")}</p>
          </div>
        </div>
      </div>`;
  };

  // --- LÓGICA DE FIREBASE ---
  function subscribeToAttendance(user) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayTimestamp = Timestamp.fromDate(today);
    
    let q = query(collection(getDb(), "attendances"), where("timestamp", ">=", todayTimestamp), orderBy("timestamp", "desc"));
    if (!user.isTeacher) {
        q = query(q, where("uid", "==", user.uid));
    }

    unsubscribeAttendance();
    unsubscribeAttendance = onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            const docData = { id: change.doc.id, ...change.doc.data(), timestamp: change.doc.data().timestamp.toDate() };
            if (change.type === "added" || change.type === "modified") {
                registeredAttendances.set(docData.id, docData);
            }
            if (change.type === "removed") {
                registeredAttendances.delete(docData.id);
            }
        });
        renderAttendanceList();
    });
  }
  
  // --- AUTENTICACIÓN ---
  const handleAuthStateChanged = async (user) => {
    if (user && user.email.toLowerCase().endsWith("@" + allowedEmailDomain)) {
      await ensureTeacherAllowlistLoaded();
      const email = user.email.toLowerCase();
      const rosterEntry = students.find(s => (s.email || "").toLowerCase() === email);
      const isTeacher = isTeacherEmail(email);

      currentUserProfile = {
        uid: user.uid,
        email,
        name: rosterEntry?.name || user.displayName,
        isTeacher,
        type: isTeacher ? "teacher" : "student",
      };

      dom.userName.textContent = currentUserProfile.name;
      dom.userPhoto.src = user.photoURL;
      dom.userInfo.classList.remove("hidden");
      dom.signInBtn.classList.add("hidden");

      applyRoleVisibility(isTeacher);
      setAttendanceEnabled(true);
      subscribeToAttendance(currentUserProfile);
    } else {
      currentUserProfile = null;
      dom.userInfo.classList.add("hidden");
      dom.signInBtn.classList.remove("hidden");
      applyRoleVisibility(false);
      setAttendanceEnabled(false);
      registeredAttendances.clear();
      renderAttendanceList();
      if (unsubscribeAttendance) unsubscribeAttendance();
    }
  };

  // --- INICIALIZACIÓN ---
  async function main() {
    initFirebase();
    await loadRoster();
    
    dom.signInBtn.addEventListener("click", () => signInWithGooglePotros());
    dom.attendanceBtn.addEventListener("click", registerAttendance);
    
    onAuth(handleAuthStateChanged);

    updateDateTime();
    setInterval(updateDateTime, 1000);
  }

  document.addEventListener("DOMContentLoaded", main);
</script>
    <script type="module" src="js/layout.js" defer></script>
  </body>
</html>
