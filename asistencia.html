<!DOCTYPE html>
<html lang="es" data-layout="global">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Asistencia - ITSON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .success-pulse {
            animation: successPulse 0.8s ease-out;
        }
        
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .slide-in {
            animation: slideIn 0.4s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
<link rel="stylesheet" href="css/layout.css">
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">


<!-- NAV Plataforma QS -->
<div class="qs-nav" data-role="main-nav">
  <div class="wrap">
    <a class="qs-brand" href="index.html">
      <span class="qs-logo">QS</span>
      <span class="qs-title">Plataforma QS</span>
    </a>
    <nav class="qs-tabs" aria-label="Navegación">
      <a class="qs-btn" href="materiales.html">Materiales</a>
      <a class="qs-btn" href="asistencia.html">Asistencia</a>
      <a class="qs-btn" href="calificaciones.html">Calificaciones</a>
      <a class="qs-btn" href="Foro.html">Foro</a>
      <a class="qs-btn" href="paneldocente.html">Panel</a>
      
    </nav>
  </div>
</div>
<script>
(function(){
  var path = (location.pathname.split('/').pop()||'index.html').toLowerCase();
  document.querySelectorAll('.qs-tabs a.qs-btn').forEach(function(a){
    var href = (a.getAttribute('href')||'').toLowerCase();
    if (href === path) a.setAttribute('aria-current','page');
  });
})();
</script>
<div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 border border-gray-100">
            <div class="text-center">
                <div class="w-20 h-20 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h1 class="text-4xl font-bold text-gray-800 mb-2">Registro de Asistencia</h1>
                <p class="text-gray-600 text-lg">Instituto Tecnológico de Sonora</p>
                <div class="mt-4 flex items-center justify-center space-x-4 text-sm text-gray-500">
                    <div id="currentDate" class="font-medium"></div>
                    <span></span>
                    <div id="currentTime"></div>
                </div>
                <div id="authArea" class="mt-6 flex items-center justify-center gap-3 student-only">
                  <button id="signInBtn" class="bg-gradient-to-r from-emerald-600 to-green-600 text-white px-5 py-2 rounded-full hover:from-emerald-700 hover:to-green-700 transition-all duration-200 font-semibold">
                    Acceder con cuenta @potros
                  </button>
                    <div id="userInfo" class="hidden items-center gap-3">
                    <img id="userPhoto" class="w-8 h-8 rounded-full border" alt="Foto" />
                    <span id="userName" class="text-gray-700 font-medium"></span>
                    <!-- Eliminado botón de salida en asistencia: el cierre de sesión se gestiona desde la barra de navegación global -->
                  </div>
                </div>
                <!-- Banner de clase activa -->
                <div id="classBanner" class="mt-4 hidden">
                  <div class="inline-flex items-center px-4 py-2 rounded-full bg-green-100 text-green-800 text-sm font-semibold shadow-sm">
                    <span class="w-2 h-2 rounded-full bg-green-500 mr-2 animate-pulse"></span>
                    Clase activa ahora: 18:00 - 19:00 (Lun/Mié/Vie)
                  </div>
                </div>
            </div>
        </div>

                <!-- Herramientas Docente -->
        <div class="teacher-only bg-white rounded-2xl shadow-xl p-8 border border-gray-100 mb-10" id="manualAttendanceCard">
          <h3 class="text-2xl font-bold text-gray-800 mb-1">Registro manual para pruebas</h3>
          <p class="text-gray-600 text-sm mb-6">Disponible solo para docentes. Permite simular asistencias o realizar correcciones sin validacion por Google.</p>
          <div class="grid gap-4">
            <div>
              <label class="form-label" for="manualAttendanceSelect">Seleccionar participante</label>
              <select id="manualAttendanceSelect" class="form-select">
                <option value="">-- Selecciona desde la lista --</option>
              </select>
            </div>
            <div class="text-sm text-gray-500">o captura un correo manual para pruebas:</div>
            <div class="grid gap-3">
              <input type="text" id="manualAttendanceName" class="form-input" placeholder="Nombre (opcional si está en la lista)" />
              <input type="email" id="manualAttendanceEmail" class="form-input" placeholder="correo@potros.itson.edu.mx" />
            </div>
          </div>
          <button type="button" id="manualAttendanceBtn" class="submit-btn mt-6">Registrar asistencia manual</button>
        </div>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Attendance Button Section -->
            <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Registrar Mi Asistencia</h2>
                    
                    <div class="mb-8">
                        <div class="w-24 h-24 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"></path>
                            </svg>
                        </div>
                        <p class="text-gray-600 mb-8">Haz clic en el botón para registrar tu asistencia del día de hoy</p>
                    </div>
                    
                    <button 
                        id="attendanceBtn"
                        onclick="registerAttendance()"
                        class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-4 px-8 rounded-xl text-xl transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl"
                    >
                        <span class="flex items-center justify-center">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Registrar Asistencia
                        </span>
                    </button>
                    
                    <p class="text-sm text-gray-500 mt-4">
                        * Se validará automáticamente con tu cuenta @potros.itson.edu.mx
                    </p>
                </div>
            </div>

            <!-- Registered Attendance List -->
            <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
                <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-8 py-6 border-b">
                    <div class="flex items-center justify-between gap-4 flex-wrap">
                        <h2 class="text-2xl font-bold text-gray-800">Asistencias Registradas</h2>
                        <div class="flex items-center gap-3 flex-wrap justify-start xl:justify-end teacher-only">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                <span id="attendanceCount" class="text-lg font-semibold text-gray-700">0 registrados</span>
                            </div>
                            <div class="flex items-center gap-2 teacher-only">
                              <button id="exportAttendanceCsvBtn" class="px-3 py-1 rounded-md bg-white border text-gray-700 hover:bg-gray-50 text-sm">Exportar CSV</button>
                              <button id="exportAttendancePdfBtn" class="px-3 py-1 rounded-md bg-white border text-gray-700 hover:bg-gray-50 text-sm">Reporte PDF</button>
                            </div>
                            <div class="flex items-center gap-2 text-sm teacher-only flex-wrap gap-y-2">
                              <label>Desde</label>
                              <input type="date" id="attStartDate" class="border rounded-md px-2 py-1">
                              <label>Hasta</label>
                              <input type="date" id="attEndDate" class="border rounded-md px-2 py-1">
                              <button id="exportAttendanceRangeCsvBtn" class="px-3 py-1 rounded-md bg-white border text-gray-700 hover:bg-gray-50">CSV Rango</button>
                              <button id="exportAttendanceRangePdfBtn" class="px-3 py-1 rounded-md bg-white border text-gray-700 hover:bg-gray-50">PDF Rango</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="mb-4 flex gap-2 items-center text-sm">
                        <input id="attFilterText" class="border rounded-md px-2 py-1 flex-1" placeholder="Filtrar por nombre o email..." />
                        <select id="attFilterType" class="border rounded-md px-2 py-1">
                            <option value="all">Todos</option>
                            <option value="student">Estudiantes</option>
                            <option value="teacher">Docentes</option>
                        </select>
                    </div>
                    <div id="noAttendance" class="text-center py-12">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.196-2.196M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.196-2.196M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <p class="text-gray-500">Aún no hay asistencias registradas</p>
                        <p class="text-sm text-gray-400 mt-2">Las asistencias aparecerán aquí en tiempo real</p>
                    </div>
                    
                    <div id="attendanceList" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Registered attendances will appear here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Modal -->
        <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center shadow-2xl">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-3">¡Asistencia Registrada!</h3>
                <p id="successMessage" class="text-gray-600 mb-2 text-lg"></p>
                <p id="successTimestamp" class="text-sm text-gray-500 mb-8"></p>
                <button onclick="closeSuccessModal()" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-8 py-3 rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all duration-300 font-semibold">
                    Continuar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Student data - this will be used for validation when integrated with Google Auth
        const students = [
            {id: "249116", name: "Arana Guerrero, Danett Itzanami", email: "danett.arana249116@potros.itson.edu.mx", type: "student"},
            {id: "147818", name: "Araujo Godoy, Abraham Francisco", email: "abraham.araujo@potros.itson.edu.mx", type: "student"},
            {id: "244228", name: "Avalos Morales, Egla Icel", email: "egla.avalos244228@potros.itson.edu.mx", type: "student"},
            {id: "244442", name: "Blasco Villagomez, Luis Mario", email: "luis.blasco244442@potros.itson.edu.mx", type: "student"},
            {id: "244242", name: "Duarte Lopez, Adlemi Guadalupe", email: "adlemi.duarte244242@potros.itson.edu.mx", type: "student"},
            {id: "244473", name: "Espericueta Ramos, Jesus Alan", email: "jesus.espericueta244473@potros.itson.edu.mx", type: "student"},
            {id: "244608", name: "Gracia Morales, Sergio Alejandro", email: "sergio.gracia244608@potros.itson.edu.mx", type: "student"},
            {id: "228847", name: "Hernandez Gonzalez, Julian Ricardo", email: "julian.hernandez228847@potros.itson.edu.mx", type: "student"},
            {id: "248997", name: "Le Blohic Garay, Mario Enrique", email: "mario.leblohic248997@potros.itson.edu.mx", type: "student"},
            {id: "249012", name: "Lopez Guerrero, Luis Carlos", email: "luis.lopez249012@potros.itson.edu.mx", type: "student"},
            {id: "248990", name: "Maldonado Montoya, Jose Gabriel", email: "jose.maldonado248990@potros.itson.edu.mx", type: "student"},
            {id: "217812", name: "Martínez Soto, Dainiz Raí", email: "dainiz.martinez217812@potros.itson.edu.mx", type: "student"},
            {id: "244321", name: "Nevescanin Moreno, Angel Stipe", email: "angel.nevescanin244321@potros.itson.edu.mx", type: "student"},
            {id: "244477", name: "Osuna Aguilera, Erik David", email: "erik.osuna244477@potros.itson.edu.mx", type: "student"},
            {id: "244711", name: "Palacios Cardenas, Jorge Eduardo", email: "jorge.palacios244711@potros.itson.edu.mx", type: "student"},
            {id: "244569", name: "Preciado Ruiz, Juan Carlos", email: "juan.preciado244569@potros.itson.edu.mx", type: "student"},
            {id: "244373", name: "Reyes Galaz, Jose Abelardo", email: "jose.reyes244373@potros.itson.edu.mx", type: "student"},
            {id: "240691", name: "Rivas Quintana, Emmanuel", email: "emmanuel.rivas240691@potros.itson.edu.mx", type: "student"},
            {id: "244266", name: "Rocha Aguilar, Víctor Emmanuel", email: "victor.rocha244266@potros.itson.edu.mx", type: "student"},
            {id: "244312", name: "Rodriguez Alvarado, Jose Agustin", email: "jose.rodriguez244312@potros.itson.edu.mx", type: "student"},
            {id: "244621", name: "Soto Carrazco, Francisco Javier", email: "francisco.soto244621@potros.itson.edu.mx", type: "student"},
            {id: "244689", name: "Villegas Sosa, Ramsés Mauricio", email: "ramses.villegas244689@potros.itson.edu.mx", type: "student"},
            {id: "244679", name: "Viveros Zavala, Angel Gael", email: "angel.viveros244679@potros.itson.edu.mx", type: "student"},
            {id: "244378", name: "Martínez Santacruz, Yolanda", email: "yolanda.martinez244378@potros.itson.edu.mx", type: "student"},
            {id: "99645", name: "Paniagua Ruiz, Isaac Noé", email: "isaac.paniagua@potros.itson.edu.mx", type: "teacher"}
        ];

        window.students = students;

        let registeredAttendances = [];
        // Configura aquí tu horario de clase (hora local), formato HH:MM de 24h
        // Lunes(1), Miércoles(3), Viernes(5), de 18:00 a 19:00
        const classWindow = { start: '18:00', end: '19:00' };

        // Permitir que otros scripts (Firebase módulo) actualicen la misma referencia
        window.setRegisteredAttendances = function(items) { registeredAttendances = items || []; };

        function updateDateTime() {
            const now = new Date();
            const dateOptions = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            };
            
            document.getElementById('currentDate').textContent = now.toLocaleDateString('es-ES', dateOptions);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('es-ES', timeOptions);
        }

        function updateAttendanceCount() {
            const count = registeredAttendances.length;
            const countElement = document.getElementById('attendanceCount');
            countElement.textContent = `${count} ${count === 1 ? 'registrado' : 'registrados'}`;
        }

        function registerAttendance() {
            // Simulate getting user from Google Auth - for demo purposes, we'll use a random student
            const randomStudent = students[Math.floor(Math.random() * students.length)];
            
            // Check if already registered
            const alreadyRegistered = registeredAttendances.find(att => att.email === randomStudent.email);
            if (alreadyRegistered) {
                alert('Ya tienes tu asistencia registrada para el día de hoy.');
                return;
            }

            const now = new Date();
            const attendanceRecord = {
                ...randomStudent,
                timestamp: now,
                id: Date.now() // Unique ID for this attendance record
            };

            registeredAttendances.unshift(attendanceRecord); // Add to beginning of array
            updateAttendanceList();
            updateAttendanceCount();
            showSuccessModal(randomStudent, now);
        }

        function updateAttendanceList() {
            const container = document.getElementById('attendanceList');
            const noAttendance = document.getElementById('noAttendance');
            
            if (registeredAttendances.length === 0) {
                noAttendance.style.display = 'block';
                container.innerHTML = '';
                return;
            }
            
            noAttendance.style.display = 'none';
            container.innerHTML = '';
            
            const filtered = (typeof getFilteredAttendances === 'function') ? getFilteredAttendances() : registeredAttendances.slice();
            filtered.forEach((record, index) => {
                const isTeacher = record.type === 'teacher';
                const timeAgo = getTimeAgo(record.timestamp);
                const inWindow = isWithinClassWindow(record.timestamp);
                
                const attendanceItem = document.createElement('div');
                attendanceItem.className = 'bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-4 slide-in';
                attendanceItem.style.animationDelay = `${index * 0.1}s`;
                
                attendanceItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 rounded-full ${isTeacher ? 'bg-gradient-to-r from-purple-400 to-purple-600' : 'bg-gradient-to-r from-blue-400 to-blue-600'} flex items-center justify-center shadow-lg">
                                    ${isTeacher ? 
                                        '<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253z"></path></svg>' :
                                        '<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>'
                                    }
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <h3 class="font-semibold text-gray-900">${record.name}</h3>
                                    ${isTeacher ? '<span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded-full">Docente</span>' : ''}
                                    ${inWindow ? '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Dentro de horario</span>' : '<span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">Fuera de horario</span>'}
                                </div>
                                <p class="text-sm text-gray-600">ID: ${record.id}</p>
                                <p class="text-xs text-gray-500">${record.email}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center space-x-2 mb-1">
                                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-sm font-medium text-green-700">Registrado</span>
                            </div>
                            <p class="text-xs text-gray-500">${record.timestamp.toLocaleTimeString('es-ES')}</p>
                            <p class="text-xs text-gray-400">${timeAgo}</p>
                        </div>
                    </div>
                `;
                
                container.appendChild(attendanceItem);
            });
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const diffInMinutes = Math.floor((now - timestamp) / (1000 * 60));
            
            if (diffInMinutes < 1) return 'Hace un momento';
            if (diffInMinutes === 1) return 'Hace 1 minuto';
            if (diffInMinutes < 60) return `Hace ${diffInMinutes} minutos`;
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours === 1) return 'Hace 1 hora';
            return `Hace ${diffInHours} horas`;
        }

        function isWithinClassWindow(dateObj) {
            try {
                const [sh, sm] = (classWindow.start||'00:00').split(':').map(n=>parseInt(n,10)||0);
                const [eh, em] = (classWindow.end||'23:59').split(':').map(n=>parseInt(n,10)||0);
                const start = new Date(dateObj); start.setHours(sh, sm, 0, 0);
                const end = new Date(dateObj); end.setHours(eh, em, 59, 999);
                return dateObj >= start && dateObj <= end;
            } catch (_) { return true; }
        }

        // Filtros (texto/tipo)
        function getFilteredAttendances() {
            try {
                const q = (document.getElementById('attFilterText')?.value || '').toLowerCase().trim();
                const type = document.getElementById('attFilterType')?.value || 'all';
                let items = registeredAttendances.slice();
                if (q) {
                    items = items.filter(it => (it.name||'').toLowerCase().includes(q) || (it.email||'').toLowerCase().includes(q));
                }
                if (type !== 'all') items = items.filter(it => (it.type||'') === type);
                return items;
            } catch (e) {
                return registeredAttendances.slice();
            }
        }

        // Toast de confirmación
        function showAttendanceToast(message) {
            let toast = document.getElementById('attendanceToast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'attendanceToast';
                toast.className = 'fixed right-6 bg-white border-l-4 border-green-500 shadow-xl rounded-lg p-4 text-gray-800 transform transition-transform translate-x-full';
                toast.style.top = '96px';
                toast.style.zIndex = '1500';
                toast.innerHTML = '<div class="font-bold text-green-700 mb-1">Asistencia</div><div id="attendanceToastMsg" class="text-sm"></div>';
                document.body.appendChild(toast);
            }
            document.getElementById('attendanceToastMsg').textContent = message;
            // Mostrar
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full');
            });
            // Ocultar a los 3s
            clearTimeout(window.__attendanceToastTimer);
            window.__attendanceToastTimer = setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        }

        // Verifica si AHORA está dentro de los días/fechas y ventana horaria
        function isClassActiveNow() {
            const now = new Date();
            // Rango de fechas del semestre (ajustado al año actual)
            const start = new Date(now.getFullYear(), 7, 25, 0, 0, 0, 0); // 25 Ago
            const end = new Date(now.getFullYear(), 11, 12, 23, 59, 59, 999); // 12 Dic
            if (!(now >= start && now <= end)) return false;
            // Días lunes(1), miércoles(3), viernes(5)
            const allowedDays = [1,3,5];
            if (!allowedDays.includes(now.getDay())) return false;
            // Ventana horaria
            return isWithinClassWindow(now);
        }

        function showSuccessModal(student, timestamp) {
            const modal = document.getElementById('successModal');
            const message = document.getElementById('successMessage');
            const timestampEl = document.getElementById('successTimestamp');
            
            const typeText = student.type === 'teacher' ? 'Docente' : 'Estudiante';
            message.textContent = `${typeText}: ${student.name}`;
            timestampEl.textContent = `Registrado el ${timestamp.toLocaleDateString('es-ES')} a las ${timestamp.toLocaleTimeString('es-ES')}`;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modal.querySelector('.bg-white').classList.add('success-pulse');
        }

        function closeSuccessModal() {
            const modal = document.getElementById('successModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeSuccessModal();
            }
        });

        // Initialize
        updateDateTime();
        setInterval(updateDateTime, 1000);
        updateAttendanceCount();
        
        // Update time ago every minute
        setInterval(() => {
            if (registeredAttendances.length > 0) {
                updateAttendanceList();
            }
        }, 60000);

        // Export function for integration with Google Auth
        window.registerAttendanceForUser = function(userEmail) {
            const student = students.find(s => s.email === userEmail);
            if (!student) {
                throw new Error('Usuario no encontrado en la lista de estudiantes');
            }
            
            const alreadyRegistered = registeredAttendances.find(att => att.email === userEmail);
            if (alreadyRegistered) {
                throw new Error('Ya tienes tu asistencia registrada para el día de hoy');
            }

            const now = new Date();
            const attendanceRecord = {
                ...student,
                timestamp: now,
                id: Date.now()
            };

            registeredAttendances.unshift(attendanceRecord);
            updateAttendanceList();
            updateAttendanceCount();
            showSuccessModal(student, now);
            
            return attendanceRecord;
        };
    </script>

    <script type="module">
      import { initFirebase, onAuth, signInWithGooglePotros, signOutCurrent, saveTodayAttendance, subscribeTodayAttendance, fetchAttendancesByDateRange } from './js/firebase.js';
      import { allowedEmailDomain } from './js/firebase-config.js';

      initFirebase();

      const signInBtn = document.getElementById('signInBtn');
      const signOutBtn = document.getElementById('signOutBtn');
      const userInfo = document.getElementById('userInfo');
      const userName = document.getElementById('userName');
      const userPhoto = document.getElementById('userPhoto');
      const attendanceBtn = document.getElementById('attendanceBtn');
      const manualCard = document.getElementById('manualAttendanceCard');
      const manualSelect = document.getElementById('manualAttendanceSelect');
      const manualNameInput = document.getElementById('manualAttendanceName');
      const manualEmailInput = document.getElementById('manualAttendanceEmail');
      const manualBtn = document.getElementById('manualAttendanceBtn');

      function setAttendanceEnabled(enabled) {
        if (!attendanceBtn) return;
        attendanceBtn.disabled = !enabled;
        attendanceBtn.style.opacity = enabled ? '1' : '0.6';
        attendanceBtn.style.cursor = enabled ? 'pointer' : 'not-allowed';
      }

      setAttendanceEnabled(false);

      if (manualBtn) {
        manualBtn.addEventListener('click', (event) => {
          event.preventDefault();
          manualRegisterAttendance();
        });
      }

      if (manualSelect) {
        manualSelect.addEventListener('change', () => {
          const roster = Array.isArray(window.students) ? window.students : [];
          const selected = roster.find((item) => String(item.id) === manualSelect.value);
          if (selected) {
            if (manualNameInput) manualNameInput.value = selected.name || '';
            if (manualEmailInput) manualEmailInput.value = selected.email || '';
          } else {
            if (manualNameInput) manualNameInput.value = '';
            if (manualEmailInput) manualEmailInput.value = '';
          }
        });
      }

      if (signInBtn) {
        signInBtn.addEventListener('click', async () => {
          try {
            await signInWithGooglePotros();
          } catch (e) {
            alert(e.message || 'No se pudo iniciar sesión');
          }
        });
      }

      if (signOutBtn) {
        signOutBtn.addEventListener('click', async () => {
          await signOutCurrent();
        });
      }

      let unsubscribeAttendance = null;
      onAuth(async (user) => {
        if (user && user.email?.toLowerCase().endsWith(`@${allowedEmailDomain}`)) {
          userName.textContent = user.displayName || user.email;
          if (user.photoURL) {
            userPhoto.src = user.photoURL;
            userPhoto.classList.remove('hidden');
          } else {
            userPhoto.classList.add('hidden');
          }
          userInfo.classList.remove('hidden');
          if (signInBtn) signInBtn.classList.add('hidden');
          const rosterEntry = (Array.isArray(window.students) ? window.students : []).find((student) => (student.email || '').toLowerCase() === user.email.toLowerCase());
          if (rosterEntry?.type === 'teacher') {
            try { localStorage.setItem('qs_role', 'docente'); } catch (_) {}
            if (manualCard) {
              manualCard.classList.remove('hidden');
              manualCard.style.display = '';
            }
          }

          const active = (typeof window.isClassActiveNow === 'function' ? window.isClassActiveNow() : true);
          setAttendanceEnabled(active);
          const banner = document.getElementById('classBanner');
          if (banner) banner.classList.toggle('hidden', !active);

          // Actualiza el estado del botón según horario (cada minuto)
          try { window.clearInterval(window.__classActiveTimer); } catch(_) {}
          window.__classActiveTimer = window.setInterval(() => {
            const activeNow = (typeof window.isClassActiveNow === 'function' ? window.isClassActiveNow() : true);
            setAttendanceEnabled(activeNow);
            const banner = document.getElementById('classBanner');
            if (banner) banner.classList.toggle('hidden', !activeNow);
          }, 60000);

          if (unsubscribeAttendance) unsubscribeAttendance();
          unsubscribeAttendance = subscribeTodayAttendance((items) => {
            if (typeof window.setRegisteredAttendances === 'function') {
              window.setRegisteredAttendances(items);
            } else {
              window.registeredAttendances = items;
            }
            if (typeof window.updateAttendanceList === 'function') window.updateAttendanceList();
            if (typeof window.updateAttendanceCount === 'function') window.updateAttendanceCount();
          });
        } else {
          userInfo.classList.add('hidden');
          if (signInBtn) signInBtn.classList.remove('hidden');
          setAttendanceEnabled(false);
          if (manualCard) {
            manualCard.classList.add('hidden');
            manualCard.style.display = 'none';
          }
          try { window.clearInterval(window.__classActiveTimer); } catch(_) {}
          window.registeredAttendances = [];
          if (typeof window.updateAttendanceList === 'function') window.updateAttendanceList();
          if (typeof window.updateAttendanceCount === 'function') window.updateAttendanceCount();
          if (unsubscribeAttendance) { unsubscribeAttendance(); unsubscribeAttendance = null; }
        }
      });

      function populateManualAttendanceOptions() {
        if (!manualSelect) return;
        const roster = Array.isArray(window.students) ? window.students : [];
        const options = roster
          .filter((student) => student && student.id && student.name)
          .map((student) => {
            const emailLabel = student.email ? ` - ${student.email}` : '';
            return `<option value="${student.id}">${student.name}${emailLabel}</option>`;
          })
          .join('');
        manualSelect.innerHTML = '<option value="">-- Selecciona desde la lista --</option>' + options;
      }

      async function manualRegisterAttendance() {
        if (!manualBtn) return;
        const roster = Array.isArray(window.students) ? window.students : [];
        const selectedId = manualSelect ? manualSelect.value : '';
        const typedEmail = (manualEmailInput?.value || '').trim().toLowerCase();
        const typedName = (manualNameInput?.value || '').trim();

        let student = null;
        if (selectedId) {
          student = roster.find((item) => String(item.id) === selectedId);
        }
        if (!student && typedEmail) {
          student = roster.find((item) => (item.email || '').toLowerCase() === typedEmail);
        }

        let email = (student?.email || typedEmail || '').toLowerCase();
        if (!email) {
          alert('Ingresa un correo valido o selecciona un integrante.');
          return;
        }

        const name = typedName || student?.name || email;
        const type = student?.type || 'manual';
        const uid = student?.uid || student?.id || `manual-${Date.now()}`;

        if (typeof window.isClassActiveNow === 'function' && !window.isClassActiveNow()) {
          const proceed = confirm('La clase no esta en horario. Registrar de todas formas?');
          if (!proceed) return;
        }

        manualBtn.disabled = true;
        try {
          await saveTodayAttendance({
            uid,
            name,
            email,
            type,
            manual: true
          });
          const when = new Date();
          if (typeof window.showSuccessModal === 'function') {
            window.showSuccessModal({ name, type }, when);
          }
          if (typeof window.showAttendanceToast === 'function') {
            window.showAttendanceToast('Asistencia registrada manualmente');
          }
          if (manualSelect) manualSelect.value = '';
          if (manualNameInput) manualNameInput.value = '';
          if (manualEmailInput) manualEmailInput.value = '';
        } catch (error) {
          console.error('Manual attendance error', error);
          alert(error?.message || 'No se pudo registrar manualmente.');
        } finally {
          manualBtn.disabled = false;
        }
      }
      window.registerAttendance = async function registerAttendance() {
        if (typeof window.isClassActiveNow === 'function' && !window.isClassActiveNow()) {
          alert('La asistencia solo puede registrarse Lun/Mié/Vie entre 18:00 y 19:00, del 25 de agosto al 12 de diciembre.');
          return;
        }
        const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js');
        const user = getAuth().currentUser;
        if (!user) {
          alert('Primero inicia sesión con tu cuenta @' + allowedEmailDomain);
          return;
        }
        const email = user.email.toLowerCase();
        if (!email.endsWith(`@${allowedEmailDomain}`)) {
          alert('Solo se permite acceder con cuenta @' + allowedEmailDomain);
          return;
        }
        const roster = window.students || [];
        const found = roster.find(s => (s.email || '').toLowerCase() === email);
        if (!found) {
          alert('Tu correo no está en la lista del curso. Contacta al docente.');
          return;
        }
        try {
          await saveTodayAttendance({
            uid: user.uid,
            name: found.name,
            email: email,
            type: found.type
          });
          const when = new Date();
          if (typeof window.showSuccessModal === 'function') {
            window.showSuccessModal({ name: found.name, type: found.type }, when);
          }
          if (typeof window.showAttendanceToast === 'function') {
            window.showAttendanceToast('¡Asistencia registrada correctamente!');
          }
        } catch (e) {
          alert(e.message || 'No se pudo registrar la asistencia.');
        }
      }

      if (attendanceBtn) {
        attendanceBtn.onclick = (e) => { e.preventDefault(); window.registerAttendance(); };
      }

      populateManualAttendanceOptions();

      // Exportadores
      function formatDateTime(d) {
        const dd = d instanceof Date ? d : new Date(d);
        return {
          date: dd.toLocaleDateString('es-MX'),
          time: dd.toLocaleTimeString('es-MX', { hour12: false })
        }
      }

      function exportAttendanceCSV() {
        const items = (typeof window.getFilteredAttendances === 'function' ? window.getFilteredAttendances() : window.registeredAttendances) || [];
        const header = ['Fecha','Hora','Nombre','Email','Tipo','EnHorario'];
        const rows = items.map(it => {
          const { date, time } = formatDateTime(it.timestamp);
          const within = (typeof window.isWithinClassWindow === 'function') ? window.isWithinClassWindow(it.timestamp) : true;
          return [date, time, (it.name||''), (it.email||''), (it.type||''), within?'Si':'No'];
        });
        const csv = [header].concat(rows).map(r => r.map(v => '"'+String(v).replace('"','""')+'"').join(',')).join('\r\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `asistencias_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        URL.revokeObjectURL(a.href);
      }

      function exportAttendancePDF() {
        const items = (typeof window.getFilteredAttendances === 'function' ? window.getFilteredAttendances() : window.registeredAttendances) || [];
        const w = window.open('', '_blank');
        const today = new Date();
        const title = `Asistencias ${today.toLocaleDateString('es-MX')}`;
        const rows = items.map((it, idx) => {
          const { date, time } = formatDateTime(it.timestamp);
          const within = (typeof window.isWithinClassWindow === 'function') ? window.isWithinClassWindow(it.timestamp) : true;
          return `<tr><td>${idx+1}</td><td>${date}</td><td>${time}</td><td>${it.name||''}</td><td>${it.email||''}</td><td>${it.type||''}</td><td>${within?'Si':'No'}</td></tr>`;
        }).join('');
        const htmlDaily = `<!DOCTYPE html><html data-layout="global"><head><meta charset="utf-8"><title>${title}</title>
          <style>body{font-family:Arial,sans-serif;padding:24px} h1{font-size:18px;margin:0 0 12px} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ddd;padding:6px;font-size:12px} th{background:#f3f4f6;text-align:left}</style>
          <link rel="stylesheet" href="css/layout.css"><body>
          <h1>${title}</h1>
          <table><thead><tr><th>#</th><th>Fecha</th><th>Hora</th><th>Nombre</th><th>Email</th><th>Tipo</th><th>EnHorario</th></tr></thead>
          <tbody>${rows}</tbody></table>
          </body></html>`;
        w.document.write(htmlDaily);
        w.document.close();
        setTimeout(() => { try { w.focus(); w.print(); } catch(_){} }, 300);
      }

      document.getElementById('exportAttendanceCsvBtn')?.addEventListener('click', exportAttendanceCSV);
      document.getElementById('exportAttendancePdfBtn')?.addEventListener('click', exportAttendancePDF);

      // Valores por defecto para fechas
      const startInput = document.getElementById('attStartDate');
      const endInput = document.getElementById('attEndDate');
      const todayStr = new Date().toISOString().slice(0,10);
      if (startInput && !startInput.value) startInput.value = todayStr;
      if (endInput && !endInput.value) endInput.value = todayStr;

      async function exportRange(isPdf) {
        const start = startInput?.value;
        const end = endInput?.value;
        if (!start || !end || start > end) { alert('Selecciona un rango válido'); return; }
        const items = await fetchAttendancesByDateRange(start, end);
        if (!isPdf) {
          // CSV
          const header = ['Fecha','Hora','Nombre','Email','Tipo'];
          const rows = items.map(it => {
            const date = it.date || (it.timestamp ? it.timestamp.toISOString().slice(0,10) : '');
            const time = it.timestamp ? it.timestamp.toLocaleTimeString('es-MX',{hour12:false}) : '';
            return [date, time, (it.name||''), (it.email||''), (it.type||'')];
          });
          const csv = [header].concat(rows).map(r => r.map(v => '"'+String(v).replace('"','""')+'"').join(',')).join('\r\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `asistencias_${start}_a_${end}.csv`;
          a.click();
          URL.revokeObjectURL(a.href);
        } else {
          // PDF
          const w = window.open('', '_blank');
          const rows = items.map((it, idx) => {
            const date = it.date || (it.timestamp ? it.timestamp.toISOString().slice(0,10) : '');
            const time = it.timestamp ? it.timestamp.toLocaleTimeString('es-MX',{hour12:false}) : '';
            return `<tr><td>${idx+1}</td><td>${date}</td><td>${time}</td><td>${it.name||''}</td><td>${it.email||''}</td><td>${it.type||''}</td></tr>`;
          }).join('');
          const htmlRange = `<!DOCTYPE html><html data-layout="global"><head><meta charset='utf-8'><title>Asistencias ${start} a ${end}</title><style>body{font-family:Arial,sans-serif;padding:24px} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ddd;padding:6px;font-size:12px} th{background:#f3f4f6;text-align:left}</style><link rel="stylesheet" href="css/layout.css"><body><h1>Asistencias ${start} a ${end}</h1><table><thead><tr><th>#</th><th>Fecha</th><th>Hora</th><th>Nombre</th><th>Email</th><th>Tipo</th></tr></thead><tbody>${rows}</tbody></table></body></html>`;
          w.document.write(htmlRange);
          w.document.close();
          setTimeout(() => { try { w.focus(); w.print(); } catch(_){} }, 300);
        }
      }

      document.getElementById('exportAttendanceRangeCsvBtn')?.addEventListener('click', () => exportRange(false));
      document.getElementById('exportAttendanceRangePdfBtn')?.addEventListener('click', () => exportRange(true));
    </script>

<footer class="footer">
  <div class="footer-content">© 2024 · Plataforma QS - Calidad de Software | Isaac Paniagua</div>
</footer>
<script>
// Aplicar visibilidad por rol local (sin layout)
document.addEventListener('DOMContentLoaded', function(){
  try{
    var rol = (localStorage.getItem('qs_role')||'estudiante').toLowerCase();
    document.querySelectorAll('.teacher-only, .docente-only').forEach(function(el){ el.style.display = (rol==='docente') ? '' : 'none'; });
    document.querySelectorAll('.student-only, .estudiante-only').forEach(function(el){ el.style.display = (rol==='estudiante') ? '' : 'none'; });
  }catch(e){}
});
</script>
<script defer src="js/back-home.js"></script>
</body>
</html>











