<!DOCTYPE html>
<html lang="es">
  <head>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="css/layout.css">
    <meta charset="utf-8">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Materiales - Calidad de Software</title>
    <script src="js/student-nav-fixed.js"></script>
    <script>
      UPLOADCARE_PUBLIC_KEY = "85eb5471d305dcd08e71";
      UPLOADCARE_LOCALE = "es";
    </script>
    <script
      charset="utf-8"
      src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"
    ></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");
      body {
        font-family: "Inter", sans-serif;
        min-height: 100vh;
        background:
          radial-gradient(
            circle at 12% 18%,
            rgba(129, 140, 248, 0.25),
            transparent 55%
          ),
          radial-gradient(
            circle at 85% 12%,
            rgba(59, 130, 246, 0.22),
            transparent 52%
          ),
          linear-gradient(165deg, #f8fafc 0%, #eef2ff 55%, #fdf2f8 100%);
      }
      .main-container {
        background: white;
        border-radius: 2rem;
        margin: 2rem;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        position: relative;
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 2rem;
        text-align: center;
        position: relative;
      }
      .platform-title {
        font-size: 3rem;
        font-weight: 800;
        margin-bottom: 1rem;
      }
      .platform-subtitle {
        font-size: 1.5rem;
        opacity: 0.9;
        font-weight: 500;
      }
      .content-area {
        padding: 3rem 2rem;
      }
      .upload-form {
        background: #f8fafc;
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 3rem;
        border: 2px solid #e2e8f0;
      }
      .form-group {
        margin-bottom: 1.5rem;
      }
      .upload-form-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 1rem;
      }
      .form-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
      }
      .return-home-btn {
        position: fixed;
        left: 1rem;
        bottom: 1rem;
        z-index: 50;
        padding: 0.75rem 1.5rem;
        border-radius: 9999px;
        color: #ffffff;
        box-shadow: 0 10px 25px rgba(76, 29, 149, 0.35);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        text-decoration: none;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.5rem;
        font-size: 1rem;
      }
      .submit-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 1rem 2rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        font-weight: 700;
      }
      .materials-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 2rem;
      }
      .material-card {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        border: 2px solid #e2e8f0;
        display: flex;
        flex-direction: column;
      }
      .material-header {
        display: flex;
        align-items: flex-start;
        margin-bottom: 1rem;
      }
      .file-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        margin-right: 1rem;
        flex-shrink: 0;
      }
      .file-icon.pdf {
        background: linear-gradient(135deg, #dc2626, #991b1b);
      }
      .file-icon.doc {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
      }
      .file-icon.xls {
        background: linear-gradient(135deg, #16a34a, #15803d);
      }
      .file-icon.ppt {
        background: linear-gradient(135deg, #ea580c, #c2410c);
      }
      .file-icon.default {
        background: linear-gradient(135deg, #6b7280, #4b5563);
      }
      .material-title {
        font-size: 1.1rem;
        font-weight: 700;
      }
      .material-meta {
        color: #718096;
        font-size: 0.9rem;
        margin-bottom: 1rem;
      }
      .material-description {
        color: #4a5568;
        flex-grow: 1;
        margin-bottom: 1.5rem;
      }
      .material-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: auto;
      }
      .action-btn {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        font-weight: 600;
        color: white;
      }
      .download-btn {
        background: linear-gradient(135deg, #16a34a, #15803d);
        flex: 1;
      }
      .edit-btn {
        background: linear-gradient(135deg, #f59e0b, #d97706);
      }
      .delete-btn {
        background: linear-gradient(135deg, #dc2626, #991b1b);
      }
      .hidden {
        display: none !important;
      }
      .notification {
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        border-left: 4px solid #16a34a;
        z-index: 1000;
        transform: translateX(120%);
        transition: transform 0.3s ease-in-out;
      }
      .notification.show {
        transform: translateX(0);
      }
      .notification.error {
        border-left-color: #dc2626;
      }
    </style>
  </head>
  <body>
        <div class="qs-nav" data-role="main-nav">
      <div class="wrap">
        <div class="qs-brand-shell">
          <div class="qs-brand-region">
            <a class="qs-brand" href="index.html">
              <span class="qs-logo" aria-hidden="true">QS</span>
              <span class="qs-brand-text">
                <span class="qs-title">Calidad de Software</span>
                <span class="qs-subtitle">Campus QS</span>
              </span>
            </a>
            <span class="qs-chip">Edici√≥n 2024</span>
          </div>
          <button
            class="qs-menu-toggle"
            type="button"
            aria-expanded="false"
            aria-controls="qs-nav-links"
          >
            <span class="qs-menu-icon" aria-hidden="true"></span>
            <span class="sr-only">Abrir men√∫</span>
          </button>
        </div>
        <div class="qs-links-region">
          <nav
            class="qs-tabs"
            id="qs-nav-links"
            aria-label="Navegaci√≥n principal"
          >
            <a class="qs-btn" href="materiales.html">Materiales</a>
            <a class="qs-btn" href="asistencia.html">Asistencia</a>
            <a class="qs-btn" href="calificaciones.html">Calificaciones</a>
            <a class="qs-btn" href="Foro.html">Foro</a>
            <a class="qs-btn teacher-only" href="paneldocente.html" hidden aria-hidden="true">Panel</a>
          </nav>
        </div>
      </div>
    </div>

    <div class="main-container">
      <div class="header">
        <div class="header-content">
          <h1 class="platform-title">üìö Materiales de Curso</h1>
          <p class="platform-subtitle">
            Calidad de Software ¬∑ Recursos y Documentos
          </p>
        </div>
      </div>
      <div class="content-area">
        <div id="teacherView" class="hidden">
          <div class="upload-form">
            <h3 class="upload-form-title">
              Subir Nuevo Material
            </h3>
            <form id="materialForm">
              <div class="form-group">
                <label class="form-label" for="file-widget">Archivo</label
                ><input
                  type="hidden"
                  role="uploadcare-uploader"
                  name="content"
                  id="file-widget"
                />
              </div>
              <div class="form-group">
                <label class="form-label" for="materialTitle">T√≠tulo</label
                ><input
                  type="text"
                  class="form-input"
                  id="materialTitle"
                  required
                />
              </div>
              <div class="form-group">
                <label class="form-label" for="materialCategory"
                  >Categor√≠a</label
                ><select class="form-select" id="materialCategory" required>
                  <option value="presentations">Presentaciones</option>
                  <option value="templates">Plantillas</option>
                  <option value="exercises">Ejercicios</option>
                  <option value="references">Referencias</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label" for="materialDescription"
                  >Descripci√≥n</label
                ><textarea
                  class="form-textarea"
                  id="materialDescription"
                ></textarea>
              </div>
              <div class="form-group">
                <button type="submit" class="submit-btn">
                  Guardar Material
                </button>
              </div>
            </form>
          </div>
        </div>
        <div class="materials-grid" id="materialsGrid"></div>
        <div class="empty-state" id="emptyState">
          <p id="emptyMessage">Verificando usuario...</p>
        </div>
      </div>
    </div>
    <div class="notification" id="notification">
      <span id="notificationIcon">‚úÖ</span
      ><span id="notificationMessage"></span>
    </div>

    <!-- Bot√≥n de regreso al inicio para cualquier rol.  Otros m√≥dulos utilizan
         la navegaci√≥n fija generada por nav‚Äëinject.js, pero este bot√≥n
         adicional ofrece una ruta clara de regreso a la p√°gina principal en
         dispositivos m√≥viles.  Aparece en la esquina inferior izquierda. -->
    <a href="index.html"
       class="return-home-btn">
      ‚üµ Inicio
    </a>

    <script type="module">
      import { onAuth, isTeacherEmail } from "./js/firebase.js";
      import {
        getMaterials,
        saveMaterial,
        deleteMaterial,
        updateMaterial,
        incrementDownloads,
      } from "./js/materials-manager.js";

      let allMaterials = [];
      let currentUser = null;
      let isCurrentUserTeacher = false;
      let uploadcareWidget;

      const elements = {
        grid: document.getElementById("materialsGrid"),
        form: document.getElementById("materialForm"),
        teacherView: document.getElementById("teacherView"),
        notification: document.getElementById("notification"),
        notificationMessage: document.getElementById("notificationMessage"),
        emptyState: document.getElementById("emptyState"),
        emptyMessage: document.getElementById("emptyMessage"),
      };

      const essentialElementKeys = [
        "grid",
        "emptyState",
        "emptyMessage",
        "notification",
        "notificationMessage",
      ];

      const missingEssentialElements = essentialElementKeys.filter(
        (key) => !elements[key]
      );

      if (missingEssentialElements.length > 0) {
        console.error(
          "materiales.html: faltan elementos esenciales en el DOM",
          missingEssentialElements
        );
      }

      onAuth(async (user) => {
        if (user) {
          currentUser = user;
          isCurrentUserTeacher = isTeacherEmail(user.email);
          await initializeApp();
        } else {
          window.location.href = "index.html";
        }
      });

      async function initializeApp() {
        if (missingEssentialElements.length > 0) {
          return;
        }
        // Inicializa el widget DESPU√âS de que sabemos que el usuario es un profesor
        if (isCurrentUserTeacher && elements.form) {
          uploadcareWidget = uploadcare.Widget("#file-widget");
          elements.form.addEventListener("submit", handleFormSubmit);
        }

        if (elements.grid) {
          elements.grid.addEventListener("click", handleGridClick);
        }

        try {
          allMaterials = await getMaterials();
          render();
        } catch (error) {
          console.error("Error al inicializar:", error);
          showNotification("error", "No se pudieron cargar los materiales.");
          if (elements.emptyMessage) {
            elements.emptyMessage.textContent =
              "Error al cargar. Revisa los permisos.";
          }
        }

        applyRoleVisibility();
      }

      function render() {
        if (!elements.grid || !elements.emptyState || !elements.emptyMessage) {
          return;
        }
        elements.grid.innerHTML = "";
        if (allMaterials.length === 0) {
          elements.emptyState.classList.remove("hidden");
          elements.emptyMessage.textContent =
            "A√∫n no hay materiales disponibles.";
          return;
        }
        elements.emptyState.classList.add("hidden");
        allMaterials.forEach((material) => {
          elements.grid.insertAdjacentHTML(
            "beforeend",
            createMaterialCard(material)
          );
        });
        applyRoleVisibility();
      }

      function createMaterialCard(material) {
        const fileInfo = getFileInfo(material);
        const date = material.createdAt?.toDate
          ? material.createdAt.toDate().toLocaleDateString("es-MX")
          : new Date().toLocaleDateString("es-MX");
        const url = material.url || material.downloadUrl;
        return `
                <div class="material-card">
                    <div class="material-header">
                        <div class="file-icon ${fileInfo.className}">${
          fileInfo.label
        }</div>
                        <div><h4 class="material-title">${escapeHtml(
                          material.title
                        )}</h4><p class="material-meta">${date} ¬∑ ${
          material.downloads || 0
        } descargas</p></div>
                    </div>
                    <p class="material-description">${escapeHtml(
                      material.description || "Sin descripci√≥n."
                    )}</p>
                    <div class="material-actions">
                        <button class="action-btn download-btn" data-id="${
                          material.id
                        }" data-url="${url}">‚¨áÔ∏è Descargar</button>
                        <button class="action-btn edit-btn teacher-only" data-id="${
                          material.id
                        }">‚úèÔ∏è Editar</button>
                        <button class="action-btn delete-btn teacher-only" data-id="${
                          material.id
                        }">üóëÔ∏è Eliminar</button>
                    </div>
                </div>`;
      }

      async function handleFormSubmit(event) {
        event.preventDefault();
        const title = document.getElementById("materialTitle").value.trim();
        if (!title) return showNotification("error", "El t√≠tulo es requerido.");

        const fileInfo = uploadcareWidget.value();
        if (!fileInfo)
          return showNotification("error", "Debes seleccionar un archivo.");

        showNotification("info", "Subiendo archivo...");
        fileInfo.done(async (file) => {
          const newMaterialData = {
            title,
            category: document.getElementById("materialCategory").value,
            description: document
              .getElementById("materialDescription")
              .value.trim(),
            url: file.cdnUrl,
            fileName: file.name,
            extension: file.name.split(".").pop().toLowerCase() || "",
            downloads: 0,
          };
          try {
            const savedMaterial = await saveMaterial(newMaterialData);
            allMaterials.unshift(savedMaterial);
            render();
            elements.form.reset();
            uploadcareWidget.value(null);
            showNotification("success", "Material guardado.");
          } catch (error) {
            showNotification("error", "No se pudo guardar.");
            console.error(error);
          }
        });
      }

      async function handleGridClick(event) {
        const button = event.target.closest(".action-btn");
        if (!button) return;
        const id = button.dataset.id;
        if (button.classList.contains("download-btn")) {
          window.open(button.dataset.url, "_blank");
          await incrementDownloads(id);
          const mat = allMaterials.find((m) => m.id === id);
          if (mat) mat.downloads = (mat.downloads || 0) + 1;
          render();
        } else if (button.classList.contains("delete-btn")) {
          if (!confirm("¬øSeguro que quieres eliminar este material?")) return;
          try {
            await deleteMaterial(id);
            allMaterials = allMaterials.filter((m) => m.id !== id);
            render();
            showNotification("success", "Material eliminado.");
          } catch (error) {
            showNotification("error", "No se pudo eliminar.");
          }
        } else if (button.classList.contains("edit-btn")) {
          const material = allMaterials.find((m) => m.id === id);
          const newTitle = prompt("Nuevo t√≠tulo:", material.title);
          const newDescription = prompt(
            "Nueva descripci√≥n:",
            material.description
          );
          if (newTitle === null || newDescription === null) return;
          try {
            await updateMaterial(id, newTitle.trim(), newDescription.trim());
            material.title = newTitle.trim();
            material.description = newDescription.trim();
            render();
            showNotification("success", "Material actualizado.");
          } catch (error) {
            showNotification("error", "No se pudo actualizar.");
          }
        }
      }

      function applyRoleVisibility() {
        const shouldShowTeacherContent = isCurrentUserTeacher;
        if (elements.teacherView) {
          elements.teacherView.classList.toggle(
            "hidden",
            !shouldShowTeacherContent
          );
        }
        document.querySelectorAll(".teacher-only").forEach((el) => {
          const hideElement = !shouldShowTeacherContent;
          el.classList.toggle("hidden", hideElement);
          if (hideElement) {
            el.setAttribute("hidden", "true");
            el.setAttribute("aria-hidden", "true");
          } else {
            el.removeAttribute("hidden");
            el.removeAttribute("aria-hidden");
          }
        });
      }

      function getFileInfo(material) {
        const ext = material.extension || "";
        const map = {
          pdf: "pdf",
          doc: "doc",
          docx: "doc",
          xls: "xls",
          xlsx: "xls",
          ppt: "ppt",
          pptx: "ppt",
        };
        return { className: map[ext] || "default", label: ext.toUpperCase() };
      }
      function escapeHtml(str) {
        const p = document.createElement("p");
        p.textContent = str;
        return p.innerHTML;
      }
      function showNotification(type, message) {
        if (!elements.notification || !elements.notificationMessage) {
          console.warn("materiales.html: no se encontr√≥ el contenedor de notificaciones.");
          return;
        }
        elements.notificationMessage.textContent = message;
        elements.notification.className = `notification ${
          type === "error" ? "error" : ""
        }`;
        elements.notification.classList.add("show");
        setTimeout(() => elements.notification.classList.remove("show"), 3000);
      }
    </script>
      <script defer src="js/nav-inject.js"></script>
</body>
</html>

