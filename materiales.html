<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Materiales - Calidad de Software</title>
    
    <link rel="stylesheet" href="../css/layout.css">
    <script src="../js/layout.js" defer></script>
    <script src="../js/nav-inject.js" defer></script>
    
    <script>
      UPLOADCARE_PUBLIC_KEY = '85eb5471d305dcd08e71';
      UPLOADCARE_LOCALE = 'es';
    </script>
    <script charset="utf-8" src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>

    <style>
      .role-toggle { display: flex; gap: 0.5rem; margin-bottom: 2rem; justify-content: center; }
      .role-btn { padding: 0.75rem 1.5rem; border-radius: 9999px; background-color: #f3f4f6; border: 1px solid #d1d5db; cursor: pointer; font-weight: 600; transition: all 0.2s ease-in-out; }
      .role-btn.active { background-color: var(--primary-color, #4a67e2); color: white; border-color: var(--primary-color, #4a67e2); }
      
      .upload-form { background: white; border-radius: 1rem; padding: 2rem; margin-bottom: 3rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
      .form-group { margin-bottom: 1.5rem; }
      .form-label { display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem; }
      .form-input, .form-select, .form-textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; }
      .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--primary-color, #4a67e2); box-shadow: 0 0 0 3px rgba(74, 103, 226, 0.2); outline: none; }
      .submit-btn { background-color: var(--primary-color, #4a67e2); color: white; padding: 1rem 2rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 700; transition: background-color 0.2s ease-in-out; }
      .submit-btn:hover { background-color: var(--primary-dark, #3b51b3); }

      .materials-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
      .material-card { background: white; border-radius: 1rem; padding: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); display: flex; flex-direction: column; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
      .material-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
      
      .material-header { display: flex; align-items: flex-start; margin-bottom: 1rem; }
      .file-icon { width: 3rem; height: 3rem; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem; margin-right: 1rem; flex-shrink: 0; font-weight: bold; }
      .file-icon.pdf { background-color: #dc2626; }
      .file-icon.doc { background-color: #2563eb; }
      .file-icon.xls { background-color: #16a34a; }
      .file-icon.ppt { background-color: #ea580c; }
      .file-icon.default { background-color: #6b7280; }
      
      .material-title { font-size: 1.1rem; font-weight: 700; color: #1f2937; }
      .material-meta { color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem; }
      .material-description { color: #4b5563; flex-grow: 1; margin-bottom: 1.5rem; font-size: 0.9rem; line-height: 1.5; }
      
      .material-actions { display: flex; gap: 0.5rem; margin-top: auto; }
      .action-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 600; color: white; transition: transform 0.2s ease-in-out; }
      .action-btn:hover { transform: scale(1.05); }
      .download-btn { background-color: #16a34a; flex: 1; }
      .edit-btn { background-color: #f59e0b; }
      .delete-btn { background-color: #dc2626; }
      
      .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="main-nav"></div>
    
    <main class="container">
        <header class="page-header">
            <h1>üìö Materiales de Curso</h1>
            <p>Recursos y documentos de la materia.</p>
        </header>
        
        <div class="role-toggle">
          <button type="button" class="role-btn" id="teacherBtn">üë©‚Äçüè´ Profesor</button>
          <button type="button" class="role-btn active" id="studentBtn">üßë‚Äçüéì Estudiante</button>
        </div>

        <section id="teacherView" class="hidden">
            <div class="upload-form">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Subir Nuevo Material</h3>
                <form id="materialForm">
                    <div class="form-group"><label class="form-label" for="file-widget">Archivo</label><input type="hidden" role="uploadcare-uploader" name="content" id="file-widget" /></div>
                    <div class="form-group"><label class="form-label" for="materialTitle">T√≠tulo</label><input type="text" class="form-input" id="materialTitle" required /></div>
                    <div class="form-group"><label class="form-label" for="materialCategory">Categor√≠a</label><select class="form-select" id="materialCategory" required><option value="presentations">Presentaciones</option><option value="templates">Plantillas</option><option value="exercises">Ejercicios</option><option value="references">Referencias</option></select></div>
                    <div class="form-group"><label class="form-label" for="materialDescription">Descripci√≥n</label><textarea class="form-textarea" id="materialDescription"></textarea></div>
                    <div class="form-group"><button type="submit" class="submit-btn">Guardar Material</button></div>
                </form>
            </div>
        </section>
        
        <section class="materials-grid" id="materialsGrid"></section>
        
        <div class="empty-state hidden" id="emptyState">
            <p id="emptyMessage">Verificando usuario...</p>
        </div>
    </main>
    
    <div id="main-footer"></div>
    
    <div id="notification-toast" class="notification-toast"></div>

    <script type="module">
        import { onAuth, isTeacherEmail } from './js/firebase.js';
        import { getMaterials, saveMaterial, deleteMaterial, updateMaterial, incrementDownloads } from './js/materials-manager.js';

        let allMaterials = [];
        let currentUser = null;
        let isCurrentUserTeacher = false;
        let currentRole = 'student';
        let uploadcareWidget;

        const elements = {
            grid: document.getElementById('materialsGrid'),
            form: document.getElementById('materialForm'),
            teacherView: document.getElementById('teacherView'),
            teacherBtn: document.getElementById('teacherBtn'),
            studentBtn: document.getElementById('studentBtn'),
            emptyState: document.getElementById('emptyState'),
            emptyMessage: document.getElementById('emptyMessage'),
        };

        onAuth(async (user) => {
            if (user) {
                currentUser = user;
                isCurrentUserTeacher = isTeacherEmail(user.email);
                await initializeApp();
            } else {
                window.location.href = '../index.html';
            }
        });

        async function initializeApp() {
            if (isCurrentUserTeacher) {
                uploadcareWidget = uploadcare.Widget('#file-widget');
                elements.form.addEventListener('submit', handleFormSubmit);
            }
            elements.grid.addEventListener('click', handleGridClick);
            elements.teacherBtn.addEventListener('click', () => switchRole('teacher'));
            elements.studentBtn.addEventListener('click', () => switchRole('student'));
            
            try {
                allMaterials = await getMaterials();
            } catch (error) {
                console.error("Error al cargar materiales:", error);
                elements.emptyMessage.textContent = 'Error al cargar los materiales.';
                showNotification('error', 'No se pudieron cargar los materiales.');
            }
            
            if (isCurrentUserTeacher) {
                switchRole('teacher');
            } else {
                switchRole('student');
            }
            render();
        }

        function render() {
            elements.grid.innerHTML = '';
            elements.emptyState.classList.toggle('hidden', allMaterials.length > 0);
            if(allMaterials.length === 0) {
                elements.emptyMessage.textContent = 'A√∫n no hay materiales disponibles.';
            }
            allMaterials.forEach(material => {
                elements.grid.insertAdjacentHTML('beforeend', createMaterialCard(material));
            });
            applyRoleVisibility();
        }

        function createMaterialCard(material) {
            const fileInfo = getFileInfo(material);
            const date = material.createdAt?.toDate ? material.createdAt.toDate().toLocaleDateString('es-MX') : new Date().toLocaleDateString('es-MX');
            const url = material.url || material.downloadUrl;
            return `
                <div class="material-card">
                    <div class="material-header">
                        <div class="file-icon ${fileInfo.className}">${fileInfo.label}</div>
                        <div><h4 class="material-title">${escapeHtml(material.title)}</h4><p class="material-meta">${date} ¬∑ ${material.downloads || 0} descargas</p></div>
                    </div>
                    <p class="material-description">${escapeHtml(material.description || 'Sin descripci√≥n.')}</p>
                    <div class="material-actions">
                        <button class="action-btn download-btn" data-id="${material.id}" data-url="${url}">‚¨áÔ∏è Descargar</button>
                        <button class="action-btn edit-btn teacher-only" data-id="${material.id}">‚úèÔ∏è Editar</button>
                        <button class="action-btn delete-btn teacher-only" data-id="${material.id}">üóëÔ∏è Eliminar</button>
                    </div>
                </div>`;
        }
        
        async function handleFormSubmit(event) {
            event.preventDefault();
            const title = document.getElementById('materialTitle').value.trim();
            if (!title) return showNotification('error', 'El t√≠tulo es requerido.');
            
            const fileInfo = uploadcareWidget.value();
            if (!fileInfo) return showNotification('error', 'Debes seleccionar un archivo.');
            
            showNotification('info', 'Subiendo archivo...');
            fileInfo.done(async (file) => {
                const newMaterialData = { title, category: document.getElementById('materialCategory').value, description: document.getElementById('materialDescription').value.trim(), url: file.cdnUrl, fileName: file.name, extension: file.name.split('.').pop().toLowerCase() || '', downloads: 0 };
                try {
                    const savedMaterial = await saveMaterial(newMaterialData);
                    allMaterials.unshift(savedMaterial);
                    render();
                    elements.form.reset();
                    uploadcareWidget.value(null);
                    showNotification('success', 'Material guardado.');
                } catch (error) { showNotification('error', 'No se pudo guardar.'); console.error(error); }
            });
        }
        
        async function handleGridClick(event) {
            const button = event.target.closest('.action-btn');
            if (!button) return;
            const id = button.dataset.id;
            if (button.classList.contains('download-btn')) {
                window.open(button.dataset.url, '_blank');
                try {
                  await incrementDownloads(id);
                  const mat = allMaterials.find(m => m.id === id);
                  if(mat) mat.downloads = (mat.downloads || 0) + 1;
                  render();
                } catch (e) { console.warn("No se pudo incrementar el contador de descargas (puede ser un estudiante).")}
            } else if (button.classList.contains('delete-btn')) {
                if (!confirm('¬øSeguro que quieres eliminar este material?')) return;
                try {
                    await deleteMaterial(id);
                    allMaterials = allMaterials.filter(m => m.id !== id);
                    render();
                    showNotification('success', 'Material eliminado.');
                } catch (error) { showNotification('error', 'No se pudo eliminar.'); }
            } else if (button.classList.contains('edit-btn')) {
                const material = allMaterials.find(m => m.id === id);
                const newTitle = prompt('Nuevo t√≠tulo:', material.title);
                const newDescription = prompt('Nueva descripci√≥n:', material.description);
                if (newTitle === null || newDescription === null) return;
                try {
                    await updateMaterial(id, newTitle.trim(), newDescription.trim());
                    material.title = newTitle.trim();
                    material.description = newDescription.trim();
                    render();
                    showNotification('success', 'Material actualizado.');
                } catch (error) { showNotification('error', 'No se pudo actualizar.'); }
            }
        }

        function switchRole(newRole) {
            if (!isCurrentUserTeacher && newRole === 'teacher') return;
            currentRole = newRole;
            elements.teacherBtn.classList.toggle('active', newRole === 'teacher');
            elements.studentBtn.classList.toggle('active', newRole === 'student');
            applyRoleVisibility();
        }

        function applyRoleVisibility() {
            elements.teacherView.classList.toggle('hidden', currentRole !== 'teacher');
            document.querySelectorAll('.teacher-only').forEach(el => {
                el.classList.toggle('hidden', currentRole !== 'teacher');
            });
        }
        
        function getFileInfo(material) { const ext = material.extension || ''; const map = { pdf: "pdf", doc: "doc", docx: "doc", xls: "xls", xlsx: "xls", ppt: "ppt", pptx: "ppt" }; return { className: map[ext] || "default", label: ext.toUpperCase() }; }
        function escapeHtml(str) { const p = document.createElement("p"); p.textContent = str; return p.innerHTML; }
        
        // Funci√≥n para mostrar notificaciones (puede que ya la tengas en layout.js)
        function showNotification(type, message) {
            const toast = document.getElementById('notification-toast');
            if (window.showToast) { // Usa la funci√≥n global si existe
                window.showToast(message, type);
            } else { // Fallback simple
                toast.textContent = message;
                toast.className = `notification-toast show ${type}`;
                setTimeout(() => { toast.classList.remove('show'); }, 3000);
            }
        }
    </script>
</body>
</html>
