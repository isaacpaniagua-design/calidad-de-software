<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Materiales - Calidad de Software</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      UPLOADCARE_PUBLIC_KEY = "85eb5471d305dcd08e71";
      UPLOADCARE_LOCALE = "es";
    </script>
    <script
      charset="utf-8"
      src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"
    ></script>
    <script type="module" src="./js/role-gate.js"></script>
    <style>
      /* Tu CSS existente va aquí, no necesita cambios. */
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background: #764ba2;
        min-height: 100vh;
      }
      .main-container {
        background: white;
        border-radius: 2rem;
        margin: 2rem;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        position: relative;
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 2rem;
        text-align: center;
        position: relative;
      }
      .platform-title {
        font-size: 3rem;
        font-weight: 800;
        margin-bottom: 1rem;
      }
      .platform-subtitle {
        font-size: 1.5rem;
        opacity: 0.9;
        font-weight: 500;
      }
      .role-toggle {
        position: absolute;
        top: 2rem;
        right: 2rem;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border-radius: 2rem;
        padding: 0.5rem;
        display: flex;
        gap: 0.5rem;
      }
      .role-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 1.5rem;
        background: transparent;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 600;
      }
      .role-btn.active {
        background: white;
        color: #764ba2;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
      .content-area {
        padding: 3rem 2rem;
      }
      .upload-form {
        background: #f8fafc;
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 3rem;
        border: 2px solid #e2e8f0;
      }
      .form-group {
        margin-bottom: 1.5rem;
      }
      .form-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
      }
      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.5rem;
        font-size: 1rem;
      }
      .submit-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 1rem 2rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        font-weight: 700;
      }
      .materials-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 2rem;
      }
      .material-card {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        border: 2px solid #e2e8f0;
        display: flex;
        flex-direction: column;
      }
      .material-header {
        display: flex;
        align-items: flex-start;
        margin-bottom: 1rem;
      }
      .file-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        margin-right: 1rem;
        flex-shrink: 0;
      }
      .file-icon.pdf {
        background: linear-gradient(135deg, #dc2626, #991b1b);
      }
      .file-icon.doc {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
      }
      .file-icon.xls {
        background: linear-gradient(135deg, #16a34a, #15803d);
      }
      .file-icon.ppt {
        background: linear-gradient(135deg, #ea580c, #c2410c);
      }
      .file-icon.default {
        background: linear-gradient(135deg, #6b7280, #4b5563);
      }
      .material-title {
        font-size: 1.1rem;
        font-weight: 700;
      }
      .material-meta {
        color: #718096;
        font-size: 0.9rem;
        margin-bottom: 1rem;
      }
      .material-description {
        color: #4a5568;
        flex-grow: 1;
        margin-bottom: 1.5rem;
      }
      .material-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: auto;
      }
      .action-btn {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        font-weight: 600;
        color: white;
      }
      .download-btn {
        background: linear-gradient(135deg, #16a34a, #15803d);
        flex: 1;
      }
      .edit-btn {
        background: linear-gradient(135deg, #f59e0b, #d97706);
      }
      .delete-btn {
        background: linear-gradient(135deg, #dc2626, #991b1b);
      }
      .hidden {
        display: none !important;
      }
      .notification {
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        border-left: 4px solid #16a34a;
        z-index: 1000;
        transform: translateX(120%);
        transition: transform 0.3s ease-in-out;
      }
      .notification.show {
        transform: translateX(0);
      }
      .notification.error {
        border-left-color: #dc2626;
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <div class="header">
        <div class="role-toggle">
          <button type="button" class="role-btn active" id="teacherBtn">
            👩‍🏫 Profesor
          </button>
          <button type="button" class="role-btn" id="studentBtn">
            🧑‍🎓 Estudiante
          </button>
        </div>
        <div class="header-content">
          <h1 class="platform-title">📚 Materiales de Curso</h1>
          <p class="platform-subtitle">
            Calidad de Software · Recursos y Documentos
          </p>
        </div>
      </div>

      <div class="content-area">
        <div id="teacherView">
          <div class="upload-form">
            <h3 class="text-xl font-bold text-gray-800 mb-4">
              Subir Nuevo Material
            </h3>
            <form id="materialForm">
              <div class="form-group">
                <label class="form-label" for="file-widget">Archivo</label>
                <input
                  type="hidden"
                  role="uploadcare-uploader"
                  name="content"
                  id="file-widget"
                />
              </div>
              <div class="form-group">
                <label class="form-label" for="materialTitle">Título</label>
                <input
                  type="text"
                  class="form-input"
                  id="materialTitle"
                  required
                />
              </div>
              <div class="form-group">
                <label class="form-label" for="materialCategory"
                  >Categoría</label
                >
                <select class="form-select" id="materialCategory" required>
                  <option value="presentations">Presentaciones</option>
                  <option value="templates">Plantillas</option>
                  <option value="exercises">Ejercicios</option>
                  <option value="references">Referencias</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label" for="materialDescription"
                  >Descripción</label
                >
                <textarea
                  class="form-textarea"
                  id="materialDescription"
                ></textarea>
              </div>
              <div class="form-group">
                <button type="submit" class="submit-btn">
                  Guardar Material
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="materials-grid" id="materialsGrid"></div>
        <div class="empty-state hidden" id="emptyState">
          <p id="emptyMessage">Cargando materiales...</p>
        </div>
      </div>
    </div>

    <div class="notification" id="notification">
      <span id="notificationIcon">✅</span>
      <span id="notificationMessage">Operación exitosa</span>
    </div>

    <script type="module">
      import {
        getMaterials,
        saveMaterial,
        deleteMaterial,
        updateMaterial,
        incrementDownloads,
      } from "./js/materials-manager.js";

      // --- STATE & ELEMENTS ---
      let allMaterials = [];
      let currentRole = "student"; // 'student' or 'teacher'
      const elements = {
        grid: document.getElementById("materialsGrid"),
        form: document.getElementById("materialForm"),
        teacherView: document.getElementById("teacherView"),
        teacherBtn: document.getElementById("teacherBtn"),
        studentBtn: document.getElementById("studentBtn"),
        notification: document.getElementById("notification"),
        notificationIcon: document.getElementById("notificationIcon"),
        notificationMessage: document.getElementById("notificationMessage"),
      };
      const uploadcareWidget = uploadcare.Widget("#file-widget");

      // --- RENDERING ---
      function render() {
        elements.grid.innerHTML = "";
        if (allMaterials.length === 0) {
          document.getElementById("emptyState").classList.remove("hidden");
          document.getElementById("emptyMessage").textContent =
            "Aún no hay materiales disponibles.";
          return;
        }
        document.getElementById("emptyState").classList.add("hidden");

        allMaterials.forEach((material) => {
          const card = createMaterialCard(material);
          elements.grid.insertAdjacentHTML("beforeend", card);
        });
        applyRoleVisibility();
      }

      function createMaterialCard(material) {
        const fileInfo = getFileInfo(material);
        const date = new Date(material.createdAt).toLocaleDateString("es-MX");
        const description = material.description || "Sin descripción.";

        return `
                <div class="material-card">
                    <div class="material-header">
                        <div class="file-icon ${fileInfo.className}">${
          fileInfo.label
        }</div>
                        <div>
                            <h4 class="material-title">${escapeHtml(
                              material.title
                            )}</h4>
                            <p class="material-meta">${date} · ${
          material.downloads || 0
        } descargas</p>
                        </div>
                    </div>
                    <p class="material-description">${escapeHtml(
                      description
                    )}</p>
                    <div class="material-actions">
                        <button class="action-btn download-btn" data-id="${
                          material.id
                        }" data-url="${
          material.downloadUrl
        }">⬇️ Descargar</button>
                        <button class="action-btn edit-btn teacher-only" data-id="${
                          material.id
                        }">✏️ Editar</button>
                        <button class="action-btn delete-btn teacher-only" data-id="${
                          material.id
                        }">🗑️ Eliminar</button>
                    </div>
                </div>
            `;
      }

      // --- EVENT HANDLERS ---
      async function handleFormSubmit(event) {
        event.preventDefault();
        const title = document.getElementById("materialTitle").value.trim();
        if (!title) return showNotification("error", "El título es requerido.");

        const fileInfo = uploadcareWidget.value();
        if (!fileInfo)
          return showNotification("error", "Debes seleccionar un archivo.");

        showNotification("info", "Subiendo archivo...");

        fileInfo.done(async (file) => {
          const newMaterialData = {
            title,
            category: document.getElementById("materialCategory").value,
            description: document
              .getElementById("materialDescription")
              .value.trim(),
            downloadUrl: file.cdnUrl,
            fileName: file.name,
            extension: file.name.split(".").pop().toLowerCase() || "",
            createdAt: new Date().toISOString(),
            downloads: 0,
          };

          try {
            const savedMaterial = await saveMaterial(newMaterialData);
            allMaterials.unshift(savedMaterial);
            render();
            elements.form.reset();
            uploadcareWidget.value(null);
            showNotification("success", "Material guardado con éxito.");
          } catch (error) {
            console.error("Error guardando material:", error);
            showNotification("error", "No se pudo guardar el material.");
          }
        });
      }

      async function handleGridClick(event) {
        const button = event.target.closest(".action-btn");
        if (!button) return;

        const id = button.dataset.id;
        if (button.classList.contains("download-btn")) {
          window.open(button.dataset.url, "_blank");
          await incrementDownloads(id);
          const mat = allMaterials.find((m) => m.id === id);
          if (mat) mat.downloads++;
          render();
        } else if (button.classList.contains("delete-btn")) {
          if (!confirm("¿Estás seguro de que quieres eliminar este material?"))
            return;
          try {
            await deleteMaterial(id);
            allMaterials = allMaterials.filter((m) => m.id !== id);
            render();
            showNotification("success", "Material eliminado.");
          } catch (error) {
            showNotification("error", "No se pudo eliminar.");
          }
        } else if (button.classList.contains("edit-btn")) {
          const material = allMaterials.find((m) => m.id === id);
          const newTitle = prompt("Nuevo título:", material.title);
          const newDescription = prompt(
            "Nueva descripción:",
            material.description
          );
          if (newTitle === null || newDescription === null) return;
          try {
            await updateMaterial(id, newTitle, newDescription);
            material.title = newTitle;
            material.description = newDescription;
            render();
            showNotification("success", "Material actualizado.");
          } catch (error) {
            showNotification("error", "No se pudo actualizar.");
          }
        }
      }

      function switchRole(newRole) {
        currentRole = newRole;
        elements.teacherBtn.classList.toggle("active", newRole === "teacher");
        elements.studentBtn.classList.toggle("active", newRole === "student");
        applyRoleVisibility();
      }

      function applyRoleVisibility() {
        elements.teacherView.classList.toggle(
          "hidden",
          currentRole !== "teacher"
        );
        document.querySelectorAll(".teacher-only").forEach((el) => {
          el.classList.toggle("hidden", currentRole !== "teacher");
        });
      }

      // --- UTILS ---
      function getFileInfo(material) {
        const ext = material.extension || "";
        const map = {
          pdf: "pdf",
          doc: "doc",
          docx: "doc",
          xls: "xls",
          xlsx: "xls",
          ppt: "ppt",
          pptx: "ppt",
        };
        return { className: map[ext] || "default", label: ext.toUpperCase() };
      }
      function escapeHtml(str) {
        const p = document.createElement("p");
        p.textContent = str;
        return p.innerHTML;
      }
      function showNotification(type, message) {
        elements.notificationMessage.textContent = message;
        elements.notification.className = `notification ${
          type === "error" ? "error" : ""
        }`;
        elements.notification.classList.add("show");
        setTimeout(() => elements.notification.classList.remove("show"), 3000);
      }

      // --- INITIALIZATION ---
      async function initialize() {
        elements.form.addEventListener("submit", handleFormSubmit);
        elements.grid.addEventListener("click", handleGridClick);
        elements.teacherBtn.addEventListener("click", () =>
          switchRole("teacher")
        );
        elements.studentBtn.addEventListener("click", () =>
          switchRole("student")
        );

        try {
          allMaterials = await getMaterials();
          render();
        } catch (error) {
          console.error("Error al inicializar:", error);
          showNotification("error", "No se pudieron cargar los materiales.");
          document.getElementById("emptyMessage").textContent =
            "Error al cargar los materiales.";
        }

        // Inicia en la vista de estudiante por defecto
        switchRole("student");
      }

      initialize();
    </script>
  </body>
</html>
