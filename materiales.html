<!DOCTYPE html>
<html lang="es" data-layout="global">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Materiales - Calidad de Software</title>
    <link rel="stylesheet" href="css/layout.css" />
    <script>
      UPLOADCARE_PUBLIC_KEY = "85eb5471d305dcd08e71";
      UPLOADCARE_LOCALE = "es";
    </script>
    <script
      src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"
      charset="utf-8"
      defer
    ></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        min-height: 100vh;
        background:
          radial-gradient(circle at 12% 18%, rgba(129, 140, 248, 0.25), transparent 55%),
          radial-gradient(circle at 85% 12%, rgba(59, 130, 246, 0.22), transparent 52%),
          linear-gradient(165deg, #f8fafc 0%, #eef2ff 55%, #fdf2f8 100%);
      }

      main {
        display: flex;
        justify-content: center;
        padding: clamp(24px, 5vw, 64px) clamp(12px, 5vw, 48px) 120px;
      }

      .materials-shell {
        width: min(1200px, 100%);
        background: rgba(255, 255, 255, 0.96);
        border-radius: clamp(24px, 4vw, 32px);
        box-shadow: 0 24px 64px rgba(15, 23, 42, 0.18);
        overflow: hidden;
        border: 1px solid rgba(99, 102, 241, 0.12);
        display: flex;
        flex-direction: column;
      }

      .materials-hero {
        position: relative;
        padding: clamp(40px, 8vw, 72px) clamp(32px, 8vw, 72px);
        color: #fff;
        background: linear-gradient(135deg, #6366f1 0%, #7c3aed 48%, #0ea5e9 100%);
      }

      .materials-hero::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 18% 24%, rgba(255, 255, 255, 0.22), transparent 60%),
          radial-gradient(circle at 82% 30%, rgba(14, 165, 233, 0.22), transparent 65%);
        opacity: 0.9;
        pointer-events: none;
      }

      .materials-hero > * {
        position: relative;
        z-index: 1;
      }

      .materials-hero h1 {
        margin: 0;
        font-size: clamp(2.5rem, 5vw, 3.5rem);
        font-weight: 800;
      }

      .materials-hero p {
        margin-top: 12px;
        font-size: clamp(1.125rem, 2.4vw, 1.4rem);
        max-width: 680px;
        line-height: 1.7;
        color: rgba(255, 255, 255, 0.9);
      }

      .materials-content {
        padding: clamp(32px, 6vw, 64px);
        display: grid;
        gap: clamp(32px, 6vw, 48px);
      }

      .teacher-panel {
        background: rgba(248, 250, 252, 0.82);
        border-radius: clamp(18px, 3vw, 26px);
        border: 1px solid rgba(148, 163, 184, 0.28);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5);
        padding: clamp(24px, 4vw, 40px);
        backdrop-filter: blur(6px);
        display: grid;
        gap: clamp(18px, 4vw, 28px);
      }

      .teacher-panel h3 {
        margin: 0;
        font-size: clamp(1.4rem, 3vw, 1.8rem);
        font-weight: 700;
        color: #1f2937;
      }

      .form-grid {
        display: grid;
        gap: clamp(18px, 3vw, 24px);
      }

      .form-group {
        display: grid;
        gap: 8px;
      }

      .form-label {
        font-weight: 600;
        color: #334155;
        font-size: 0.95rem;
      }

      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.38);
        padding: 14px 16px;
        font-size: 1rem;
        background: rgba(255, 255, 255, 0.9);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .form-textarea {
        min-height: 140px;
        resize: vertical;
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: rgba(99, 102, 241, 0.75);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.18);
        background: #fff;
      }

      .submit-btn {
        align-self: flex-start;
        padding: 14px 28px;
        border-radius: 12px;
        border: none;
        font-weight: 700;
        font-size: 1rem;
        color: #fff;
        background: linear-gradient(135deg, #6366f1, #7c3aed);
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 32px rgba(99, 102, 241, 0.28);
      }

      .materials-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: clamp(24px, 4vw, 32px);
        align-items: stretch;
      }

      .material-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: clamp(18px, 3vw, 24px);
        border: 1px solid rgba(203, 213, 225, 0.45);
        padding: clamp(24px, 4vw, 32px);
        display: flex;
        flex-direction: column;
        gap: clamp(16px, 3vw, 20px);
        box-shadow: 0 18px 42px rgba(15, 23, 42, 0.12);
        height: 100%;
      }

      .material-header {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 16px;
        align-items: start;
      }

      .file-icon {
        width: 56px;
        height: 56px;
        border-radius: 18px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        font-weight: 700;
        color: #fff;
      }

      .file-icon.pdf {
        background: linear-gradient(135deg, #dc2626, #991b1b);
      }

      .file-icon.doc {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
      }

      .file-icon.xls {
        background: linear-gradient(135deg, #16a34a, #15803d);
      }

      .file-icon.ppt {
        background: linear-gradient(135deg, #ea580c, #c2410c);
      }

      .file-icon.default {
        background: linear-gradient(135deg, #64748b, #475569);
      }

      .material-title {
        margin: 0 0 6px;
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
      }

      .material-meta {
        margin: 0;
        color: #64748b;
        font-size: 0.95rem;
      }

      .material-description {
        margin: 0;
        color: #475569;
        line-height: 1.7;
        flex: 1;
      }

      .material-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(0, 1fr));
        gap: 12px;
      }

      .action-btn {
        border: none;
        border-radius: 12px;
        padding: 12px 16px;
        font-weight: 600;
        color: #fff;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        min-height: 52px;
        text-align: center;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
        box-sizing: border-box;
      }

      .action-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        font-size: 1.15rem;
      }

      .action-label {
        flex: 1;
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 14px 32px rgba(15, 23, 42, 0.16);
      }

      .download-btn {
        background: linear-gradient(135deg, #16a34a, #15803d);
      }

      .edit-btn {
        background: linear-gradient(135deg, #f59e0b, #d97706);
      }

      .delete-btn {
        background: linear-gradient(135deg, #dc2626, #991b1b);
      }

      .empty-state {
        display: grid;
        place-items: center;
        border-radius: clamp(18px, 3vw, 24px);
        border: 2px dashed rgba(148, 163, 184, 0.4);
        padding: clamp(36px, 6vw, 64px);
        text-align: center;
        color: #475569;
        background: rgba(248, 250, 252, 0.75);
      }

      .notification {
        position: fixed;
        top: clamp(16px, 4vw, 32px);
        right: clamp(16px, 4vw, 32px);
        background: #fff;
        border-radius: 18px;
        padding: 18px 22px;
        box-shadow: 0 24px 48px rgba(15, 23, 42, 0.2);
        border-left: 5px solid #22c55e;
        display: flex;
        gap: 12px;
        align-items: center;
        transform: translate3d(140%, 0, 0);
        opacity: 0;
        pointer-events: none;
        transition: transform 0.3s ease;
        z-index: 1200;
      }

      .notification.show {
        transform: translate3d(0, 0, 0);
        opacity: 1;
        pointer-events: auto;
      }

      .notification.error {
        border-left-color: #ef4444;
      }

      .notification-message {
        font-weight: 600;
        color: #1f2937;
      }

      .return-home-btn {
        position: fixed;
        left: clamp(16px, 5vw, 32px);
        bottom: clamp(16px, 5vw, 32px);
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 12px 20px;
        border-radius: 999px;
        background: linear-gradient(135deg, #6366f1, #7c3aed);
        color: #fff;
        font-weight: 600;
        text-decoration: none;
        box-shadow: 0 18px 38px rgba(99, 102, 241, 0.35);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .return-home-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 22px 44px rgba(99, 102, 241, 0.4);
      }

      .hidden {
        display: none !important;
      }

      @media (max-width: 640px) {
        .materials-shell {
          border-radius: 0;
        }

        .materials-hero {
          padding: 48px 24px;
        }

        .materials-content {
          padding: 28px 20px 48px;
        }

        .material-actions {
          grid-template-columns: 1fr;
        }

        .action-btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <section class="materials-shell">
        <header class="materials-hero">
          <h1>📚 Materiales del curso</h1>
          <p>
            Accede a presentaciones, plantillas y recursos clave para la materia de
            Calidad de Software. Si eres docente puedes gestionar los materiales
            directamente desde esta vista.
          </p>
        </header>
        <div class="materials-content">
          <section id="teacherView" class="teacher-panel teacher-only hidden" aria-live="polite">
            <div>
              <h3>Administrar materiales</h3>
              <p class="text-slate-600">
                Sube nuevos recursos o actualiza los existentes para mantener al día la
                biblioteca del curso.
              </p>
            </div>
            <form id="materialForm" class="form-grid">
              <div class="form-group">
                <label class="form-label" for="file-widget">Archivo</label>
                <input
                  type="hidden"
                  role="uploadcare-uploader"
                  name="content"
                  id="file-widget"
                />
              </div>
              <div class="form-group">
                <label class="form-label" for="materialTitle">Título</label>
                <input type="text" class="form-input" id="materialTitle" required />
              </div>
              <div class="form-group">
                <label class="form-label" for="materialCategory">Categoría</label>
                <select class="form-select" id="materialCategory" required>
                  <option value="presentations">Presentaciones</option>
                  <option value="templates">Plantillas</option>
                  <option value="exercises">Ejercicios</option>
                  <option value="references">Referencias</option>
                  <option value="otros">Otros</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label" for="materialDescription">Descripción</label>
                <textarea class="form-textarea" id="materialDescription"></textarea>
              </div>
              <button type="submit" class="submit-btn">Guardar material</button>
            </form>
          </section>

          <div class="materials-grid" id="materialsGrid" aria-live="polite"></div>
          <div class="empty-state" id="emptyState">
            <p id="emptyMessage">Verificando usuario...</p>
          </div>
        </div>
      </section>
    </main>

    <div class="notification" id="notification" role="status" aria-live="assertive">
      <span class="notification-message" id="notificationMessage"></span>
    </div>

    <a href="index.html" class="return-home-btn">⟵ Inicio</a>

    <script type="module">
      import {
        onAuth,
        isTeacherEmail,
        ensureTeacherAllowlistLoaded,
      } from "./js/firebase.js";
      import {
        getMaterials,
        saveMaterial,
        deleteMaterial,
        updateMaterial,
        incrementDownloads,
      } from "./js/materials-manager.js";

      let allMaterials = [];
      let currentUser = null;
      let isCurrentUserTeacher = false;
      let uploadcareWidget = null;
      let notificationTimer = null;

      const elements = {
        grid: document.getElementById("materialsGrid"),
        form: document.getElementById("materialForm"),
        teacherView: document.getElementById("teacherView"),
        notification: document.getElementById("notification"),
        notificationMessage: document.getElementById("notificationMessage"),
        emptyState: document.getElementById("emptyState"),
        emptyMessage: document.getElementById("emptyMessage"),
      };

      const essentialKeys = [
        "grid",
        "emptyState",
        "emptyMessage",
        "notification",
        "notificationMessage",
      ];

      const missingKeys = essentialKeys.filter((key) => !elements[key]);
      if (missingKeys.length) {
        console.error("materiales.html: faltan elementos esenciales", missingKeys);
      }

      onAuth(async (user) => {
        if (!user) {
          window.location.href = "index.html";
          return;
        }

        currentUser = user;

        try {
          await ensureTeacherAllowlistLoaded();
        } catch (error) {
          console.warn("No se pudo sincronizar la lista de docentes", error);
        }

        isCurrentUserTeacher = Boolean(user.email && isTeacherEmail(user.email));
        await initializeApp();
      });

      async function initializeApp() {
        if (missingKeys.length) {
          return;
        }

        if (elements.form) {
          elements.form.removeEventListener("submit", handleFormSubmit);
        }

        if (isCurrentUserTeacher && elements.form) {
          if (typeof uploadcare !== "undefined" && uploadcare?.Widget) {
            uploadcareWidget = uploadcare.Widget("#file-widget");
            elements.form.addEventListener("submit", handleFormSubmit);
          } else {
            showNotification(
              "error",
              "No se pudo cargar el cargador de archivos. Intenta recargar la página."
            );
          }
        }

        if (elements.grid) {
          elements.grid.removeEventListener("click", handleGridClick);
          elements.grid.addEventListener("click", handleGridClick);
        }

        setEmptyState("Cargando materiales...", true);
        try {
          allMaterials = await getMaterials();
          renderMaterials();
        } catch (error) {
          console.error("Error al cargar materiales", error);
          setEmptyState("No se pudieron cargar los materiales. Intenta más tarde.");
          showNotification("error", "No se pudieron cargar los materiales.");
        }

        applyRoleVisibility();
      }

      function renderMaterials() {
        if (!elements.grid || !elements.emptyState || !elements.emptyMessage) {
          return;
        }

        elements.grid.innerHTML = "";

        if (!Array.isArray(allMaterials) || allMaterials.length === 0) {
          setEmptyState("Aún no hay materiales disponibles.");
          return;
        }

        elements.emptyState.classList.add("hidden");
        allMaterials.forEach((material) => {
          elements.grid.insertAdjacentHTML(
            "beforeend",
            createMaterialCard(material)
          );
        });
        applyRoleVisibility();
      }

      function createMaterialCard(material) {
        const fileInfo = getFileInfo(material);
        const timestamp = material?.createdAt;
        const dateString =
          typeof timestamp?.toDate === "function"
            ? timestamp.toDate().toLocaleDateString("es-MX")
            : new Date().toLocaleDateString("es-MX");
        const url = material?.url || material?.downloadUrl || "";

        return `
          <article class="material-card">
            <div class="material-header">
              <span class="file-icon ${fileInfo.className}">${fileInfo.label}</span>
              <div>
                <h4 class="material-title">${escapeHtml(
                  material?.title || "Material sin título"
                )}</h4>
                <p class="material-meta">${dateString} · ${
          material?.downloads || 0
        } descargas</p>
              </div>
            </div>
            <p class="material-description">${escapeHtml(
              material?.description || "Sin descripción"
            )}</p>
            <div class="material-actions">
              <button class="action-btn download-btn" data-action="download" data-id="${
                material?.id || ""
              }" data-url="${url}">
                <span class="action-icon" aria-hidden="true">⬇️</span>
                <span class="action-label">Descargar</span>
              </button>
              <button class="action-btn edit-btn teacher-only" data-action="edit" data-id="${
                material?.id || ""
              }">
                <span class="action-icon" aria-hidden="true">✏️</span>
                <span class="action-label">Editar</span>
              </button>
              <button class="action-btn delete-btn teacher-only" data-action="delete" data-id="${
                material?.id || ""
              }">
                <span class="action-icon" aria-hidden="true">🗑️</span>
                <span class="action-label">Eliminar</span>
              </button>
            </div>
          </article>
        `;
      }

      async function handleFormSubmit(event) {
        event.preventDefault();
        if (!uploadcareWidget) {
          showNotification(
            "error",
            "El cargador de archivos no está listo. Refresca la página."
          );
          return;
        }

        const title = elements.form
          ? elements.form.querySelector("#materialTitle").value.trim()
          : "";
        if (!title) {
          showNotification("error", "El título es obligatorio.");
          return;
        }

        const widgetValue = uploadcareWidget.value();
        if (!widgetValue) {
          showNotification("error", "Debes seleccionar un archivo.");
          return;
        }

        showNotification("info", "Subiendo archivo...");
        widgetValue.done(async (file) => {
          const newMaterial = {
            title,
            category: elements.form
              ? elements.form.querySelector("#materialCategory").value
              : "otros",
            description: elements.form
              ? elements.form.querySelector("#materialDescription").value.trim()
              : "",
            url: file?.cdnUrl || "",
            fileName: file?.name || title,
            extension: (file?.name || "").split(".").pop()?.toLowerCase() || "",
            downloads: 0,
          };

          try {
            const savedMaterial = await saveMaterial(newMaterial);
            allMaterials = [savedMaterial, ...allMaterials];
            renderMaterials();
            elements.form.reset();
            uploadcareWidget.value(null);
            showNotification("success", "Material guardado correctamente.");
          } catch (error) {
            console.error("No se pudo guardar el material", error);
            showNotification("error", "No se pudo guardar el material.");
          }
        });
      }

      async function handleGridClick(event) {
        const button = event.target.closest(".action-btn");
        if (!button) return;

        const materialId = button.dataset.id;
        const action = button.dataset.action;

        if (!materialId || !action) return;

        if (action === "download") {
          const url = button.dataset.url;
          if (!url) {
            showNotification(
              "error",
              "El material no tiene un enlace de descarga disponible."
            );
            return;
          }
          window.open(url, "_blank");
          try {
            await incrementDownloads(materialId);
            const material = allMaterials.find((item) => item.id === materialId);
            if (material) {
              material.downloads = (material.downloads || 0) + 1;
              renderMaterials();
            }
          } catch (error) {
            console.warn("No se pudo actualizar el contador de descargas", error);
          }
        } else if (action === "delete") {
          if (!confirm("¿Seguro que quieres eliminar este material?")) {
            return;
          }
          try {
            await deleteMaterial(materialId);
            allMaterials = allMaterials.filter((item) => item.id !== materialId);
            renderMaterials();
            showNotification("success", "Material eliminado correctamente.");
          } catch (error) {
            console.error("No se pudo eliminar el material", error);
            showNotification("error", "No se pudo eliminar el material.");
          }
        } else if (action === "edit") {
          const material = allMaterials.find((item) => item.id === materialId);
          if (!material) return;

          const newTitle = prompt("Nuevo título", material.title || "");
          if (newTitle === null) return;
          const newDescription = prompt(
            "Nueva descripción",
            material.description || ""
          );
          if (newDescription === null) return;

          try {
            await updateMaterial(materialId, newTitle.trim(), newDescription.trim());
            material.title = newTitle.trim();
            material.description = newDescription.trim();
            renderMaterials();
            showNotification("success", "Material actualizado correctamente.");
          } catch (error) {
            console.error("No se pudo actualizar el material", error);
            showNotification("error", "No se pudo actualizar el material.");
          }
        }
      }

      function applyRoleVisibility() {
        const showTeacherContent = isCurrentUserTeacher;

        if (elements.teacherView) {
          elements.teacherView.classList.toggle("hidden", !showTeacherContent);
        }

        document.querySelectorAll(".teacher-only").forEach((node) => {
          if (showTeacherContent) {
            node.classList.remove("hidden");
            node.removeAttribute("hidden");
            node.removeAttribute("aria-hidden");
          } else {
            node.classList.add("hidden");
            node.setAttribute("hidden", "hidden");
            node.setAttribute("aria-hidden", "true");
          }
        });
      }

      function getFileInfo(material) {
        const ext = (material?.extension || "").toLowerCase();
        const map = {
          pdf: "pdf",
          doc: "doc",
          docx: "doc",
          xls: "xls",
          xlsx: "xls",
          ppt: "ppt",
          pptx: "ppt",
        };
        const className = map[ext] || "default";
        const label = ext ? ext.toUpperCase() : "FILE";
        return { className, label };
      }

      function escapeHtml(value) {
        const div = document.createElement("div");
        div.textContent = value ?? "";
        return div.innerHTML;
      }

      function setEmptyState(message, isLoading = false) {
        if (!elements.emptyState || !elements.emptyMessage) return;
        elements.emptyState.classList.toggle("hidden", false);
        elements.emptyMessage.textContent = message;
        elements.emptyState.setAttribute(
          "aria-busy",
          isLoading ? "true" : "false"
        );
      }

      function showNotification(type, message) {
        if (!elements.notification || !elements.notificationMessage) return;

        elements.notificationMessage.textContent = message;
        elements.notification.classList.remove("error");
        if (type === "error") {
          elements.notification.classList.add("error");
        }
        elements.notification.classList.add("show");

        if (notificationTimer) {
          clearTimeout(notificationTimer);
        }
        notificationTimer = window.setTimeout(() => {
          elements.notification.classList.remove("show");
        }, 3200);
      }
    </script>
    <script defer src="js/nav-inject.js"></script>
  </body>
</html>

    </script>
      <script defer src="js/nav-inject.js"></script>
</body>
</html>
