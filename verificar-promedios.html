<!DOCTYPE html>
<html lang="es">
  <head>
    <script type="module">
      import { getDb } from './js/firebase.js';
      import {
        collection,
        getDocs,
        updateDoc,
        doc,
      } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';
      import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';

      const statusDiv = document.createElement('div');
      statusDiv.id = 'auth-status';
      statusDiv.style.margin = '1em 0';
      document.body.insertBefore(statusDiv, document.body.children[1]);

      function setStatus(msg, ok = false) {
        statusDiv.textContent = msg;
        statusDiv.style.color = ok ? 'green' : 'red';
      }

      function calcularPromedio(obj) {
        if (!obj || typeof obj !== 'object') return 0;
        const vals = Object.values(obj).filter((v) => typeof v === 'number');
        if (vals.length === 0) return 0;
        return vals.reduce((a, b) => a + b, 0) / vals.length;
      }

      async function verificarYCorregirPromediosCompleto() {
        const user = getAuth().currentUser;
        if (!user) {
          setStatus('Debes iniciar sesión como docente para ejecutar el script.');
          alert('Inicia sesión como docente antes de continuar.');
          return;
        }
        // Verifica claim de rol docente si está disponible
        let isTeacher = false;
        if (user && user.getIdTokenResult) {
          try {
            const token = await user.getIdTokenResult();
            isTeacher = token.claims && token.claims.role === 'docente';
          } catch {}
        }
        if (!isTeacher) {
          setStatus('Tu usuario no tiene permisos de docente. Acceso denegado.');
          alert('Solo los docentes pueden ejecutar este script.');
          return;
        }
        setStatus('Usuario autenticado como docente. Ejecutando...', true);
        const db = getDb();
        const gradesCol = collection(db, 'grades');
        const snap = await getDocs(gradesCol);
        let actualizados = 0;

        for (const docSnap of snap.docs) {
          const data = docSnap.data();
          let update = {};
          // unit1
          if (!('unit1' in data) || typeof data.unit1 !== 'object' || Object.keys(data.unit1).length === 0) {
            update.unit1 = { average: 0 };
          } else if (!('average' in data.unit1)) {
            update.unit1 = { ...data.unit1, average: calcularPromedio(data.unit1) };
          }
          // unit2
          if (!('unit2' in data) || typeof data.unit2 !== 'object' || Object.keys(data.unit2).length === 0) {
            update.unit2 = { average: 0 };
          } else if (!('average' in data.unit2)) {
            update.unit2 = { ...data.unit2, average: calcularPromedio(data.unit2) };
          }
          // unit3
          if (!('unit3' in data) || typeof data.unit3 !== 'object' || Object.keys(data.unit3).length === 0) {
            update.unit3 = { average: 0 };
          } else if (!('average' in data.unit3)) {
            update.unit3 = { ...data.unit3, average: calcularPromedio(data.unit3) };
          }
          // projectFinal
          if (!('projectFinal' in data) || typeof data.projectFinal !== 'number') {
            update.projectFinal = 0;
          }
          if (Object.keys(update).length > 0) {
            await updateDoc(doc(getDb(), 'grades', docSnap.id), update);
            actualizados++;
            console.log(`Actualizado ${docSnap.id}:`, update);
          }
        }
        setStatus(`Verificación/corrección terminada. Documentos actualizados: ${actualizados}`, true);
        alert(`Verificación/corrección terminada. Documentos actualizados: ${actualizados}`);
      }

      window.verificarYCorregirPromediosCompleto = verificarYCorregirPromediosCompleto;

      // Mostrar estado de autenticación al cargar
      setStatus('Verificando sesión...');
      onAuthStateChanged(getAuth(), (user) => {
        if (!user) {
          setStatus('No has iniciado sesión. Inicia sesión como docente para continuar.');
        } else {
          user.getIdTokenResult().then(token => {
            if (token.claims && token.claims.role === 'docente') {
              setStatus('Autenticado como docente. Puedes ejecutar el script.', true);
            } else {
              setStatus('Autenticado, pero no tienes permisos de docente.', false);
            }
          }).catch(() => {
            setStatus('Error al verificar el rol.');
          });
        }
      });
    </script>
          ) {
            update.unit3 = { average: 0 };
          } else if (!("average" in data.unit3)) {
            update.unit3 = {
              ...data.unit3,
              average: calcularPromedio(data.unit3),
            };
          }
          // projectFinal
          if (
            !("projectFinal" in data) ||
            typeof data.projectFinal !== "number"
          ) {
            update.projectFinal = 0;
          }
          if (Object.keys(update).length > 0) {
            await updateDoc(doc(db, "grades", docSnap.id), update);
            actualizados++;
            console.log(`Actualizado ${docSnap.id}:`, update);
          }
        }
        alert(
          `Verificación/corrección terminada. Documentos actualizados: ${actualizados}`
        );
      }

      window.verificarYCorregirPromediosCompleto =
        verificarYCorregirPromediosCompleto;
    </script>
  </head>
  <body>
    <h1>Verificar y Corregir Promedios en Firestore</h1>
    <button onclick="verificarYCorregirPromediosCompleto()">
      Ejecutar verificación/corrección
    </button>
    <p>Abre la consola para ver los detalles de los documentos actualizados.</p>
  </body>
</html>
