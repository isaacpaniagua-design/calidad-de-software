<!doctype html>
<html lang="es" style="height: 100%;">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Herramienta de An√°lisis de Brechas</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        .priority-high { border-left: 4px solid #ef4444; }
        .priority-medium { border-left: 4px solid #f59e0b; }
        .priority-low { border-left: 4px solid #10b981; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body style="height: 100%; margin: 0; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;" class="bg-slate-50">
  <div class="min-h-full flex flex-col"><!-- Header -->
   <header class="bg-white shadow-sm border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
     <div class="flex items-center justify-between">
      <div>
       <h1 id="tool-title" class="text-3xl font-bold text-slate-900">An√°lisis de Brechas (Gap Analysis)</h1>
       <p class="mt-2 text-slate-600"><span id="company-name">Empresa</span> ‚Ä¢ <span id="model-name">Modelo de Calidad</span></p>
       <p id="current-user-info" class="mt-1 text-sm text-blue-600 hidden">üë§ <span id="display-student-name"></span> (<span id="display-user-id"></span>)</p>
      </div>
      <div class="flex items-center space-x-4 no-print">
       <div class="text-sm text-slate-500"><span id="total-items">0</span> elementos analizados
       </div><button id="export-pdf-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors"> üìÑ Exportar PDF </button> <button id="add-gap-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors"> + Agregar Brecha </button>
      </div>
     </div>
    </div>
   </header><!-- Main Content -->
   <main class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><!-- Student Identification -->
    <div id="student-form" class="bg-blue-50 rounded-lg border border-blue-200 p-6 mb-8">
     <h3 class="text-lg font-semibold text-blue-900 mb-4">üë§ Identificaci√≥n del Estudiante</h3>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div><label for="student-name" class="block text-sm font-medium text-blue-700 mb-2"> Nombre del Estudiante * </label> <input type="text" id="student-name" class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ingresa tu nombre completo">
      </div>
      <div><label for="user-id" class="block text-sm font-medium text-blue-700 mb-2"> ID de Usuario * </label> <input type="text" id="user-id" class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ej. EST001, 2024001, etc.">
      </div>
     </div>
     <div class="mt-4"><button type="button" id="save-identity-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors"> Guardar Identidad </button>
      <p class="text-sm text-blue-600 mt-2">Esta informaci√≥n se asociar√° con todos tus an√°lisis de brechas.</p>
     </div>
    </div><!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
     <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-200">
      <div class="flex items-center">
       <div class="p-2 bg-red-100 rounded-lg">
        <div class="w-6 h-6 bg-red-500 rounded"></div>
       </div>
       <div class="ml-4">
        <p class="text-sm font-medium text-slate-600">No Cumplido</p>
        <p id="not-compliant-count" class="text-2xl font-bold text-slate-900">0</p>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-200">
      <div class="flex items-center">
       <div class="p-2 bg-yellow-100 rounded-lg">
        <div class="w-6 h-6 bg-yellow-500 rounded"></div>
       </div>
       <div class="ml-4">
        <p class="text-sm font-medium text-slate-600">Parcialmente</p>
        <p id="partial-count" class="text-2xl font-bold text-slate-900">0</p>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-200">
      <div class="flex items-center">
       <div class="p-2 bg-green-100 rounded-lg">
        <div class="w-6 h-6 bg-green-500 rounded"></div>
       </div>
       <div class="ml-4">
        <p class="text-sm font-medium text-slate-600">Cumplido</p>
        <p id="compliant-count" class="text-2xl font-bold text-slate-900">0</p>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-200">
      <div class="flex items-center">
       <div class="p-2 bg-orange-100 rounded-lg">
        <div class="w-6 h-6 bg-orange-500 rounded"></div>
       </div>
       <div class="ml-4">
        <p class="text-sm font-medium text-slate-600">Alta Prioridad</p>
        <p id="high-priority-count" class="text-2xl font-bold text-slate-900">0</p>
       </div>
      </div>
     </div>
    </div><!-- Gap Analysis Form -->
    <div id="gap-form" class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-8 hidden no-print">
     <h3 class="text-lg font-semibold text-slate-900 mb-4">Nuevo An√°lisis de Brecha</h3>
     <form id="gap-analysis-form" class="space-y-4">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
       <div><label for="practice-requirement" class="block text-sm font-medium text-slate-700 mb-2"> Pr√°ctica/Requisito del Modelo * </label> <textarea id="practice-requirement" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ej. CMMI REQM 1.1: Gestionar los requisitos del proyecto"></textarea>
       </div>
       <div><label for="current-evidence" class="block text-sm font-medium text-slate-700 mb-2"> Evidencia/Pr√°ctica Actual * </label> <textarea id="current-evidence" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ej. Los cambios de requisitos se piden por WhatsApp sin documentaci√≥n formal"></textarea>
       </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
       <div><label for="gap-status" class="block text-sm font-medium text-slate-700 mb-2"> Estado de la Brecha * </label> <select id="gap-status" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"> <option value="">Seleccionar estado</option> <option value="No Cumplido">No Cumplido</option> <option value="Parcialmente Cumplido">Parcialmente Cumplido</option> <option value="Cumplido">Cumplido</option> </select>
       </div>
       <div><label for="priority" class="block text-sm font-medium text-slate-700 mb-2"> Prioridad * </label> <select id="priority" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"> <option value="">Seleccionar prioridad</option> <option value="Alta">Alta</option> <option value="Media">Media</option> <option value="Baja">Baja</option> </select>
       </div>
       <div class="flex items-end"><button type="button" id="cancel-btn" class="mr-3 px-4 py-2 text-slate-600 hover:text-slate-800 font-medium"> Cancelar </button> <button type="submit" id="save-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors"> Guardar </button>
       </div>
      </div>
      <div><label for="recommended-actions" class="block text-sm font-medium text-slate-700 mb-2"> Acciones Recomendadas * </label> <textarea id="recommended-actions" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ej. Dise√±ar e implementar un Formulario de Control de Cambios formal con flujo de aprobaci√≥n"></textarea>
      </div>
     </form>
    </div><!-- Gap Analysis Table -->
    <div class="bg-white rounded-lg shadow-sm border border-slate-200">
     <div class="px-6 py-4 border-b border-slate-200">
      <h3 class="text-lg font-semibold text-slate-900">An√°lisis de Brechas Detallado</h3>
     </div>
     <div id="gaps-container" class="divide-y divide-slate-200">
      <div id="empty-state" class="p-12 text-center">
       <div class="w-16 h-16 mx-auto mb-4 bg-slate-100 rounded-full flex items-center justify-center">
        <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
       </div>
       <h3 class="text-lg font-medium text-slate-900 mb-2">No hay an√°lisis de brechas</h3>
       <p class="text-slate-500 mb-4">Primero identif√≠cate como estudiante, luego comienza agregando tu primer an√°lisis de brecha.</p><button id="empty-add-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors"> Agregar Primera Brecha </button>
      </div>
     </div>
    </div>
   </main>
  </div><!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
   <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div><span class="text-slate-700">Procesando...</span>
   </div>
  </div>
  <script>
        // Configuration
        const defaultConfig = {
            tool_title: "An√°lisis de Brechas (Gap Analysis)",
            company_name: "Empresa",
            model_name: "Modelo de Calidad"
        };

        let currentGaps = [];
        let allGaps = [];
        let isLoading = false;
        let editingGap = null;
        let currentUser = {
            student_name: '',
            user_id: ''
        };

        // Data handler for SDK
        const dataHandler = {
            onDataChanged(data) {
                allGaps = data || [];
                filterGapsByUser();
                renderGapsList();
                updateSummaryCards();
                updateTotalCount();
            }
        };

        // Initialize SDKs
        async function initializeApp() {
            try {
                if (window.dataSdk) {
                    const result = await window.dataSdk.init(dataHandler);
                    if (!result.isOk) {
                        console.error("Failed to initialize data SDK");
                    }
                }

                if (window.elementSdk) {
                    await window.elementSdk.init({
                        defaultConfig,
                        onConfigChange: async (config) => {
                            document.getElementById('tool-title').textContent = config.tool_title || defaultConfig.tool_title;
                            document.getElementById('company-name').textContent = config.company_name || defaultConfig.company_name;
                            document.getElementById('model-name').textContent = config.model_name || defaultConfig.model_name;
                        },
                        mapToCapabilities: (config) => ({
                            recolorables: [
                                {
                                    get: () => config.primary_color || "#3b82f6",
                                    set: (value) => {
                                        window.elementSdk.setConfig({ primary_color: value });
                                        updateColors(value);
                                    }
                                }
                            ],
                            borderables: [],
                            fontEditable: undefined,
                            fontSizeable: undefined
                        }),
                        mapToEditPanelValues: (config) => new Map([
                            ["tool_title", config.tool_title || defaultConfig.tool_title],
                            ["company_name", config.company_name || defaultConfig.company_name],
                            ["model_name", config.model_name || defaultConfig.model_name]
                        ])
                    });
                }

                // Load saved user identity
                loadUserIdentity();
            } catch (error) {
                console.error("Initialization error:", error);
            }
        }

        function updateColors(primaryColor) {
            const elements = document.querySelectorAll('.bg-blue-600, .hover\\:bg-blue-700, .focus\\:ring-blue-500, .focus\\:border-blue-500');
            elements.forEach(el => {
                el.style.backgroundColor = primaryColor;
            });
        }

        // User Identity Management
        function loadUserIdentity() {
            const saved = localStorage.getItem('gap_analysis_user');
            if (saved) {
                currentUser = JSON.parse(saved);
                document.getElementById('student-name').value = currentUser.student_name;
                document.getElementById('user-id').value = currentUser.user_id;
                showUserInfo();
                filterGapsByUser();
            }
        }

        function saveUserIdentity() {
            const studentName = document.getElementById('student-name').value.trim();
            const userId = document.getElementById('user-id').value.trim();

            if (!studentName || !userId) {
                showInlineMessage("Por favor completa tu nombre y ID de usuario", "error");
                return;
            }

            currentUser = {
                student_name: studentName,
                user_id: userId
            };

            localStorage.setItem('gap_analysis_user', JSON.stringify(currentUser));
            showUserInfo();
            filterGapsByUser();
            showInlineMessage("Identidad guardada correctamente", "success");
        }

        function showUserInfo() {
            document.getElementById('display-student-name').textContent = currentUser.student_name;
            document.getElementById('display-user-id').textContent = currentUser.user_id;
            document.getElementById('current-user-info').classList.remove('hidden');
        }

        function filterGapsByUser() {
            if (!currentUser.user_id) {
                currentGaps = [];
                return;
            }
            currentGaps = allGaps.filter(gap => gap.user_id === currentUser.user_id);
        }

        // Event listeners
        document.getElementById('save-identity-btn').addEventListener('click', saveUserIdentity);
        document.getElementById('add-gap-btn').addEventListener('click', showGapForm);
        document.getElementById('empty-add-btn').addEventListener('click', showGapForm);
        document.getElementById('cancel-btn').addEventListener('click', hideGapForm);
        document.getElementById('gap-analysis-form').addEventListener('submit', handleFormSubmit);
        document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);

        function showGapForm() {
            if (!currentUser.user_id) {
                showInlineMessage("Primero debes identificarte como estudiante", "error");
                document.getElementById('student-name').focus();
                return;
            }

            document.getElementById('gap-form').classList.remove('hidden');
            document.getElementById('gap-form').classList.add('fade-in');
            document.getElementById('practice-requirement').focus();
            editingGap = null;
            clearForm();
        }

        function hideGapForm() {
            document.getElementById('gap-form').classList.add('hidden');
            editingGap = null;
            clearForm();
        }

        function clearForm() {
            document.getElementById('gap-analysis-form').reset();
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (isLoading) return;

            if (!currentUser.user_id) {
                showInlineMessage("Primero debes identificarte como estudiante", "error");
                return;
            }

            const formData = {
                practice_requirement: document.getElementById('practice-requirement').value.trim(),
                current_evidence: document.getElementById('current-evidence').value.trim(),
                gap_status: document.getElementById('gap-status').value,
                priority: document.getElementById('priority').value,
                recommended_actions: document.getElementById('recommended-actions').value.trim()
            };

            // Validation
            if (!formData.practice_requirement || !formData.current_evidence || 
                !formData.gap_status || !formData.priority || !formData.recommended_actions) {
                showInlineMessage("Por favor completa todos los campos requeridos", "error");
                return;
            }

            if (allGaps.length >= 999) {
                showInlineMessage("Se ha alcanzado el l√≠mite m√°ximo de 999 elementos. Por favor elimina algunos elementos primero.", "error");
                return;
            }

            setLoading(true);

            try {
                const gapData = {
                    id: editingGap ? editingGap.id : generateId(),
                    user_id: currentUser.user_id,
                    student_name: currentUser.student_name,
                    ...formData,
                    created_at: new Date().toISOString()
                };

                let result;
                if (editingGap) {
                    result = await window.dataSdk.update({ ...gapData, __backendId: editingGap.__backendId });
                } else {
                    result = await window.dataSdk.create(gapData);
                }

                if (result.isOk) {
                    hideGapForm();
                    showInlineMessage(editingGap ? "Brecha actualizada exitosamente" : "Brecha agregada exitosamente", "success");
                } else {
                    showInlineMessage("Error al guardar la brecha. Por favor intenta nuevamente.", "error");
                }
            } catch (error) {
                showInlineMessage("Error al guardar la brecha. Por favor intenta nuevamente.", "error");
            } finally {
                setLoading(false);
            }
        }

        function editGap(gap) {
            editingGap = gap;
            document.getElementById('practice-requirement').value = gap.practice_requirement;
            document.getElementById('current-evidence').value = gap.current_evidence;
            document.getElementById('gap-status').value = gap.gap_status;
            document.getElementById('priority').value = gap.priority;
            document.getElementById('recommended-actions').value = gap.recommended_actions;
            
            showGapForm();
            document.getElementById('gap-form').scrollIntoView({ behavior: 'smooth' });
        }

        async function deleteGap(gap) {
            if (isLoading) return;

            // Create inline confirmation
            const gapElement = document.querySelector(`[data-gap-id="${gap.id}"]`);
            const deleteBtn = gapElement.querySelector('.delete-btn');
            const originalText = deleteBtn.innerHTML;
            
            deleteBtn.innerHTML = '¬øConfirmar?';
            deleteBtn.classList.add('bg-red-600', 'hover:bg-red-700', 'text-white', 'px-2', 'py-1', 'rounded');
            
            // Add cancel option
            const cancelBtn = document.createElement('button');
            cancelBtn.innerHTML = 'Cancelar';
            cancelBtn.className = 'ml-2 px-3 py-1 text-sm text-slate-600 hover:text-slate-800';
            cancelBtn.onclick = () => {
                deleteBtn.innerHTML = originalText;
                deleteBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'text-white', 'px-2', 'py-1', 'rounded');
                cancelBtn.remove();
            };
            deleteBtn.parentNode.insertBefore(cancelBtn, deleteBtn.nextSibling);
            
            deleteBtn.onclick = async () => {
                setLoading(true);
                try {
                    const result = await window.dataSdk.delete(gap);
                    if (result.isOk) {
                        showInlineMessage("Brecha eliminada exitosamente", "success");
                    } else {
                        showInlineMessage("Error al eliminar la brecha", "error");
                    }
                } catch (error) {
                    showInlineMessage("Error al eliminar la brecha", "error");
                } finally {
                    setLoading(false);
                }
            };
        }

        // PDF Export Function
        async function exportToPDF() {
            if (!currentUser.user_id) {
                showInlineMessage("Primero debes identificarte como estudiante", "error");
                return;
            }

            if (currentGaps.length === 0) {
                showInlineMessage("No hay an√°lisis de brechas para exportar", "error");
                return;
            }

            setLoading(true);

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(20);
                doc.text('An√°lisis de Brechas (Gap Analysis)', 20, 30);
                
                doc.setFontSize(12);
                doc.text(`Estudiante: ${currentUser.student_name}`, 20, 45);
                doc.text(`ID: ${currentUser.user_id}`, 20, 55);
                doc.text(`Empresa: ${document.getElementById('company-name').textContent}`, 20, 65);
                doc.text(`Modelo: ${document.getElementById('model-name').textContent}`, 20, 75);
                doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, 20, 85);
                
                // Summary
                doc.setFontSize(14);
                doc.text('Resumen:', 20, 105);
                doc.setFontSize(10);
                doc.text(`Total de elementos: ${currentGaps.length}`, 20, 115);
                doc.text(`No Cumplido: ${currentGaps.filter(g => g.gap_status === 'No Cumplido').length}`, 20, 125);
                doc.text(`Parcialmente Cumplido: ${currentGaps.filter(g => g.gap_status === 'Parcialmente Cumplido').length}`, 20, 135);
                doc.text(`Cumplido: ${currentGaps.filter(g => g.gap_status === 'Cumplido').length}`, 20, 145);
                doc.text(`Alta Prioridad: ${currentGaps.filter(g => g.priority === 'Alta').length}`, 20, 155);
                
                let yPosition = 175;
                
                // Gaps details
                currentGaps.forEach((gap, index) => {
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 30;
                    }
                    
                    doc.setFontSize(12);
                    doc.text(`${index + 1}. ${gap.practice_requirement}`, 20, yPosition);
                    yPosition += 10;
                    
                    doc.setFontSize(10);
                    doc.text(`Estado: ${gap.gap_status} | Prioridad: ${gap.priority}`, 20, yPosition);
                    yPosition += 8;
                    
                    const evidenceLines = doc.splitTextToSize(`Evidencia: ${gap.current_evidence}`, 170);
                    doc.text(evidenceLines, 20, yPosition);
                    yPosition += evidenceLines.length * 5 + 3;
                    
                    const actionsLines = doc.splitTextToSize(`Acciones: ${gap.recommended_actions}`, 170);
                    doc.text(actionsLines, 20, yPosition);
                    yPosition += actionsLines.length * 5 + 10;
                });
                
                // Generate PDF as blob and open in new tab
                const pdfBlob = doc.output('blob');
                const fileName = `Gap_Analysis_${currentUser.user_id}_${new Date().toISOString().split('T')[0]}.pdf`;
                
                // Create object URL and open in new tab
                const url = URL.createObjectURL(pdfBlob);
                const link = document.createElement('a');
                link.href = url;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.download = fileName;
                
                // Trigger download by opening in new tab
                window.open(url, '_blank', 'noopener,noreferrer');
                
                // Clean up object URL after a delay
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 1000);
                
                showInlineMessage("PDF generado y abierto en nueva pesta√±a", "success");
            } catch (error) {
                showInlineMessage("Error al generar PDF", "error");
                console.error("PDF export error:", error);
            } finally {
                setLoading(false);
            }
        }

        function renderGapsList() {
            const container = document.getElementById('gaps-container');
            const emptyState = document.getElementById('empty-state');
            
            if (currentGaps.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            // Clear existing gaps (except empty state)
            const existingGaps = container.querySelectorAll('.gap-item');
            existingGaps.forEach(item => item.remove());
            
            currentGaps.forEach(gap => {
                const gapElement = createGapElement(gap);
                container.appendChild(gapElement);
            });
        }

        function createGapElement(gap) {
            const div = document.createElement('div');
            div.className = `gap-item p-6 hover:bg-slate-50 transition-colors priority-${gap.priority.toLowerCase()}`;
            div.setAttribute('data-gap-id', gap.id);
            
            const statusColor = getStatusColor(gap.gap_status);
            const priorityColor = getPriorityColor(gap.priority);
            
            div.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-3">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                                ${gap.gap_status}
                            </span>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${priorityColor}">
                                Prioridad ${gap.priority}
                            </span>
                        </div>
                        <h4 class="text-lg font-semibold text-slate-900 mb-2">${escapeHtml(gap.practice_requirement)}</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                            <div>
                                <h5 class="text-sm font-medium text-slate-700 mb-1">Pr√°ctica Actual:</h5>
                                <p class="text-sm text-slate-600">${escapeHtml(gap.current_evidence)}</p>
                            </div>
                            <div>
                                <h5 class="text-sm font-medium text-slate-700 mb-1">Acciones Recomendadas:</h5>
                                <p class="text-sm text-slate-600">${escapeHtml(gap.recommended_actions)}</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 ml-4 no-print">
                        <button onclick="editGap(${JSON.stringify(gap).replace(/"/g, '&quot;')})" 
                            class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            Editar
                        </button>
                        <button onclick="deleteGap(${JSON.stringify(gap).replace(/"/g, '&quot;')})" 
                            class="delete-btn text-red-600 hover:text-red-800 text-sm font-medium">
                            Eliminar
                        </button>
                    </div>
                </div>
            `;
            
            return div;
        }

        function getStatusColor(status) {
            switch (status) {
                case 'Cumplido': return 'bg-green-100 text-green-800';
                case 'Parcialmente Cumplido': return 'bg-yellow-100 text-yellow-800';
                case 'No Cumplido': return 'bg-red-100 text-red-800';
                default: return 'bg-slate-100 text-slate-800';
            }
        }

        function getPriorityColor(priority) {
            switch (priority) {
                case 'Alta': return 'bg-red-100 text-red-800';
                case 'Media': return 'bg-yellow-100 text-yellow-800';
                case 'Baja': return 'bg-green-100 text-green-800';
                default: return 'bg-slate-100 text-slate-800';
            }
        }

        function updateSummaryCards() {
            const compliant = currentGaps.filter(g => g.gap_status === 'Cumplido').length;
            const partial = currentGaps.filter(g => g.gap_status === 'Parcialmente Cumplido').length;
            const notCompliant = currentGaps.filter(g => g.gap_status === 'No Cumplido').length;
            const highPriority = currentGaps.filter(g => g.priority === 'Alta').length;
            
            document.getElementById('compliant-count').textContent = compliant;
            document.getElementById('partial-count').textContent = partial;
            document.getElementById('not-compliant-count').textContent = notCompliant;
            document.getElementById('high-priority-count').textContent = highPriority;
        }

        function updateTotalCount() {
            document.getElementById('total-items').textContent = currentGaps.length;
        }

        function setLoading(loading) {
            isLoading = loading;
            const overlay = document.getElementById('loading-overlay');
            const saveBtn = document.getElementById('save-btn');
            
            if (loading) {
                overlay.classList.remove('hidden');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Guardando...';
                }
            } else {
                overlay.classList.add('hidden');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Guardar';
                }
            }
        }

        function showInlineMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 
                'bg-red-100 text-red-800 border border-red-200'
            }`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 4000);
        }

        function generateId() {
            return 'gap_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize app
        initializeApp();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99641095f22569bb',t:'MTc2MTc1NTUwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
